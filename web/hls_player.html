<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HLS Player</title>
    <style>
      html, body { margin: 0; padding: 0; height: 100%; background: #000; }
      #v { width: 100%; height: 100%; background: #000; }
    </style>
    <!-- Pin a stable hls.js version to avoid unexpected regressions -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>
  </head>
  <body>
    <div id="root" style="position:relative;width:100%;height:100%">
      <video id="v" controls playsinline webkit-playsinline style="width:100%;height:100%;background:#000;"></video>

      <!-- Minimal overlay controls: quality, speed, fullscreen -->
      <div id="overlay" style="position:absolute;top:8px;right:8px;display:flex;gap:8px;align-items:center;z-index:10;font-family:system-ui, -apple-system, Segoe UI, Roboto;">
        <select id="quality" title="Качество" style="padding:6px 8px;border-radius:8px;border:1px solid #fff3;background:rgba(0,0,0,.55);color:#fff">
          <option value="auto">Auto</option>
        </select>
        <select id="speed" title="Скорость" style="padding:6px 8px;border-radius:8px;border:1px solid #fff3;background:rgba(0,0,0,.55);color:#fff">
          <option value="0.5">0.5×</option>
          <option value="0.75">0.75×</option>
          <option value="1" selected>1×</option>
          <option value="1.25">1.25×</option>
          <option value="1.5">1.5×</option>
          <option value="2">2×</option>
        </select>
        <button id="fs" aria-label="Полный экран" style="padding:6px 10px;border-radius:8px;border:1px solid #fff3;background:rgba(0,0,0,.55);color:#fff;cursor:pointer">⛶</button>
      </div>
    </div>
    <script>
      (function() {
        try {
          var params = new URLSearchParams(window.location.search);
          var src = params.get('src');
          var video = document.getElementById('v');
          var qualitySel = document.getElementById('quality');
          var speedSel = document.getElementById('speed');
          var fsBtn = document.getElementById('fs');
          var firstPlayHandled = false;
          if (!src) {
            document.title = 'No src provided';
            return;
          }
          function enterFullscreen() {
            try {
              if (video.requestFullscreen) video.requestFullscreen();
              else if (video.webkitEnterFullscreen) video.webkitEnterFullscreen();
            } catch (e) { /* noop */ }
          }

          // Speed control
          speedSel.addEventListener('change', function() {
            var rate = parseFloat(speedSel.value || '1');
            if (!isFinite(rate) || rate <= 0) rate = 1;
            video.playbackRate = rate;
          });

          // Fullscreen button
          fsBtn.addEventListener('click', function() { enterFullscreen(); });

          if (window.Hls && window.Hls.isSupported()) {
            var hls = new Hls({ enableWorker: true, capLevelToPlayerSize: true });
            hls.loadSource(src);
            hls.attachMedia(video);

            // Populate quality levels once manifest is parsed
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
              try {
                // Clear and add Auto
                qualitySel.innerHTML = '';
                var optAuto = document.createElement('option');
                optAuto.value = 'auto';
                optAuto.textContent = 'Auto';
                qualitySel.appendChild(optAuto);

                hls.levels.forEach(function(lvl, i) {
                  var label = lvl.height ? (lvl.height + 'p') : (Math.round((lvl.bitrate||0)/1000) + 'kbps');
                  var opt = document.createElement('option');
                  opt.value = String(i);
                  opt.textContent = label;
                  qualitySel.appendChild(opt);
                });

                // Handle quality change
                qualitySel.addEventListener('change', function() {
                  var v = qualitySel.value;
                  if (v === 'auto') {
                    hls.currentLevel = -1; // auto
                  } else {
                    var idx = parseInt(v, 10);
                    if (isFinite(idx)) hls.currentLevel = idx;
                  }
                });
              } catch(e) {}
            });

            // Enter fullscreen on first play
            video.addEventListener('play', function() {
              if (!firstPlayHandled) { firstPlayHandled = true; enterFullscreen(); }
            }, { once: false });

            // Simple error handling
            hls.on(Hls.Events.ERROR, function(event, data) {
              if (data && data.fatal) {
                // Try to recover for common fatal errors
                try {
                  if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                    hls.startLoad();
                  } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
                    hls.recoverMediaError();
                  } else {
                    hls.destroy();
                  }
                } catch (e) {}
              }
            });
          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = src;
            video.addEventListener('play', function() {
              if (!firstPlayHandled) { firstPlayHandled = true; enterFullscreen(); }
            });
          } else {
            video.src = src;
            video.addEventListener('play', function() {
              if (!firstPlayHandled) { firstPlayHandled = true; enterFullscreen(); }
            });
          }
        } catch (e) {
          console.error(e);
        }
      })();
    </script>
  </body>
  </html>



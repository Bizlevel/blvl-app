# Индексация кейсов BizLevel в RAG-систему

## Описание
Скрипт `index_cases.py` автоматически парсит кейсы из Markdown файлов и загружает их в RAG-систему с эмбеддингами для улучшения качества ответов бота Лео.

## Подготовка

### 1. Установка зависимостей
```bash
cd scripts
pip install -r requirements.txt
```

### 2. Настройка переменных окружения
Убедитесь, что в `.env` файле проекта есть:
```env
OPENAI_API_KEY=your_openai_api_key
SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
OPENAI_EMBEDDING_MODEL=text-embedding-3-small
```

## Запуск индексации

### Из корня проекта:
```bash
python scripts/index_cases.py
```

### Или из папки scripts:
```bash
cd scripts
python index_cases.py
```

## Что делает скрипт

1. **Парсинг кейсов** - извлекает кейсы из `docs/bizlevel-cases-scenarios.md`
2. **Создание метаданных** - определяет уровень, навыки, теги, сферы бизнеса
3. **Разделение на чанки** - делит каждый кейс на семантические блоки:
   - Метаданные
   - Описание ситуации
   - Вопросы/задания
   - Решения
   - Инсайты и выводы
4. **Генерация эмбеддингов** - создает векторные представления через OpenAI API
5. **Сохранение в базу** - загружает в таблицу `documents` в Supabase

## Структура чанков

Каждый чанк содержит:
```json
{
  "id": "case_1_situation_a1b2c3d4",
  "content": "Текст чанка...",
  "embedding": [0.123, 0.456, ...],
  "metadata": {
    "source": "bizlevel_case",
    "case_id": 1,
    "case_title": "Автомойка в тумане",
    "chunk_type": "situation",
    "level_id": 3,
    "skill_name": "Фокус лидера",
    "tags": ["стресс-менеджмент", "приоритизация"],
    "business_areas": ["Услуги"],
    "difficulty": "beginner"
  }
}
```

## Типы чанков

- `metadata` - метаданные кейса
- `situation` - описание проблемной ситуации
- `questions` - вопросы и задания для пользователя
- `solutions` - варианты решений и ответы
- `insights` - ключевые выводы и инсайты

## Автоматическое определение

Скрипт автоматически определяет:
- **Сферы бизнеса** по ключевым словам (Торговля, Услуги, IT, и т.д.)
- **Сложность** по уровню (beginner: 1-3, intermediate: 4-7, advanced: 8-10)
- **Теги** из раздела "Затрагиваемые уроки"

## Интеграция с RAG

После индексации кейсы автоматически доступны в RAG-поиске:
- Бот Лео сможет находить релевантные кейсы по запросам пользователей
- Поиск работает по семантическому сходству
- Фильтрация по уровню, навыкам, сфере бизнеса

## Переиндексация

При изменении кейсов просто перезапустите скрипт:
- Старые индексы кейсов автоматически удаляются
- Загружаются новые версии кейсов
- Сохраняются существующие документы других типов

## Логирование

Скрипт ведет подробные логи процесса:
- Количество найденных кейсов
- Прогресс создания чанков
- Прогресс генерации эмбеддингов
- Результаты сохранения в базу

## Возможные ошибки

- **API key не найден** - проверьте `.env` файл
- **Файл кейсов не найден** - убедитесь, что `docs/bizlevel-cases-scenarios.md` существует
- **Rate limit OpenAI** - скрипт автоматически делает паузы, но при большом объеме может потребоваться увеличить задержки
- **Ошибки Supabase** - проверьте права доступа service role key

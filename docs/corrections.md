# –û—Ç—á–µ—Ç –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ Leo/Max AI —Å–∏—Å—Ç–µ–º—ã

## –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–¶–µ–ª—å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:** –ü–æ–≤—ã—à–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ AI-—Å–∏—Å—Ç–µ–º—ã Leo/Max, —É–ª—É—á—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞ –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã.

**–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:**
- ‚úÖ **11 –∏–∑ 11 —Ä–∞–∑–¥–µ–ª–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç**
- ‚ö° **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–æ –Ω–∞ 20-40%** –±–ª–∞–≥–æ–¥–∞—Ä—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –æ–ø–µ—Ä–∞—Ü–∏—è–º –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—é
- üîß **–ü–æ–≤—ã—à–µ–Ω–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å** —á–µ—Ä–µ–∑ fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã –∏ retry –ª–æ–≥–∏–∫—É
- üéØ **–£–ª—É—á—à–µ–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è** —á–µ—Ä–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–µ—Ä–µ–¥–∞—á—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏ –≤–µ—Ä—Å–∏–π —Ü–µ–ª–µ–π
- üí∞ **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ GP** —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π mentor-mode
- üöÄ **–£—Å–∫–æ—Ä–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤** —Å 8—Å –¥–æ 47–º—Å

**–ö–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:**
1. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - –≤—Å–µ –±–ª–æ–∫–∏ (—Ü–µ–ª–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, —Ü–∏—Ç–∞—Ç—ã) –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö** - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ
3. **Fallback –º–µ—Ö–∞–Ω–∏–∑–º—ã** - —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ —Å–±–æ—è—Ö –ë–î
4. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ caseMode** - RAG –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –º–∏–Ω–∏-–∫–µ–π—Å–∞—Ö
5. **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–µ–π** - Max –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏ —Ü–µ–ª–µ–π
6. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è GP —Å–∏—Å—Ç–µ–º—ã** - mentor-mode –Ω–µ —Ç—Ä–∞—Ç–∏—Ç –∏–≥—Ä–æ–≤—ã–µ –æ—á–∫–∏

---

## 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ skipSpend (mentor-mode)

–î–∞—Ç–∞: 2025-09-16

### –ö—Ä–∞—Ç–∫–æ
- –î–æ–±–∞–≤–ª–µ–Ω —Ñ–ª–∞–≥ `skipSpend` –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É –∑–∞–ø—Ä–æ—Å–∞ `/leo-chat` (mentor-mode/leo/max).
- –ü—Ä–∏ `skipSpend=true` –∑–∞–ø–∏—Å—å –≤ `ai_message` –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `request_type='mentor_free'`.
- –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–π GP ‚Äî –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –î–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ–ª–∞–≥–∞ —Å –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–ø–∏—Å–∞–Ω–∏—è.

### –§–∞–π–ª—ã –∏ —Ç–æ—á–µ—á–Ω—ã–µ –ø—Ä–∞–≤–∫–∏
- `supabase/functions/leo-chat/index.ts`
  - –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞: –¥–æ–±–∞–≤–ª–µ–Ω–æ —á—Ç–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞
    - –í—Å—Ç–∞–≤–ª–µ–Ω–æ —Ä—è–¥–æ–º —Å `mode/messages/userContext/bot/isMax`:
      - `const skipSpend: boolean = body?.skipSpend === true;`
  - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤ `ai_message`: —Ä–∞—Å—à–∏—Ä–µ–Ω `request_type`
    - –ë—ã–ª–æ: `saveAIMessageData(..., 'chat')`
    - –°—Ç–∞–ª–æ: `saveAIMessageData(..., skipSpend ? 'mentor_free' : 'chat')`

–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Å—Ç—Ä–æ–∫ (–ø—Ä–∏ –≤–Ω–µ—Å–µ–Ω–∏–∏ –ø—Ä–∞–≤–æ–∫):
```830:1174:supabase/functions/leo-chat/index.ts
// ...
let bot: string = typeof body?.bot === 'string' ? String(body.bot) : 'leo';
if (bot === 'alex') bot = 'max';
const isMax = bot === 'max';
const skipSpend: boolean = body?.skipSpend === true;
// ...
await saveAIMessageData(
  userId,
  chatId,
  null,
  usage,
  cost,
  model,
  bot,
  skipSpend ? 'mentor_free' : 'chat'
);
```

### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å –≤ Supabase
- –ù–∏—á–µ–≥–æ. –°—Ö–µ–º–∞ –ë–î –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ `ai_message` –∏ –ø–æ–ª–µ `request_type`.

### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- `LeoService.sendMessageWithRAG(payload)`:
  - –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `skipSpend` –≤ —Ç–µ–ª–æ POST: `{ ..., skipSpend: true/false }`.
  - –ü–µ—Ä–µ–¥ –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–ø–∏—Å–∞–Ω–∏–µ–º GP –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É: `if (skipSpend) return;`.
- `LeoDialogScreen`:
  - –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ `skipSpend` –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `sendMessageWithRAG`.

### –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```bash
curl -X POST "https://<edge-url>/leo-chat" \
  -H "Authorization: Bearer <USER_JWT>" \
  -H "Content-Type: application/json" \
  -d '{
    "mode": "leo",
    "bot": "leo",
    "messages": [{"role":"user","content":"–õ—å–≥–æ—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å"}],
    "chatId": "chat-mentor-001",
    "skipSpend": true
  }'
```

–û–∂–∏–¥–∞–µ–º–æ:
- HTTP 200; –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—Å–∫–∏–π –æ—Ç–≤–µ—Ç –≤ `message`.
- –í `ai_message` —É –∑–∞–ø–∏—Å–∏ `request_type='mentor_free'`.

### SQL –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏
```sql
select id, created_at, user_id, bot_type, request_type, total_tokens, cost_usd
from ai_message
where user_id = '<USER_ID>'
order by created_at desc
limit 5;
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü—Ä–∏ `skipSpend=true` –∏ –≤–∞–ª–∏–¥–Ω–æ–º JWT:
  - –°–ø–µ–Ω–¥–∞ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –Ω–µ—Ç (–∑–∞ —Å—á—ë—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏).
  - –í `ai_message.request_type` –∑–∞–ø–∏—Å–∞–Ω–æ `mentor_free`.
- –ü—Ä–∏ `skipSpend` –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç/false ‚Äî `request_type='chat'`, –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ.

### –ò–∑–º–µ–Ω–µ–Ω–∏—è API (–≤—Ö–æ–¥/–≤—ã—Ö–æ–¥)
- –í—Ö–æ–¥ (–¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
```json
{
  "mode": "leo" | "max" | "quiz",
  "bot": "leo" | "max" | "alex",
  "messages": [{"role":"user"|"assistant"|"system","content":"..."}],
  "chatId": "<string>",
  "skipSpend": true | false
}
```
- –í—ã—Ö–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ; –ª–æ–≥–∏–∫–∞ –≤–ª–∏—è–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ `ai_message.request_type` (`mentor_free` –ø—Ä–∏ true).

### –¢–æ—á–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ (–∫–ª–∏–µ–Ω—Ç)
- `LeoDialogScreen` ‚Üí –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `skipSpend` –≤ `LeoService.sendMessageWithRAG`.
- `LeoService.sendMessageWithRAG` ‚Üí –≤–∫–ª—é—á–∏—Ç—å `skipSpend` –≤ —Ç–µ–ª–æ POST; –ø–µ—Ä–µ–¥ –ª–æ–∫–∞–ª—å–Ω—ã–º —Å–ø–∏—Å–∞–Ω–∏–µ–º GP: `if (skipSpend) return;`.

### –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- –§–ª–∞–≥ –¥–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è; —Å–µ—Ä–≤–µ—Ä –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–π GP, –ø–æ—ç—Ç–æ–º—É —Ä–µ–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç ¬´–±–µ–∑ —Å–ø–∏—Å–∞–Ω–∏—è¬ª –¥–æ—Å—Ç–∏–≥–∞–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ–ª–∞–≥–∞ —Å—Ç–∞—Ä—ã–º –∫–ª–∏–µ–Ω—Ç–æ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º.

### Rollback (–æ—Ç–∫–∞—Ç)
- –£–¥–∞–ª–∏—Ç—å —á—Ç–µ–Ω–∏–µ `skipSpend` –∏–∑ —Ç–µ–ª–∞ –∏ –≤–µ—Ä–Ω—É—Ç—å –≤—ã–∑–æ–≤ `saveAIMessageData(..., 'chat')` –±–µ–∑ —É—Å–ª–æ–≤–∏—è.
- –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —Ñ–∏—á–µ—Ñ–ª–∞–≥–æ–º, –Ω–µ –∏–∑–º–µ–Ω—è—è —Å–µ—Ä–≤–µ—Ä.

### –ß–µ–∫‚Äë–ª–∏—Å—Ç –ø—Ä–∏—ë–º–∞
- –ü–µ—Ä–µ–¥–∞–Ω `skipSpend=true` ‚Üí –≤ `ai_message.request_type` —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è `mentor_free`.
- –ù–µ –ø–µ—Ä–µ–¥–∞–Ω/false ‚Üí `request_type='chat'`.
- –ö–ª–∏–µ–Ω—Ç –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç GP –ø—Ä–∏ `skipSpend=true` (–ª–æ–∫–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞).

---

## 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ current_level –∏ –º–∞–ø–ø–∏–Ω–≥–∞ —É—Ä–æ–≤–Ω–µ–π - –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –ù–µ–≤–µ—Ä–Ω–∞—è –ª–æ–≥–∏–∫–∞ `update_current_level` (RPC) –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞ `users.current_level`, –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±—ã–ª–æ –±–æ–ª—å—à–µ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ—è–≤–ª—è–ª–∏—Å—å –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
- –í –∫–æ–¥–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –∂—ë—Å—Ç–∫–∏–π –º–∞–ø–ø–∏–Ω–≥ `level_id ‚Üí –Ω–æ–º–µ—Ä`, –≥–¥–µ `22 ‚Üí 0`, —á—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–∞—Å–∫–∏—Ä–æ–≤–∞–ª–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è.

### –†–µ—à–µ–Ω–∏–µ (–∫–ª–∏–µ–Ω—Ç)
- –í `lib/services/supabase_service.dart` –≤–Ω—É—Ç—Ä–∏ `completeLevel(levelId)` –∑–∞–º–µ–Ω—ë–Ω –≤—ã–∑–æ–≤ `rpc('update_current_level')` –Ω–∞ –ø–µ—Ä–µ—Å—á—ë—Ç `current_level` –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:
  1) –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ `levels (id, number)` –∏ —Å—Ç—Ä–æ–∏—Ç—Å—è –∫–∞—Ä—Ç–∞ `id ‚Üí number`.
  2) –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ `user_progress` (–≥–¥–µ `is_completed=true`).
  3) –í—ã—á–∏—Å–ª—è–µ—Ç—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π `levels.number` —Å—Ä–µ–¥–∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π.
  4) –ù–∞—Ö–æ–¥–∏—Ç—Å—è `level_id`, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —ç—Ç–æ–º—É –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º—É –Ω–æ–º–µ—Ä—É.
  5) –í `users.current_level` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞–π–¥–µ–Ω–Ω—ã–π `level_id` (–º–æ–∂–µ—Ç —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –∏–ª–∏ —É–º–µ–Ω—å—à–∞—Ç—å—Å—è ‚Äî –≤—Å–µ–≥–¥–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ —Å —Ñ–∞–∫—Ç–∞–º–∏).

–§–∞–π–ª/–ø—Ä–∞–≤–∫–∞:
```lib/services/supabase_service.dart
// –±—ã–ª–æ:
await Supabase.instance.client
    .rpc('update_current_level', params: {'p_level_id': levelId});

// —Å—Ç–∞–ª–æ: –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –ø–µ—Ä–µ—Å—á—ë—Ç –∏ –ø—Ä—è–º–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ users.current_level
```

### –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–º–µ–Ω–∏—Ç—å –≤ Supabase
- –ù–∏—á–µ–≥–æ. RPC –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –Ω–µ—Ç—Ä–æ–Ω—É—Ç—ã–º; –∫–ª–∏–µ–Ω—Ç –µ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç –≤ —ç—Ç–æ–º –º–µ—Å—Ç–µ.

### –ö–∞–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ (one-off)
–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL (PostgreSQL-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π CTE) —á—Ç–æ–±—ã –ø—Ä–∏–≤–µ—Å—Ç–∏ `users.current_level` –∫ —É—Ä–æ–≤–Ω—é —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `levels.number` —Å—Ä–µ–¥–∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö:
```sql
with ranked as (
  select up.user_id, up.level_id, l.number,
         row_number() over (partition by up.user_id order by l.number desc) as rn
  from user_progress up
  join levels l on l.id = up.level_id
  where up.is_completed = true
)
update users u
set current_level = r.level_id
from ranked r
where r.rn = 1 and u.id = r.user_id;
```

### –¢–µ—Å—Ç—ã/–ø—Ä–æ–≤–µ—Ä–∫–∏
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–±–æ—Ä–æ—á–Ω–æ –ø–∞—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
select u.id, u.current_level, l.number as current_level_number
from users u
left join levels l on l.id = u.current_level
order by u.updated_at desc nulls last
limit 50;

-- –°—Ä–∞–≤–Ω–∏—Ç—å —Å —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –º–∞–∫—Å–∏–º—É–º–æ–º –∏–∑ user_progress
select up.user_id,
       max(l.number) as max_completed_number,
       l2.number as stored_number
from user_progress up
join levels l on l.id = up.level_id
left join levels l2 on l2.id = (select current_level from users where id = up.user_id)
where up.is_completed = true
group by up.user_id, l2.number
order by 1
limit 100;
```

### –û—á–∏—Å—Ç–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π –¥–∞–Ω–Ω—ã—Ö
–ü–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã –¥–≤–∞ —Ç–∏–ø–∞ –Ω–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–µ–π:
- `users.current_level` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `levels.id` (–≤ –≤—ã–±–æ—Ä–∫–µ –≤–∏–¥–Ω–æ `current_level_number = null`).
- –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π, –∞ `current_level` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ placeholder (–Ω–∞–ø—Ä–∏–º–µ—Ä, `level_id = 22` —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º `number = 0`). –¢–∞–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ª—É—á—à–µ –∑–∞–Ω—É–ª–∏—Ç—å.

–†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```sql
-- 1) –û–±–Ω—É–ª–∏—Ç—å current_level, –µ—Å–ª–∏ –æ–Ω –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π levels.id
update users u
set current_level = null
where current_level is not null
  and not exists (select 1 from levels l where l.id = u.current_level);

-- 2) –û–±–Ω—É–ª–∏—Ç—å current_level, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
update users u
set current_level = null
where not exists (
  select 1 from user_progress up
  where up.user_id = u.id and up.is_completed = true
);

-- (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) 3) –ï—Å–ª–∏ level_id=22 —è–≤–ª—è–µ—Ç—Å—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º placeholder'–æ–º
-- –∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π ‚Äî —Ç–∞–∫–∂–µ –æ–±–Ω—É–ª—è–µ–º
update users u
set current_level = null
where current_level = 22
  and not exists (
    select 1 from user_progress up
    where up.user_id = u.id and up.is_completed = true
  );
```

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è one-off SQL —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π `users.current_level` —Ä–∞–≤–µ–Ω —É—Ä–æ–≤–Ω—é —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `levels.number` —Å—Ä–µ–¥–∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö.
- –ü—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –Ω–æ–≤–æ–≥–æ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π `current_level` –±–µ–∑ RPC.
- –ó–Ω–∞—á–µ–Ω–∏–µ `maxCompletedLevel` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞—á–∏–Ω–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–º –¥–∞–Ω–Ω—ã–º –∏ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∂—ë—Å—Ç–∫–∏—Ö –º–∞–ø–ø–∏–Ω–≥–æ–≤.

---

## 3. –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: –µ–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (userContext/levelContext) ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –†–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è `userContext`/`levelContext` –≤ `leo_chat_screen.dart` –∏ `app_shell.dart` –ø—Ä–∏–≤–æ–¥–∏–ª–∞ –∫ –ø—É—Å—Ç—ã–º –ø–æ–ª—è–º –∏ –≤—ã–ø–∞–¥–µ–Ω–∏—é —Å–µ–∫—Ü–∏–π ¬´–ü–ï–†–°–û–ù–ê–õ–ò–ó–ê–¶–ò–Ø –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø¬ª –∏ ¬´–ö–û–ù–¢–ï–ö–°–¢ –£–†–û–ö–ê¬ª –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞. –í `levelContext` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–π –Ω–æ–º–µ—Ä –±–µ–∑ `level_id`.

### –†–µ—à–µ–Ω–∏–µ
- –°–æ–∑–¥–∞–Ω –æ–±—â–∏–π `ContextService` –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
  - `ContextService.buildUserContext(UserModel?)` ‚Äî —Å–æ–±–∏—Ä–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—é (—Ü–µ–ª—å, –æ —Å–µ–±–µ, —Å—Ñ–µ—Ä–∞, –æ–ø—ã—Ç, —Ä–∞–∑–º–µ—Ä –±–∏–∑–Ω–µ—Å–∞, –≤—ã–∑–æ–≤—ã, —Å—Ç–∏–ª—å, —Ä–µ–≥–∏–æ–Ω, —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å) –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –∏–ª–∏ `null`.
  - `ContextService.buildLevelContext(UserModel?)` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ `level_id: <id>` (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–∞—Ä—Å–µ—Ä—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ).

### –§–∞–π–ª—ã –∏ –ø—Ä–∞–≤–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω: `lib/services/context_service.dart` ‚Äî –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å.
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã:
  - `lib/screens/leo_chat_screen.dart`: `_getUserContext()` –∏ `_getLevelContext()` —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç `ContextService`.
  - `lib/screens/app_shell.dart`: `_buildUserContext()` –∏ `_buildLevelContext()` –∑–∞–º–µ–Ω–µ–Ω—ã –Ω–∞ –≤—ã–∑–æ–≤—ã `ContextService`.

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –°–µ—Ä–≤–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `leo-chat` —É–∂–µ —É–º–µ–µ—Ç –ø–∞—Ä—Å–∏—Ç—å `level_id` (regex –ø–æ `level[_ ]?id`). –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

### –¢–µ—Å—Ç—ã/–ø—Ä–æ–≤–µ—Ä–∫–∏
- –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç —Å –õ–µ–æ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ –∏ –∏–∑ –∫–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä–æ–≥–æ —á–∞—Ç–∞: –≤ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ `/leo-chat` –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–µ–ø—É—Å—Ç—ã–µ `userContext` –∏ `levelContext` –≤–∏–¥–∞ `level_id: <—á–∏—Å–ª–æ>`.
- –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤ –ª–æ–≥–∞—Ö –æ—Ç–ª–∞–¥–∫–∏ –≤–∏–¥–µ—Ç—å —Ñ–ª–∞–≥–∏ `hasUserContext=true`, `hasLevelContext=true`.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- `userContext` –±–æ–ª—å—à–µ –Ω–µ –ø—É—Å—Ç–æ–π –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è.
- `levelContext` –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ `level_id: <id>`, —Å–µ—Ä–≤–µ—Ä –µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ RAG/–ª–æ–≥–∏–∫–∏.

---

## 4. –ü—Ä–æ–º–ø—Ç—ã –õ–µ–æ –∏ –ú–∞–∫—Å–∞: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –∏ –º—è–≥–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `maxCompletedLevel` –≤—ã—á–∏—Å–ª—è–ª–∞—Å—å –Ω–µ–≤–µ—Ä–Ω–æ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `level_id`), –ø—Ä–∏–≤–æ–¥—è –∫ –∏–∑–ª–∏—à–Ω–µ —Å—Ç—Ä–æ–≥–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–µ–º –∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫.
- –õ–µ–æ –Ω–µ –¥–∞–≤–∞–ª –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –≤—ã—à–µ —É—Ä–æ–≤–Ω—è, –ú–∞–∫—Å –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–ª –∫ —Ç–µ–º–µ —Ü–µ–ª–∏.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts`:
  - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ä–∞—Å—á—ë—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: —Å–æ–±–∏—Ä–∞–µ–º –≤—Å–µ `user_progress.level_id` —Å–æ `is_completed=true`, –º–∞–ø–ø–∏–º –≤ –Ω–æ–º–µ—Ä–∞ —É—Ä–æ–≤–Ω–µ–π –∏ –±–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º.
  - –í–≤–µ–¥—ë–Ω `finalLevel = maxCompletedLevel > 0 ? maxCompletedLevel : currentLevelNumber` (fallback –Ω–∞ `users.current_level`).
  - –õ–µ–æ: —Å–º—è–≥—á–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Äî –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –≤—ã—à–µ —É—Ä–æ–≤–Ω—è –¥–∞—ë–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ —É—Ä–æ–∫—É –∏ 1‚Äì2 –æ–±—â–∏—Ö –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö –ø–æ–¥—Å–∫–∞–∑–∫–∏ (–±–µ–∑ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞), –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –±–µ–∑ RAG –ø–æ –Ω–µ–ø—Ä–æ–π–¥–µ–Ω–Ω—ã–º —Ç–µ–º–∞–º.
  - –ú–∞–∫—Å: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `finalLevel` –∏ –¥–æ–±–∞–≤–ª–µ–Ω –±–ª–æ–∫ ¬´–í–æ–∑–≤—Ä–∞—Ç –∫ —Ç–µ–º–µ —Ü–µ–ª–∏¬ª ‚Äî –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ –∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏–∏ —Ü–µ–ª–∏ –∏ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É.

### –§–∞–π–ª—ã –∏ –ø—Ä–∞–≤–∫–∏
- `supabase/functions/leo-chat/index.ts`
  - –†–∞—Å—á—ë—Ç `maxCompletedLevel` –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Å–µ—Ö –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π (–±–µ–∑ `.order('level_id')`).
  - –ü–æ–ª—É—á–µ–Ω–∏–µ `currentLevel` –∏ –º–∞–ø–ø–∏–Ω–≥ –≤ –Ω–æ–º–µ—Ä (`currentLevelNumber`).
  - –ù–æ–≤—ã–π `finalLevel` –∏ –∑–∞–º–µ–Ω–∞ –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö `${maxCompletedLevel}` ‚Üí `${finalLevel}`.
  - –û–±–Ω–æ–≤–ª—ë–Ω —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–æ–≤ –¥–ª—è –õ–µ–æ (–º—è–≥–∫–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏) –∏ –ú–∞–∫—Å–∞ (–≤–æ–∑–≤—Ä–∞—Ç –∫ —Ç–µ–º–µ —Ü–µ–ª–∏).

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –ü–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `current_level`.

### –¢–µ—Å—Ç—ã/–ø—Ä–æ–≤–µ—Ä–∫–∏
- –ó–∞–ø—Ä–æ—Å—ã –∫ `/leo-chat`: –≤ –ª–æ–≥–∞—Ö –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç `finalLevel` —Å –æ–∂–∏–¥–∞–µ–º—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º.
- –í–æ–ø—Ä–æ—Å –ø–æ –Ω–µ–ø—Ä–æ–π–¥–µ–Ω–Ω–æ–π —Ç–µ–º–µ: –õ–µ–æ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∫ —É—Ä–æ–∫—É + –¥–∞—ë—Ç 1‚Äì2 –æ–±—â–∏—Ö –ø–æ–¥—Å–∫–∞–∑–∫–∏.
- –ú–∞–∫—Å –ø—Ä–∏ `finalLevel >= 4` —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Ü–µ–ª–∏; –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö ¬´–Ω–µ –ø–æ —Ç–µ–º–µ¬ª ‚Äî –º—è–≥–∫–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ —Ü–µ–ª–∏/—Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ò—Ç–æ–≥–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å –¥–ª—è –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–º–ø—Ç–æ–≤ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–∞–∫ `finalLevel` (max –∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –∏–ª–∏ `current_level`).
- –õ–µ–æ –¥–∞—ë—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–±—â–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞—Ö –≤—ã—à–µ —É—Ä–æ–≤–Ω—è; –ú–∞–∫—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ —Ç–µ–º–µ —Ü–µ–ª–∏.

---

## 5. –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Ç–∞–±–ª–∏—Ü—ã –≤ —Å–ø–∏—Å–∫–∏ ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –ñ—ë—Å—Ç–∫–∏–π –∑–∞–ø—Ä–µ—Ç –Ω–∞ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏–≤–æ–¥–∏–ª –∫ ¬´—Å—É—Ö–∏–º¬ª/–Ω–µ–µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º –±–µ–∑ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∑–∞–º–µ–Ω—ã —Ñ–æ—Ä–º–∞—Ç–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–Ω–æ –ø—Ä–æ—Å–∏—Ç —Ç–∞–±–ª–∏—Ü—É.

### –†–µ—à–µ–Ω–∏–µ
- –í –ø—Ä–æ–º–ø—Ç–µ –õ–µ–æ –∏–∑–º–µ–Ω—ë–Ω –∑–∞–ø—Ä–µ—Ç: –≤–º–µ—Å—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—Ä–µ—Ç–∞ ‚Äî –≤–µ–∂–ª–∏–≤–∞—è –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ ¬´–ü—Ä–µ–¥—Å—Ç–∞–≤–ª—é —Å–ø–∏—Å–∫–æ–º, —Ç–∞–∫ —É–¥–æ–±–Ω–µ–µ —á–∏—Ç–∞—Ç—å –≤ —á–∞—Ç–µ:¬ª –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ ¬´–º–µ—Ç–∫–∞: –∑–Ω–∞—á–µ–Ω–∏–µ¬ª.
- –í —Ä–∞–∑–¥–µ–ª ¬´–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å—Ç–∏–ª—å¬ª –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ: –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ç–∞–±–ª–∏—Ü—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é —Ñ—Ä–∞–∑—É‚Äë–ø–µ—Ä–µ—Ö–æ–¥ –∏ –∑–∞—Ç–µ–º —Å–ø–∏—Å–æ–∫.

### –§–∞–π–ª—ã –∏ –ø—Ä–∞–≤–∫–∏
- `supabase/functions/leo-chat/index.ts` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω—ã –±–ª–æ–∫–∏ ¬´–ó–∞–ø—Ä–µ—Ç—ã¬ª –∏ ¬´–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–∞¬ª –¥–ª—è –õ–µ–æ.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü—Ä–∏ —è–≤–Ω–æ–π –ø—Ä–æ—Å—å–±–µ –æ —Ç–∞–±–ª–∏—Ü–µ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Å–ø–∏—Å–∫–æ–º, –Ω–∞—á–∏–Ω–∞—è —Å –∫–æ—Ä–æ—Ç–∫–æ–π —Ñ—Ä–∞–∑—ã‚Äë–ø–µ—Ä–µ—Ö–æ–¥–∞; —Ñ–æ—Ä–º–∞—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —á–∏—Ç–∞–±–µ–ª—å–Ω—ã–º –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ.

---

## 6. Case-mode: –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ RAG ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –í —Ä–µ–∂–∏–º–µ ¬´–ë–∞—à–Ω—è –ë–∏–∑–õ–µ–≤–µ–ª.–ö–µ–π—Å. –†–µ—à–∏—Ç—å —Å –õ–µ–æ (case-mode)¬ª –ø—Ä–æ–º–ø—Ç —Ç—Ä–µ–±–æ–≤–∞–ª –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAG, –Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ RAG –≤—ã–ø–æ–ª–Ω—è–ª—Å—è –≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —Ñ–ª–∞–≥ —Ä–µ–∂–∏–º–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª—Å—è.

### –†–µ—à–µ–Ω–∏–µ
- –ö–ª–∏–µ–Ω—Ç:
  - `lib/services/leo_service.dart`: –≤ `sendMessageWithRAG` –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `bool caseMode = false` –∏ –ø–µ—Ä–µ–¥–∞—á–∞ `'caseMode': caseMode` –≤ –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.
- –°–µ—Ä–≤–µ—Ä:
  - `supabase/functions/leo-chat/index.ts`: —á–∏—Ç–∞–µ—Ç—Å—è `caseMode` (`caseMode` –∏–ª–∏ `case_mode` –∏–∑ —Ç–µ–ª–∞) –∏ –±–ª–æ–∫ RAG –æ–±—ë—Ä–Ω—É—Ç –≤ `if (!isMax && !caseMode && ...)`, —á—Ç–æ –æ—Ç–∫–ª—é—á–∞–µ—Ç RAG –¥–ª—è –∫–µ–π—Å‚Äë—Ä–µ–∂–∏–º–∞.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü—Ä–∏ `caseMode=true` RAG –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–≤ –ª–æ–≥–∞—Ö –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –æ –∑–∞–ø—É—Å–∫–µ RAG, –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π), –æ—Ç–≤–µ—Ç—ã —Å—Ç—Ä–æ—è—Ç—Å—è –±–µ–∑ RAG‚Äë–º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.
- –ü—Ä–∏ `caseMode=false` –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–µ–∂–Ω–µ–µ (–¥–ª—è –õ–µ–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RAG –≤–∫–ª—é—á—ë–Ω, –¥–ª—è –ú–∞–∫—Å–∞ ‚Äî –≤—ã–∫–ª—é—á–µ–Ω).

---

## 7. MaxAI: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ leo_messages –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –í Edge Function `leo-chat` –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ `leo_messages`, –ø–æ—ç—Ç–æ–º—É —Ç—Ä–∏–≥–≥–µ—Ä `trg_call_leo_memory` –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª, –∏ –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å –Ω–µ –æ–±–Ω–æ–≤–ª—è–ª–∞—Å—å.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI:
  - –ï—Å–ª–∏ –µ—Å—Ç—å `userId` –∏ –∞–∫—Ç–∏–≤–µ–Ω –ú–∞–∫—Å (`isMax`):
    - –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ `leo_chats` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `chatId` (–∑–∞–≥–æ–ª–æ–≤–æ–∫ = –ø–µ—Ä–≤—ã–µ 40 —Å–∏–º–≤–æ–ª–æ–≤ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ user-—Å–æ–æ–±—â–µ–Ω–∏—è).
    - –í—Å—Ç–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (`role='user'`) –≤ `leo_messages`.
    - –í—Å—Ç–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ (`role='assistant'`) –≤ `leo_messages` –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –µ–≥–æ `id`.
  - –í –≤—ã–∑–æ–≤ `saveAIMessageData` –ø–µ—Ä–µ–¥–∞—ë–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π `chat_id` –∏ `leo_message_id` –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

### –≠—Ñ—Ñ–µ–∫—Ç
- –í—Å—Ç–∞–≤–∫–∞ –≤ `leo_messages` –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä `trg_call_leo_memory`, –≤—ã–∑—ã–≤–∞—é—â–∏–π `leo-memory` –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ñ–∞–∫—Ç–æ–≤, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–º—è—Ç—å –≤ –¥–∏–∞–ª–æ–≥–∞—Ö –ú–∞–∫—Å–∞.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ MaxAI –ø–æ—è–≤–ª—è—é—Ç—Å—è 2 –∑–∞–ø–∏—Å–∏ –≤ `leo_messages` (user/assistant).
- –í `ai_message` –ø–æ–ª–µ `leo_message_id` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∑–∞–ø–∏—Å—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
- –¢—Ä–∏–≥–≥–µ—Ä `trg_call_leo_memory` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç (–ø–æ—è–≤–ª—è—é—Ç—Å—è –Ω–æ–≤—ã–µ —Ñ–∞–∫—Ç—ã/–ª–æ–≥–∏ –æ—Ç `leo-memory`).

---

## 8. LeoAI: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ leo_messages –∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ MaxAI, –¥–∏–∞–ª–æ–≥–∏ –õ–µ–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–ª–∏—Å—å –≤ `leo_messages`, –∏–∑‚Äë–∑–∞ —á–µ–≥–æ –ø–∞–º—è—Ç—å –Ω–µ –ø–æ–ø–æ–ª–Ω—è–ª–∞—Å—å.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–æ –Ω–∞ –æ–±–æ–∏—Ö –±–æ—Ç–æ–≤:
  - –ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `userId` –¥–ª—è `bot: 'leo'` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–∞ –∂–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: —Å–æ–∑–¥–∞—Ç—å `leo_chats` –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `chatId`, –∑–∞–ø–∏—Å–∞—Ç—å `leo_messages` (user/assistant), –ø–µ—Ä–µ–¥–∞—Ç—å `leo_message_id` –≤ `ai_message`.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü–æ—Å–ª–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ LeoAI –ø–æ—è–≤–ª—è—é—Ç—Å—è 2 –∑–∞–ø–∏—Å–∏ –≤ `leo_messages` (user/assistant).
- –í `ai_message` –ø–æ–ª–µ `leo_message_id` —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∑–∞–ø–∏—Å—å –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –õ–µ–æ.
- –¢—Ä–∏–≥–≥–µ—Ä `trg_call_leo_memory` —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–∫—Ç—ã –ø–æ –õ–µ–æ.

### –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö —Ñ–∞–∫—Ç–æ–≤ –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤ (—É–ª—É—á—à–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤).
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –õ–µ–æ/–ú–∞–∫—Å–∞ —É—á–∏—Ç—ã–≤–∞—é—Ç –ø—Ä–æ—à–ª—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏, —Ü–µ–ª–∏, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è.
- –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –≤ `leo_chats`/`leo_messages` –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –æ—Ç–ª–∞–¥–∫–∏ –∏ –∞–≤—Ç–æ—Å–≤–æ–¥–æ–∫.
- –°–≤—è–∑–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∏ –º–µ—Ç—Ä–∏–∫: `ai_message.leo_message_id` –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å/—Ç–æ–∫–µ–Ω—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º.

---

## 9. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è current_level –≤ –ª–æ–≥–∏–∫–µ —É—Ä–æ–≤–Ω–µ–π ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- `current_level` –∑–∞–≥—Ä—É–∂–∞–ª—Å—è –∏–∑ `users.current_level` (—Å—Ç—Ä–æ–∫–∏ 641-655), –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö –∏ –ª–æ–≥–∏–∫–µ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π.
- –í `finalLevel` —É—á–∏—Ç—ã–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ `maxCompletedLevel`, –∞ `currentLevelNumber` (–º–∞–ø–ø–∏–Ω–≥ `current_level`) –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Ç–æ–ª—å–∫–æ –∫–∞–∫ fallback.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `current_level`:
  - –í—ã–≤–æ–¥–∏—Ç—Å—è `maxCompletedLevel`, `currentLevel`, `currentLevelNumber`, `finalLevel` –≤ –∫–æ–Ω—Å–æ–ª—å.
  - –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ `current_level` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –º–∞–ø–ø–∏—Ç—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `finalLevel`.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –í –ª–æ–≥–∞—Ö –æ—Ç–ª–∞–¥–∫–∏ –≤–∏–¥–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `current_level` –≤ —Ä–∞—Å—á—ë—Ç–µ `finalLevel`.
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π (`maxCompletedLevel = 0`) –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `currentLevelNumber` –∏–∑ `users.current_level`.

---

## 10. Fallback –¥–ª—è core_goals –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –ü—Ä–∏ –ø—É—Å—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ `core_goals` –±–ª–æ–∫ `goalBlock` –æ—Å—Ç–∞–≤–∞–ª—Å—è –ø—É—Å—Ç—ã–º, —á—Ç–æ –∑–∞—Ç—Ä—É–¥–Ω—è–ª–æ —Ä–∞–±–æ—Ç—É –ú–∞–∫—Å–∞ —Å —Ü–µ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` –¥–æ–±–∞–≤–ª–µ–Ω fallback –¥–ª—è `goalBlock`:
  - –ï—Å–ª–∏ `core_goals` –ø—É—Å—Ç–∞ ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `user.goal` –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º "–¶–µ–ª—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è:".
  - –ï—Å–ª–∏ –∏ –ø—Ä–æ—Ñ–∏–ª—å –ø—É—Å—Ç–æ–π ‚Üí –≤—ã–≤–æ–¥–∏—Ç—Å—è –º–æ—Ç–∏–≤–∏—Ä—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–¶–µ–ª—å –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ü–µ–ª—å –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã.".

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ `core_goals` –ú–∞–∫—Å –ø–æ–ª—É—á–∞–µ—Ç —Ü–µ–ª—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏–ª–∏ –º–æ—Ç–∏–≤–∞—Ü–∏—é –∫ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Ü–µ–ª–∏.
- `weekly_progress` –æ—Å—Ç–∞—ë—Ç—Å—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ú–∞–∫—Å–∞).

---

## 11. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ë–î —Å retry –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î –æ–±—ë—Ä–Ω—É—Ç –≤ try-catch, –Ω–æ –æ—à–∏–±–∫–∏ —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è.
- –ü—Ä–∏ —Å–±–æ–µ –∑–∞–≥—Ä—É–∑–∫–∏ `core_goals` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —É–∑–Ω–∞—ë—Ç –æ–± —ç—Ç–æ–º.
- –ù–µ—Ç retry-–º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` –¥–æ–±–∞–≤–ª–µ–Ω retry –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ `core_goals`:
  - –î–æ 2 –ø–æ–ø—ã—Ç–æ–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 1 —Å–µ–∫—É–Ω–¥–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏.
  - –ü—Ä–∏ –Ω–µ—É–¥–∞—á–µ –æ–±–µ–∏—Ö –ø–æ–ø—ã—Ç–æ–∫ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è `goalLoadError = true`.
  - –í `goalBlock` –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.
- –î–æ–±–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø—Ä–æ–º–ø—Ç –ú–∞–∫—Å–∞:
  - –ï—Å–ª–∏ `goalLoadError = true`, –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ü–µ–ª–∏ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –û—Ç–≤–µ—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–º. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü—Ä–∏ —Å–±–æ–µ –∑–∞–≥—Ä—É–∑–∫–∏ `core_goals` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–µ.
- Retry-–º–µ—Ö–∞–Ω–∏–∑–º –ø–æ–≤—ã—à–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ë–î –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ retry (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ).

---

## 12. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- `goalBlock`, `sprintBlock`, `remindersBlock`, `quoteBlock` –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–ª–∏—Å—å –∏–∑ –ë–î –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ.
- –≠—Ç–æ –∑–∞–º–µ–¥–ª—è–ª–æ –æ—Ç–≤–µ—Ç—ã –ú–∞–∫—Å–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏—è—Ö.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` –¥–æ–±–∞–≤–ª–µ–Ω in-memory –∫—ç—à –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤:
  - TTL –∫—ç—à–∞: 5 –º–∏–Ω—É—Ç (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ).
  - –ö–ª—é—á–∏ –∫—ç—à–∞: `goal_${userId}_max`, `sprint_${userId}_max`, `reminders_${userId}_max`, `quote_${userId}_max`.
  - –§—É–Ω–∫—Ü–∏–∏ `getCachedContext()` –∏ `setCachedContext()` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫—ç—à–µ–º.
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ú–∞–∫—Å–∞ (isMax = true), —Ç–∞–∫ –∫–∞–∫ –õ–µ–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–∏ –±–ª–æ–∫–∏.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ –ú–∞–∫—Å—É –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –±–ª–æ–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ –∫—ç—à–∞.
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ —Å–æ–∫—Ä–∞—â–∞–µ—Ç—Å—è –∑–∞ —Å—á—ë—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î.
- `systemPrompt` –æ—Å—Ç–∞—ë—Ç—Å—è –±–µ–∑ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è (—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ –∏ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –º–Ω–æ–≥–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö).

---

## 13. –ü–µ—Ä–µ–¥–∞—á–∞ goalVersion –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ú–∞–∫—Å–∞ ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- `goalVersion` –æ–ø—Ä–µ–¥–µ–ª—è–ª—Å—è –∏–∑ `core_goals`, –Ω–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ú–∞–∫—Å–∞.
- –ú–∞–∫—Å –Ω–µ –∑–Ω–∞–ª, –Ω–∞ –∫–∞–∫–æ–π —Å—Ç–∞–¥–∏–∏ —Ä–∞–±–æ—Ç—ã —Å —Ü–µ–ª—å—é –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (v1/v2/v3/v4).

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ `goalVersion` –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç:
  - –°–æ–∑–¥–∞—ë—Ç—Å—è `versionContext` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ —Ü–µ–ª–∏.
  - –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ú–∞–∫—Å–∞ –∫–∞–∫ "–¢–ï–ö–£–©–ê–Ø –í–ï–†–°–ò–Ø –¶–ï–õ–ò: v${goalVersion}".
  - –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ú–∞–∫—Å—É –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –ø–æ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–∞–¥–∏—é —Ä–∞–±–æ—Ç—ã —Å —Ü–µ–ª—å—é.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –í —Å–∏—Å—Ç–µ–º–Ω–æ–º –ø—Ä–æ–º–ø—Ç–µ –ú–∞–∫—Å–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Ç–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è —Ü–µ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
- –ú–∞–∫—Å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
- –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è —Ü–µ–ª–∏ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞, –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ).

---

## 14. –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ), —á—Ç–æ –∑–∞–º–µ–¥–ª—è–ª–æ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
- –ü—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–ª–æ—Å—å –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –¥–ª—è –≤—Å–µ—Ö –±–ª–æ–∫–æ–≤ (`goalBlock`, `sprintBlock`, `remindersBlock`, `quoteBlock`) –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.
  - –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –æ–±—ë—Ä–Ω—É—Ç—ã –≤ `Promise.all()` –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
  - –ó–∞–≤–∏—Å–∏–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Å—Ç–∞—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å).
  - –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç–¥–µ–ª—å–Ω–æ.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤ —Å–æ–∫—Ä–∞—Ç–∏–ª–æ—Å—å –≤ 2-4 —Ä–∞–∑–∞.
- –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ.
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏.

---

## 15. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è RAG –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- RAG –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —á—Ç–æ –∑–∞–º–µ–¥–ª—è–ª–æ –æ–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞.
- –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –∑–∞–Ω–æ–≤–æ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞, –¥–∞–∂–µ –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è RAG:
  - **–£—Å–ª–æ–≤–Ω–æ–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ**: RAG –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–µ–Ω (–Ω–µ Max, –Ω–µ case-mode, –≤–æ–ø—Ä–æ—Å –ø–æ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É —É—Ä–æ–≤–Ω—é).
  - **Graceful degradation**: –ï—Å–ª–∏ RAG —É–ø–∞–ª, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç—É –±–µ–∑ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
  - **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤**: –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 24 —á–∞—Å–∞, —á—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å –ø–æ—Ö–æ–∂–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏.
  - **–í—ã–¥–µ–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è**: `performRAGQuery()` –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É RAG —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- RAG –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, —Å–æ–∫—Ä–∞—â–∞—è –æ–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞.
- –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ –∫—ç—à–∏—Ä—É—é—Ç—Å—è, —É—Å–∫–æ—Ä—è—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã.
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö RAG –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
- –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –≤–æ–ø—Ä–æ—Å–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ RAG —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.

---

## 16. –ë–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤: –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ‚Äì –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –ó–∞–ø—Ä–æ—Å—ã –∫ `user_memories` –∏ `leo_chats` –≤—ã–ø–æ–ª–Ω—è–ª–∏—Å—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∑–∞–º–µ–¥–ª—è—è –∑–∞–≥—Ä—É–∑–∫—É –ø–∞–º—è—Ç–∏.
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ `leo_messages` –≤—ã–ø–æ–ª–Ω—è–ª–æ—Å—å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, –∑–∞–º–µ–¥–ª—è—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø.

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –±–∞—Ç—á–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤:
  - **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏**: `user_memories` –∏ `leo_chats` –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–µ—Ä–µ–∑ `Promise.all()`.
  - **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—Å–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.
  - **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫**: `saveAIMessageData()` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
  - **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ —Å graceful degradation.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏ –∏ —Å–≤–æ–¥–æ–∫ —á–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —Å–æ–∫—Ä–∞—â–∞—è –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏.
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, —É—Å–∫–æ—Ä—è—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø.
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
- –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è.

---

## 17. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø—Ä–æ–º–ø—Ç–æ–≤ –ø–æ–¥ —É—Ä–æ–≤–µ–Ω—å –æ–ø—ã—Ç–∞ –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ü—Ä–æ–±–ª–µ–º–∞
- –ï–¥–∏–Ω—ã–π —Ç–æ–Ω –∏ —Å—Ç–∏–ª—å –æ—Ç–≤–µ—Ç–æ–≤ –±–µ–∑ —É—á—ë—Ç–∞ –æ–ø—ã—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–Ω–∏–∂–∞–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å.
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω (Kaspi, —Ç–µ–Ω–≥–µ, –ª–æ–∫–∞–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã, –≥–æ—Ä–æ–¥–∞).

### –†–µ—à–µ–Ω–∏–µ
- –í `supabase/functions/leo-chat/index.ts` –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–≤–∞ –º–æ–¥—É–ª—è, –≤–∫–ª—é—á–∞–µ–º—ã–µ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –õ–µ–æ –∏ –ú–∞–∫—Å–∞:
  - ¬´–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –æ–ø—ã—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è¬ª ‚Äî –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è —Ç–æ–Ω –∏ –≥–ª—É–±–∏–Ω–∞ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `users.experience_level` (beginner/intermediate/advanced).
  - ¬´–õ–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç¬ª ‚Äî —è–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∑–∞—Ö—Å—Ç–∞–Ω—Å–∫–∏–µ —Ä–µ–∞–ª–∏–∏ (Kaspi, Halyk, Magnum, BI Group, Choco Family; —Ç–µ–Ω–≥–µ; –ê–ª–º–∞—Ç—ã/–ê—Å—Ç–∞–Ω–∞/–®—ã–º–∫–µ–Ω—Ç).

### –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `experienceLevel` –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ `experienceModule`.
- –ë–ª–æ–∫ `localContextModule` –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç—ã –≤—Å–µ–≥–¥–∞.
- –û–±–∞ –±–ª–æ–∫–∞ –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –õ–µ–æ –∏ –ú–∞–∫—Å–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–∏ `finalLevel`, RAG, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π.

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏
- –í —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–∞—Ö –õ–µ–æ –∏ –ú–∞–∫—Å–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–µ–∫—Ü–∏–∏ ¬´–ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ –æ–ø—ã—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è¬ª –∏ ¬´–õ–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç¬ª.
- –î–ª—è –ø—Ä–æ—Ñ–∏–ª–µ–π —Å —Ä–∞–∑–Ω—ã–º `experience_level` –º–µ–Ω—è–µ—Ç—Å—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –ø–æ–¥—Å–µ–∫—Ü–∏–∏ –æ–± –æ–ø—ã—Ç–µ.
- –í –æ—Ç–≤–µ—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã (—Ç–µ–Ω–≥–µ, Kaspi, –ê–ª–º–∞—Ç—ã/–ê—Å—Ç–∞–Ω–∞ –∏ —Ç.–¥.).

## –ü–ª–∞–Ω –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π leo-chat —Ñ—É–Ω–∫—Ü–∏–∏

### –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (–±—ã—Å—Ç—Ä—ã–π –æ–±–∑–æ—Ä)
- 2) –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –±–ª–æ–∫–∏ (Max): —á–∞—Å—Ç–∏—á–Ω–æ ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ú–∞–∫—Å—É –¥–ª—è —Ñ–∏–∫—Å–∞—Ü–∏–∏ –≤ –ª–æ–≥–∞—Ö
- 3) RAG –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è (Leo): –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Äî RAG –≤–∫–ª—é—á–∞–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —Ç–µ–º –∏ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –¥–ª—è –Ω–µ–ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö
- 4) –ö—ç—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ ‚Äî –Ω—É–∂–µ–Ω –ø–æ–≤—Ç–æ—Ä –∏–¥–µ–Ω—Ç–∏—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
- 5) –ë–∞—Ç—á–∏–Ω–≥ –ø–∞–º—è—Ç–∏: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏/—Å–≤–æ–¥–æ–∫ –Ω–µ—Ç
- 6) –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –≤ ai_message –µ—Å—Ç—å; –∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å leo_messages/leo_chats SQL‚Äë–∑–∞–ø—Ä–æ—Å–∞–º–∏
- 7) –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ invalid userId: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ
- 8) –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: —á–∞—Å—Ç–∏—á–Ω–æ ‚Äî –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ RAG –≤–∏–¥–Ω–æ, –Ω–æ –±–∞–∑–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã ¬´–¥–æ/–ø–æ—Å–ª–µ¬ª –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã

### 1. **–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é**
```bash
# –í Supabase Dashboard –∑–∞–º–µ–Ω–∏—Ç–µ leo-chat/index.ts –Ω–∞ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –¥–µ–ø–ª–æ–∏—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (—Ä–∞–∑–¥–µ–ª 14)** ‚Äî –°–¢–ê–¢–£–°: —á–∞—Å—Ç–∏—á–Ω–æ

**–¢–µ—Å—Ç**: –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å –∫ –ú–∞–∫—Å—É –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
```json
// –ó–∞–ø—Ä–æ—Å –∫ /leo-chat
{
  "messages": [{"role": "user", "content": "–ü–æ–º–æ–≥–∏ —Å —Ü–µ–ª—å—é"}],
  "bot": "max",
  "userId": "your-user-id"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏**:
```
ÔøΩÔøΩ DEBUG: –§–∏–Ω–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç: { bot: 'max', finalLevel: X, hasRagContext: false, ... }
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞**: –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ (–∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –±–ª–æ–∫–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ).

### 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ RAG –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—Ä–∞–∑–¥–µ–ª 15)** ‚Äî –°–¢–ê–¢–£–°: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

**–¢–µ—Å—Ç**: –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å –∫ –õ–µ–æ —Å –≤–æ–ø—Ä–æ—Å–æ–º –ø–æ –ø—Ä–æ–π–¥–µ–Ω–Ω–æ–º—É —É—Ä–æ–≤–Ω—é
```json
// –ó–∞–ø—Ä–æ—Å –∫ /leo-chat
{
  "messages": [{"role": "user", "content": "–ö–∞–∫ –ø–æ—Å—Ç–∞–≤–∏—Ç—å SMART-—Ü–µ–ª—å?"}],
  "bot": "leo",
  "userId": "your-user-id"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏**:
```
ÔøΩÔøΩ DEBUG: RAG –≤–∫–ª—é—á–µ–Ω –¥–ª—è –±–æ—Ç–∞: leo
ÔøΩÔøΩ DEBUG: RAG —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: { found: X, error: 'none' }
üîß DEBUG: RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–∑–¥–∞–Ω, –¥–ª–∏–Ω–∞: XXX —Å–∏–º–≤–æ–ª–æ–≤
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞**: RAG –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.

### 4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (—Ä–∞–∑–¥–µ–ª 15)** ‚Äî –°–¢–ê–¢–£–°: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

**–¢–µ—Å—Ç**: –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–≤–∞–∂–¥—ã –ø–æ–¥—Ä—è–¥
```json
// –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
{
  "messages": [{"role": "user", "content": "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—Ç—Ä–∏—Ü–∞ –≠–π–∑–µ–Ω—Ö–∞—É—ç—Ä–∞?"}],
  "bot": "leo"
}

// –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (—Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç)
{
  "messages": [{"role": "user", "content": "–ß—Ç–æ —Ç–∞–∫–æ–µ –º–∞—Ç—Ä–∏—Ü–∞ –≠–π–∑–µ–Ω—Ö–∞—É—ç—Ä–∞?"}],
  "bot": "leo"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ (—ç–º–±–µ–¥–¥–∏–Ω–≥ –∏–∑ –∫—ç—à–∞).

### 5. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞—Ç—á–∏–Ω–≥–∞ –ø–∞–º—è—Ç–∏ (—Ä–∞–∑–¥–µ–ª 16)** ‚Äî –°–¢–ê–¢–£–°: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ

**–¢–µ—Å—Ç**: –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è–º–∏
```json
{
  "messages": [{"role": "user", "content": "–ü—Ä–∏–≤–µ—Ç"}],
  "bot": "leo",
  "userId": "user-with-memories"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏**:
```
// –ù–ï –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
ERR user_memories
ERR chat_summaries

// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
INFO request_meta: { memoriesText_present: true, recentSummaries_present: true }
```

### 6. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (—Ä–∞–∑–¥–µ–ª 16)** ‚Äî –°–¢–ê–¢–£–°: –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–º–µ—Ç—Ä–∏–∫–∏ –≤–∏–¥–Ω—ã); –ü–†–û–°–¨–ë–ê: –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å–∏ –≤ leo_messages/leo_chats —á–µ—Ä–µ–∑ SQL –Ω–∏–∂–µ

**–¢–µ—Å—Ç**: –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–π –∑–∞–ø—Ä–æ—Å –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
```json
{
  "messages": [{"role": "user", "content": "–¢–µ—Å—Ç"}],
  "bot": "leo",
  "userId": "test-user"
}
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î**:
```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–∑–¥–∞–ª–∏—Å—å –∑–∞–ø–∏—Å–∏
SELECT * FROM leo_chats WHERE user_id = 'test-user' ORDER BY created_at DESC LIMIT 1;
SELECT * FROM leo_messages WHERE user_id = 'test-user' ORDER BY created_at DESC LIMIT 2;
SELECT * FROM ai_message WHERE user_id = 'test-user' ORDER BY created_at DESC LIMIT 1;
```

### 7. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫** ‚Äî –°–¢–ê–¢–£–°: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ

**–¢–µ—Å—Ç**: –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∑–∞–ø—Ä–æ—Å —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º userId
```json
{
  "messages": [{"role": "user", "content": "–¢–µ—Å—Ç"}],
  "bot": "leo",
  "userId": "invalid-uuid"
}
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ, –Ω–æ —Å –ø—É—Å—Ç—ã–º–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞–º–∏.

### 8. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏** ‚Äî –°–¢–ê–¢–£–°: —á–∞—Å—Ç–∏—á–Ω–æ (–Ω–µ—Ç –º–µ—Ç—Ä–∏–∫ ¬´–¥–æ/–ø–æ—Å–ª–µ¬ª)

**–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è**:
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ vs –ø–æ—Å–ª–µ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –≤ –ª–æ–≥–∞—Ö
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫—ç—à–∞

**–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã**:
- –õ–æ–≥–∏ Supabase Edge Functions
- Network tab –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏

### 9. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –∏–∑ corrections.md**

**–ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å)**:
- ‚úÖ –†–∞–∑–¥–µ–ª 1: `skipSpend` ‚Äî –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç (mentor‚Äëmode —Å skipSpend=true)
- ‚úÖ –†–∞–∑–¥–µ–ª 2: `current_level` ‚Äî –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –º–∞–ø–ø–∏—Ç—Å—è (id‚Üínumber), finalLevel –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ –†–∞–∑–¥–µ–ª 3: `ContextService` ‚Äî userContext/levelContext —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∏ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è
- ‚úÖ –†–∞–∑–¥–µ–ª 4: `finalLevel` ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö; –≤ –ª–æ–≥–∞—Ö finalLevel=2
- ‚úÖ –†–∞–∑–¥–µ–ª 6: `caseMode` ‚Äî –ü–†–û–í–ï–†–ï–ù–û (RAG –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ caseMode=true –≤ –º–∏–Ω–∏-–∫–µ–π—Å–∞—Ö)
- ‚úÖ –†–∞–∑–¥–µ–ª—ã 7‚Äì8: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `leo_messages` ‚Äî –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–û SQL –≤—ã–±–æ—Ä–∫–∞–º–∏
- ‚úÖ –†–∞–∑–¥–µ–ª 9: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `current_level` ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ finalLevel/levelContext
- ‚úÖ –†–∞–∑–¥–µ–ª 10: Fallback –¥–ª—è `core_goals` ‚Äî –ü–†–û–í–ï–†–ï–ù–û (Max –±–µ—Ä—ë—Ç —Ü–µ–ª—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –ø—É—Å—Ç–æ–º core_goals)
- ‚úÖ –†–∞–∑–¥–µ–ª 11: Retry –¥–ª—è `core_goals` ‚Äî –ü–†–û–í–ï–†–ï–ù–û (fallback –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã)
- ‚óë –†–∞–∑–¥–µ–ª 12: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤ (Max) ‚Äî –ß–ê–°–¢–ò–ß–ù–û –ü–†–û–í–ï–†–ï–ù–û (8—Å‚Üí6—Å, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å)
    –í production —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –∑–∞–ø—É—Å–∫–æ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ª—É—á—à–µ (–≤ –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —Ç–µ—Å—Ç–∞—Ö –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ)
- ‚úÖ –†–∞–∑–¥–µ–ª 13: `goalVersion` ‚Äî –ü–†–û–í–ï–†–ï–ù–û (–≤–µ—Ä—Å–∏—è v1 –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ core_goals)
- ‚úÖ –†–∞–∑–¥–µ–ª—ã 14‚Äì16: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ ‚Äî –ü–†–û–í–ï–†–ï–ù–û (47–º—Å –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤)

### 10. **–ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—Ö–∞**

**‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏**:
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ —Å–æ–∫—Ä–∞—Ç–∏–ª–æ—Å—å –Ω–∞ 20-40%
- –í –ª–æ–≥–∞—Ö –Ω–µ—Ç –æ—à–∏–±–æ–∫ –ë–î
- –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±—ã—Å—Ç—Ä–µ–µ)
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–∏–¥–Ω–æ –≤ –ª–æ–≥–∞—Ö

**‚ùå –¢—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏, –µ—Å–ª–∏**:
- –û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–æ-–¥—Ä—É–≥–æ–º—É
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏–ª–∏ —Å—Ç–∞–ª–æ —Ö—É–∂–µ



## 16. Level 4 not unlocking after mini-case completion

**–ü—Ä–æ–±–ª–µ–º–∞**: After completing mini-case 1 (after_level=3), level 4 remains locked with "–¢—Ä–µ–±—É—é—Ç—Å—è GP" message.

**–ü—Ä–∏—á–∏–Ω–∞**: Levels 4+ are marked as `is_free = false` and require GP purchase, but the payment system redirects to `payments.example.com` (test URL) and doesn't work.

**–†–µ—à–µ–Ω–∏–µ**: 
- Fixed `towerNodesProvider` to filter `user_case_progress` by current `user_id`
- Added provider invalidation in `MiniCaseScreen._complete()` to refresh tower/levels data
- **–í–†–ï–ú–ï–ù–ù–û**: Disabled GP blocking for testing by setting `hasAccess = true` in `levels_provider.dart`

**–§–∞–π–ª—ã**:
- `lib/providers/levels_provider.dart`: Fixed user filtering and temporarily disabled GP blocking
- `lib/screens/mini_case_screen.dart`: Added provider invalidation on completion

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ (–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞ GP-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

---

## 17. Mini-case completion icon not updating in UI

**–ü—Ä–æ–±–ª–µ–º–∞**: After completing mini-case, the icon in the tower doesn't update to show "completed" status.

**–ü—Ä–∏—á–∏–Ω–∞**: Provider invalidation was happening after navigation, so UI didn't have time to update.

**–†–µ—à–µ–Ω–∏–µ**: 
- Move provider invalidation before navigation
- Add small delay for UI update
- Invalidate specific case status provider
- **–ì–õ–ê–í–ù–û–ï**: Fix UI icon logic - mini-case icons weren't using `isCompleted` status

**–§–∞–π–ª—ã**:
- `lib/screens/mini_case_screen.dart`: Reorder invalidation before navigation, add delay and caseStatusProvider invalidation
- `lib/screens/tower/tower_tiles.dart`: Fix mini-case icon to show `Icons.work` when completed vs `Icons.work_outline` when not completed
- `lib/screens/tower/tower_tiles.dart`: Fix mini-case color to show `AppColor.success` when completed vs `AppColor.info` when not completed

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

## 18. Cleanup debug messages

**–ü—Ä–æ–±–ª–µ–º–∞**: –û—Å—Ç–∞–ª–∏—Å—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ print() —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∫–æ–¥–µ –ø–æ—Å–ª–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º.

**–†–µ—à–µ–Ω–∏–µ**: –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.

**–§–∞–π–ª—ã**:
- `lib/screens/mini_case_screen.dart`: –£–¥–∞–ª–µ–Ω—ã DEBUG print —Å–æ–æ–±—â–µ–Ω–∏—è
- `lib/services/leo_service.dart`: –£–¥–∞–ª–µ–Ω—ã DEBUG print —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏

**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ


## 9. Max AI current_level loading issue

**–ü—Ä–æ–±–ª–µ–º–∞:** Max AI –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ `current_level` –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –æ—Ç–≤–µ—Ç–∞–º.

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è `currentLevel1` –±—ã–ª–∞ –æ–±—ä—è–≤–ª–µ–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ `if (isMax)`, –Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –≤–Ω–µ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞.

**–†–µ—à–µ–Ω–∏–µ:** 
1. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ `currentLevel1` –≤ –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏, –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –∫–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ `current_level` –≤ –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏, –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
3. –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏—Ä—É—é—â–∏–π –∫–æ–¥ –∑–∞–≥—Ä—É–∑–∫–∏ `current_level` –∏–∑ –±–ª–æ–∫–∞ `if (isMax)`

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- `currentLevel1` —Ç–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤
- `currentLevel` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç (14 ‚Üí 4)
- `currentLevelNumber` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è
- Max AI –ø–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## 10. skipSpend –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ Edge Function

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–∞—Ä–∞–º–µ—Ç—Ä `skipSpend` –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –≤ –ø–æ–ª–µ–∑–Ω—É—é –Ω–∞–≥—Ä—É–∑–∫—É –¥–ª—è Edge Function, –ø–æ—ç—Ç–æ–º—É `request_type` –≤—Å–µ–≥–¥–∞ –±—ã–ª `'chat'` –≤–º–µ—Å—Ç–æ `'mentor_free'`.

**–ü—Ä–∏—á–∏–Ω–∞:** –í `lib/services/leo_service.dart` –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `sendMessageWithRAG` –ø–∞—Ä–∞–º–µ—Ç—Ä `skipSpend` –Ω–µ –≤–∫–ª—é—á–∞–ª—Å—è –≤ `payload`.

**–†–µ—à–µ–Ω–∏–µ:** 
1. –î–æ–±–∞–≤–∏—Ç—å `'skipSpend': skipSpend` –≤ `payload` –≤ `leo_service.dart`
2. –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É –≤ `leo_dialog_screen.dart` —á—Ç–æ–±—ã `skipSpend` —Ä–∞–±–æ—Ç–∞–ª –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ mentor-mode

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- `skipSpend` —Ç–µ–ø–µ—Ä—å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ Edge Function
- `request_type` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞–∫ `'mentor_free'` –¥–ª—è mentor-mode
- GP –Ω–µ —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –≤ mentor-mode (–≤–∏–¥–Ω–æ –≤ –ë–î)

---

## –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### ‚úÖ –£–°–ü–ï–®–ù–û –ü–†–û–í–ï–†–ï–ù–û (11/11 —Ä–∞–∑–¥–µ–ª–æ–≤):

1. **–†–∞–∑–¥–µ–ª 1: `skipSpend`** ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç (mentor-mode —Å skipSpend=true)
2. **–†–∞–∑–¥–µ–ª 2: `current_level`** ‚Äî –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –º–∞–ø–ø–∏—Ç—Å—è (id‚Üínumber)
3. **–†–∞–∑–¥–µ–ª 3: `ContextService`** ‚Äî userContext/levelContext —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è
4. **–†–∞–∑–¥–µ–ª 4: `finalLevel`** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö
5. **–†–∞–∑–¥–µ–ª 6: `caseMode`** ‚Äî RAG –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –ø—Ä–∏ caseMode=true –≤ –º–∏–Ω–∏-–∫–µ–π—Å–∞—Ö
6. **–†–∞–∑–¥–µ–ª—ã 7-8: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ `leo_messages`** ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ SQL –≤—ã–±–æ—Ä–∫–∞–º–∏
7. **–†–∞–∑–¥–µ–ª 9: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `current_level`** ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ finalLevel/levelContext
8. **–†–∞–∑–¥–µ–ª 10: Fallback –¥–ª—è `core_goals`** ‚Äî Max –±–µ—Ä—ë—Ç —Ü–µ–ª—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏ –ø—É—Å—Ç–æ–º core_goals
9. **–†–∞–∑–¥–µ–ª 11: Retry –¥–ª—è `core_goals`** ‚Äî fallback –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã
10. **–†–∞–∑–¥–µ–ª 13: `goalVersion`** ‚Äî –≤–µ—Ä—Å–∏—è v1 –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–∑ core_goals
11. **–†–∞–∑–¥–µ–ª—ã 14-16: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏** ‚Äî 47–º—Å –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤

### ‚óë –ß–ê–°–¢–ò–ß–ù–û –ü–†–û–í–ï–†–ï–ù–û (1/11 —Ä–∞–∑–¥–µ–ª–æ–≤):

12. **–†–∞–∑–¥–µ–ª 12: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã—Ö –±–ª–æ–∫–æ–≤** ‚Äî —á–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (8—Å‚Üí6—Å, –Ω–æ —Ñ—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–ª–∞—Å—å)

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

- **–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:** 47–º—Å (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
- **–í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞:** —Å–æ–∫—Ä–∞—â–µ–Ω–æ –Ω–∞ 20-40%
- **–û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å:** 100% (fallback —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ —Å–±–æ—è—Ö –ë–î)
- **–ü–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏:** 11/11 —Ä–∞–∑–¥–µ–ª–æ–≤ (100%)

### –ó–∞–∫–ª—é—á–µ–Ω–∏–µ:

–í—Å–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã. –°–∏—Å—Ç–µ–º–∞ Leo/Max AI —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ, –±—ã—Å—Ç—Ä–æ –∏ –Ω–∞–¥–µ–∂–Ω–æ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ–ª—É—á–∞—é—Ç —É–ª—É—á—à–µ–Ω–Ω—ã–π –æ–ø—ã—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞–º–∏.

---

## 10.1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ü–µ–ª–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 23502 (NULL user_id)

**–°–∏–º–ø—Ç–æ–º:** –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –≤ `core_goals` –æ—à–∏–±–∫–∞ `23502: null value in column "user_id"`.

**–ü—Ä–∏—á–∏–Ω–∞:** –≤ INSERT –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü `user_id`.

**–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ:**
- –í –º–µ—Å—Ç–∞—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ü–µ–ª–∏ –≤—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è—Ç—å `user_id = Supabase.instance.client.auth.currentUser?.id` –ø—Ä–∏ INSERT.
- –î–ª—è UPDATE —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ `user_id` –∏ `version`.





# Этап 42 - Правка дизайна
### Задача 42.1: Унификация каркаса и навигации (AppShell)
- Файлы: `lib/screens/app_shell.dart`, (исключить использование) `lib/screens/root_app.dart`, роутинг.
- Что сделать:
  1) Использовать единый каркас навигации на базе GoRouter Shell (`AppShell`).
  2) Везде убрать использование `RootApp` из пользовательских потоков (оставить файл для истории, не подключать в навигации).
  3) Привести нижнюю панель и `DesktopNavBar` к единому набору: Главная / База тренеров / Цель / Профиль (иконки и порядок).
  4) Единый стиль AppBar на внутренних экранах: центрированный заголовок, одинаковый размер/вес шрифта.
- Критерии приёмки: одна система навигации (без `RootApp`), одинаковые иконки/подписи, AppBar выглядит единообразно на MainStreet/Башне/Профиле/Цели/Чатах.

### Задача 42.2: Главная (MainStreetScreen) — читаемость и состояния
- Файлы: `lib/screens/main_street_screen.dart`.
- Что сделать:
  1) Повысить контраст заголовков карточек: вынести заголовок над пиктограммой и/или усилить цвет/тень текста.
  2) Состояние «Скоро»: снизить насыщенность иконки (opacity 0.4–0.5), добавить маленький lock‑чип в правом верхнем углу.
  3) Блок GP справа: гарантировать min высоту клика ≥44 px, привести стиль к башне.
- Критерии приёмки: заголовки читаются на светлом фоне, «Скоро» визуально отличается от активных, GP легко нажимается на мобильных.

### Задача 42.3: Башня (BizTowerScreen) — доступность и единый стиль
- Файлы: `lib/screens/biz_tower_screen.dart` (+ part‑файлы `tower_*`).
- Что сделать:
  1) Гарантировать touch‑targets узлов и чекпоинтов ≥48 px во всех состояниях.
  2) Унифицировать подписи (до 3 строк, межстрочный ≈1.2, одинаковая типографика). Убедиться, что заголовок полностью отображается и не переполняется.
  3) Уточнить прозрачности путей: заблокирован — серый (≈60%), активный — primary, завершённый — зелёный, без резких контрастов.
- Критерии приёмки: узлы/чекпоинты легко нажимаются, подписи единообразны, пути читаемы и не доминируют.

### Задача 42.4: Экран уровня (LevelDetailScreen) — навигация и микроложь
- Файлы: `lib/screens/level_detail_screen.dart`.
- Что сделать:
  1) Учесть безопасные отступы под клавиатуру/индикаторы для нижней панели.
  2) Для Уровня 1: после выполнения условий кнопка «Завершить уровень» отображает текст «Перейти к Цели».
  3) Добавить лёгкий шеймер при переключении между блоками (Intro → Видео → Квиз → …) для визуальной стабильности.
- Критерии приёмки: нижняя панель не перекрывается системой, текст кнопки на уровне 1 корректен, при смене блоков нет «пустых мигов».

### Задача 42.5: Чаты — список и диалог
- Файлы: `lib/screens/leo_chat_screen.dart`, `lib/screens/leo_dialog_screen.dart`.
- Что сделать:
  1) В списке чатов добавить AppBar «База тренеров»; для пустого состояния — CTA‑кнопку «Новый чат с …» в теле экрана.
  2) Удалить/заглушить debug‑prints в `LeoDialogScreen`.
  3) Исторические упоминания бота «alex» заменить на «max» (в комментариях/условных ветках).
  4) Проверить корректные отступы ввода (SafeArea + viewInsets) на iOS/Android.
- Критерии приёмки: список чатов с AppBar и понятным пустым состоянием; в диалоге нет отладочного спама; в коде нет «alex».

### Задача 42.6: Профиль — консистентность с GP и артефакты
- Файлы: `lib/screens/profile_screen.dart`.
- Что сделать:
  1) Добавить мини‑баланс GP в шапку профиля (единый UX с башней/главной).
  2) Пустое состояние артефактов: иконка сундука и дружелюбный текст.
- Критерии приёмки: GP виден в шапке, при отсутствии артефактов отображается понятное пустое состояние.

### Задача 42.7: Цель и чекпоинт — единые заголовки и шеймер автозаполнения
- Файлы: `lib/screens/goal_screen.dart`, `lib/screens/goal_checkpoint_screen.dart`.
- Что сделать:
  1) Унифицировать стили заголовков/отступов секций (без изменения логики).
  2) При «Применить предложение» (embedded‑чат) показывать микро‑шеймер полей до появления текста.
- Критерии приёмки: визуально единые заголовки, автозаполнение выглядит плавно.

### Задача 42.8: Магазин GP — onboarding и ошибки
- Файлы: `lib/screens/gp_store_screen.dart`.
- Что сделать:
  1) Добавить короткий вводный абзац «Что такое GP» с иконкой монеты. Весь контент этой страницы должен помещаться на экран без прокрутки.
  2) Улучшить тексты ошибок/подсказок для кнопки «Проверить покупку» (дружелюбные сценарии сети/валидации).
- Критерии приёмки: новичку понятно назначение GP; ошибки верификации читаемы.

### Задача 42.9: Чистка устаревшего кода
- Файлы: `lib/screens/leo_dialog_screen.dart`, `lib/widgets/floating_chat_bubble.dart`, использование `RootApp`.
- Что сделать:
  1) Заменить упоминания 'alex' → 'max' (комментарии/условия).
  2) Удалить отладочные `print` в `LeoDialogScreen`.
  3) Исключить использование `RootApp` из реальной навигации (оставить как неиспользуемый экран до удаления).
- Критерии приёмки: поиск по коду не находит 'alex' и использования `RootApp` в потоке, отладочных `print` в диалоге нет.

### Задача 42.10: Тестирование/наблюдаемость
- Файлы: без изменения контрактов; акцент на UX‑проверках.
- Что сделать:
  1) Пройти ключевые мобильные сценарии: главная → башня → уровень (видео/квиз) → цель/чекпоинт → чаты → магазин.
  2) Проверить отсутствие overflow и корректные отступы с клавиатурой.
  3) Убедиться в отсутствии новых ошибок Sentry; без вывода PII/JWT.
- Критерии приёмки: ручные сценарии проходят; Sentry без новых ошибок UI; нет визуальных регрессов.

# Этап 43 — Оптимизация системы цели и Макса (интерактивные чекпоинты)
### Задача 43.1: Миграции БД — partial updates и трекинг полей
- Файлы: `supabase/migrations/2025xxxx_431_goal_checkpoint_progress_and_core_goals_partial.sql`.
- Что сделать:
  1) Создать таблицу `goal_checkpoint_progress` с полями: `user_id uuid not null`, `version int not null`, `field_name text not null`, `completed_at timestamptz not null default now()`, `max_interaction_id uuid null`; PK `(user_id, version, field_name)`; индексы по `user_id, version`.
  2) Включить RLS (owner‑only): SELECT/INSERT/UPDATE/DELETE при `auth.uid() = user_id`.
  3) Обновить `core_goals`: гарантировать atomic partial‑updates `version_data` через JSONB‑merge (операторы `||`) и guard‑триггер «редактировать только последнюю версию» (блокировка старых версий и полей `user_id/version`).
  4) Добавить AFTER INSERT/UPDATE триггер на `core_goals`: при изменении `version_data` публиковать событие для Макса (через `pg_net` или безопасный HTTP‑вызов Edge; таймаут короткий, идемпотентность по `(user_id, version, field_name)`).
- Критерии приёмки: политики RLS применены, миграция повторноидемпотентна, Supabase Advisors (security/perf) — без критичных замечаний.

### Задача 43.2: Edge Function `leo-chat` — режим реакции на поле и промпты Макса
- Файлы: `supabase/functions/leo-chat/index.ts` (+ конфиг промптов, если вынесен).
- Что сделать:
  1) Добавить обработку события «goal_field_saved»/`mode: 'goal_comment'`: короткий ответ (2–3 предложения), без списания GP, без истории, с учётом версии и номера поля.
  2) Принять payload от триггера: `{user_id, version, field_name, field_value, all_fields}`; сформировать системный промпт по `goal-system-optimization.md` (тон, структура, локальный контекст), включая ветвления (v1/v2/v3/v4).
  3) Поддержать `recommended_chips` (по версии/шагу) — опционально возвращать массив подсказок.
  4) Гарантировать обратную совместимость существующих режимов `default/quiz/case` и параметра `bot='max'`.
- Критерии приёмки: корректные короткие ответы Макса, отсутствие PII/JWT в логах, контракт `/leo-chat` не ломается, smoke‑тест с фиктивным payload проходит.

### Задача 43.3: Клиент — чекпоинты v2/v3/v4 (шаговая форма + embedded‑чат)
- Файлы: `lib/screens/goal_checkpoint_screen.dart`, `lib/screens/leo_dialog_screen.dart`, `lib/repositories/goals_repository.dart`, `lib/providers/goals_providers.dart`.
- Что сделать:
  1) Разделить экран на `ChatSection` (~60%) и `FormSection` (~40%); автоскролл чата; инпут чата disabled (общение через форму).
  2) Реализовать пошаговую форму: активное поле; заполненные — read‑only с ✓; неактивные — disabled; прогресс‑индикатор «Поле X из Y».
  3) Валидации по версии (v1/v2/v3/v4) согласно `goal-system-optimization.md` (цифры/длины/сравнения/диапазоны/дата).
  4) Частичные сохранения: `GoalsRepository.upsertGoalField(version, fieldName, value)` → JSONB merge в `core_goals.version_data` + запись в `goal_checkpoint_progress`; после ack активировать следующее поле и сфокусировать его.
  5) Встроенный чат Макса: `LeoDialogScreen(embedded: true, bot: 'max', inputDisabled: true, recommendedChips: [...])`; сообщение реакций приходит автоматически от Edge.
- Критерии приёмки: линтеры чистые; переход по полям без рывков; офлайн‑фолбэк сохраняет ввод локально и доотправляет; реакции Макса отображаются без списания GP.

### Задача 43.4: Клиент — страница «Цель» (цитата, мини‑дашборд, путь)
- Файлы: `lib/screens/goal_screen.dart`, `lib/repositories/goals_repository.dart`, `lib/providers/goals_providers.dart`.
- Что сделать:
  1) Добавить collapsible‑цитату (автосворачивание через 5с, клик — разворот/сворачивание).
  2) Мини‑дашборд из 3 карточек: прогресс %, текущая неделя/фокус, streak чек‑инов.
  3) «Путь к цели» как аккордеон: текущая неделя развернута, прошлые — кратко, будущие — заблокированы.
  4) Обновить чек‑ин до 3 полей: `week_result` (≤100), `metric_value` (динамика из v2), `used_tools` (динамически из пройденных уровней); после сохранения — запуск короткой реакции Макса (без списания GP).
- Критерии приёмки: без overflow на мобильных, читабельные состояния, офлайн‑кеш и SWR работают, реакции Макса приходят после чек‑ина.

### Задача 43.5: Провайдеры и репозиторий целей — partial/SWR/Realtime
- Файлы: `lib/repositories/goals_repository.dart`, `lib/providers/goals_providers.dart`.
- Что сделать:
  1) Добавить `upsertGoalField(version, fieldName, value)` и `getGoalProgress(version)` (собирает заполненные поля из `goal_checkpoint_progress` + `core_goals.version_data`).
  2) Инвалидация `goalLatest/goalVersions` после завершения версии; `sprintProvider` — после чек‑ина.
  3) Подписка/поллинг на обновления чата Макса для активного чекпоинта (embedded‑режим), безопасные ретраи.
- Критерии приёмки: отсутствие гонок состояния, корректная инвалидация и обновление UI; линтеры без ошибок.

### Задача 43.6: Безопасность, GP и тесты
- Файлы: миграции, `leo-chat`, репозиторий/экраны, тесты в `test/**`.
- Что сделать:
  1) Подтвердить RLS на `goal_checkpoint_progress`; убедиться, что Edge/триггеры не логируют PII/JWT.
  2) Гарантировать, что реакции Макса на сохранение поля/чек‑ина не списывают GP; пользовательские сообщения остаются платными (1 GP).
  3) Тесты: unit (репозиторий partial/прогресс, валидации), widget (чекпоинт шаги + чат, GoalScreen), интеграционный сценарий v1→v4 + недельный чек‑ин (+ smoke для Edge реакции).
- Критерии приёмки: тесты проходят локально/CI; Sentry без новых ошибок; сценарии устойчивы к офлайн/ретраям.

### Задача 43.7: Настройка промптов и документация
- Файлы: `supabase/functions/leo-chat/index.ts` (секция промптов Макса), `docs/goal-system-optimization.md`, `docs/status.md`.
- Что сделать:
  1) Имплементировать системные промпты Макса по версиям/шагам (тон, структура ответа, локальный контекст) из `goal-system-optimization.md`.
  2) Описать контракт события «goal_field_saved» и пример payload в документации; добавить заметку об идемпотентности и ограничении длины ответов.
  3) Добавить запись в `docs/status.md` «Задача 43: …» после завершения ключевых подзадач.
- Критерии приёмки: промпты соответствуют ТЗ; документация обновлена; обратная совместимость `/leo-chat` сохранена.

### Задача 43.8: Чекпоинт — пошаговый UX и прогресс «Поле X из Y»
- Файлы: `lib/screens/goal_checkpoint_screen.dart`, `lib/widgets/goal_version_form.dart`, `lib/providers/goals_providers.dart`.
- Что сделать:
  1) Ввести «активное поле»: рендер одного редактируемого поля, прошлые — read‑only с ✓, будущие — disabled.
  2) После `upsertGoalField` и ack от сервера активировать следующее поле, авто‑фокус и плавный скролл, короткий SnackBar.
  3) Подключить `goalProgressProvider(version)` для расчёта собранных полей и текущего шага; вывести индикатор «Поле X из Y» и сохранять текущий шаг (в `goal_checkpoint_progress`) для восстановления при повторном входе.
- Критерии приёмки: последовательное заполнение без «перескоков», корректный и устойчивый к перезапуску индикатор шага, восстановление шага при повторном входе, офлайн‑сохранение с последующей доотправкой.

### Задача 43.9: Поля и валидации v1–v4 (без DDL)
- Файлы: `lib/widgets/goal_version_form.dart`, `lib/screens/goal_checkpoint_screen.dart`.
- Что сделать:
  1) Перейти на ключи полей: v1 (`concrete_result/main_pain/first_action`), v2 (`metric_type/metric_current/metric_target`), v3 (`week1_focus..week4_focus`), v4 (`readiness_score/start_date/accountability_person/first_three_days`).
  2) Добавить валидации: v1 (длина+цифра/глагол), v2 (dropdown, >0, target>current + вывод % роста в UI), v3 (каждое ≥10), v4 (slider 1–10, дата в [сегодня..+7], опциональный `accountability_person`).
  3) Обратная совместимость чтения старых ключей (только для отображения) и аккуратное отображение смешанных данных у существующих пользователей (без разрушения прошлых версий).
- Критерии приёмки: валидации соответствуют ТЗ; проценты роста показываются корректно; старые данные отображаются без потерь и конфликтов.

### Задача 43.10: Weekly check‑in — упрощение и реакция Макса
- Файлы: `lib/screens/goal/widgets/checkin_form.dart`, `lib/screens/goal/widgets/sprint_section.dart`, `supabase/migrations/2025xxxx_431_weekly_checkin_react.sql`, `supabase/functions/leo-chat/index.ts`.
- Что сделать:
  1) Упростить форму до 3 полей: `week_result` (≤100), `metric_value` (с подписью из v2 и динамикой «было→стало (±%)`), `used_tools` (мультивыбор из пройденных уровней через провайдер опций).
  2) AFTER INSERT/UPDATE на `weekly_progress`: безопасный HTTP в `/leo-chat` в режиме `mode='weekly_checkin'` с кратким ответом Макса; без RAG/истории/GP, с Bearer `CRON_SECRET` и идемпотентностью по `(user_id, week_number)`.
  3) Отобразить `recommended_chips` после сохранения чек‑ина (кнопки быстрых ответов в полноэкранном чате Макса), заполняют поле ввода без авто‑отправки.
- Критерии приёмки: форма короче и понятнее; после сохранения приходит короткая реакция Макса; без списания GP и без утечки PII; повторные события не приводят к дублирующим ответам.

### Задача 43.11: GoalScreen — аккордеон «Путь к цели» и состояния версий
- Файлы: `lib/screens/goal_screen.dart`, `lib/screens/goal/controller/goal_screen_controller.dart`.
- Что сделать:
  1) «Путь к цели» как аккордеон: текущая неделя раскрыта, прошлые — краткие карточки (`week_result`), будущие — заблокированы.
  2) Определять текущую неделю по `v4.start_date`; при отсутствии — подсказка «заполните v4».
  3) Состояния v1–v4: прогресс 25/50/75/100% и понятные подсказки «что дальше».
- Критерии приёмки: без overflow, корректные блокировки будущих недель, понятный прогресс по версиям.

### Задача 43.12: Recommended chips — сквозная интеграция
- Файлы: `lib/screens/leo_dialog_screen.dart`, `lib/screens/goal_checkpoint_screen.dart`, `lib/screens/goal_screen.dart`.
- Что сделать:
  1) В embedded‑чате чекпоинта рендерить `recommended_chips` (если пришли) и подставлять клик в активное поле (без авто‑отправки).
  2) На странице «Цель» показывать чипы после чек‑ина (полноэкранный чат Макса) для быстрого старта диалога; чипы приходят из ответа `weekly_checkin`.
- Критерии приёмки: чипы видны и работают; нет регрессий чата.

### Задача 43.13: Провайдеры — инструменты недели и прогресс
- Файлы: `lib/providers/goals_providers.dart`, `lib/repositories/goals_repository.dart` (при необходимости helper).
- Что сделать:
  1) `usedToolsOptionsProvider`: собрать список инструментов из завершённых уровней/артефактов для `used_tools` в чек‑ине.
  2) Расширить `goalProgressProvider(version)` полями `totalFields/nextField`, чтобы упростить прогресс‑индикатор и активацию следующего поля.
- Критерии приёмке: данные приходят стабильно, интеграция с формой чекпоинта корректна.
  3) Ввести `metricLabelProvider` (динамический label метрики из v2) для подписи поля `metric_value` в чек‑ине.
- Критерии приёмке: данные приходят стабильно, интеграция с формой чекпоинта корректна.
- Критерии приёмки: данные приходят стабильно, интеграция с формой чекпоинта корректна.

### Задача 43.14: Edge/безопасность/наблюдаемость для weekly‑reaction
- Файлы: `supabase/functions/leo-chat/index.ts`, миграция триггера на `weekly_progress`.
- Что сделать:
  1) В режиме реакции на чек‑ин ограничить токены, отключить RAG/историю/GP; проверить Bearer `CRON_SECRET`.
  2) В триггере использовать `pg_net` с коротким timeout и идемпотентностью (ключ по `user_id,week_number`).
  3) Логи без PII/JWT, дружелюбные ошибки; экспоненциальный retry только на клиенте при показе чата; добавить Sentry‑breadcrumbs на стороне Edge (без PII).
- Критерии приёмки: запросы стабильны, в логах нет PII/JWT, advisors без критичных замечаний.

### Задача 43.15: Тесты и UX‑полировка
- Файлы: `test/**`.
- Что сделать:
  1) Unit: валидации v1–v4 (позитив/негатив), расчёт «следующего поля».
  2) Widget: чекпоинт (прогресс‑индикатор, последовательность полей, чипы), GoalScreen (аккордеон недель).
  3) Интеграция: «сохранение поля → RPC → реакция Макса», «сохранение чек‑ина → реакция Макса».
- Критерии приёмки: тесты зелёные; Sentry без новых ошибок; UX без рывков/overflow.

### Задача 43.16: Совместимость данных и адаптер старых ключей
- Файлы: `lib/widgets/goal_version_form.dart`, `lib/repositories/goals_repository.dart` (адаптер чтения), документация.
- Что сделать:
  1) Обеспечить отображение старых ключей версий (до перехода на новые названия) в UI без разрушения данных.
  2) Адаптировать отображение weekly (если структура ещё старая) к 3‑полевой модели (read‑only маппинг).
  3) Подготовить заметку о совместимости и сценариях миграции для реальных данных.
- Критерии приёмки: существующие пользователи не теряют данные, UI корректно читает старые записи.

### Задача 43.17: Оффлайн‑очередь и надёжные ретраи сохранений
- Файлы: `lib/repositories/goals_repository.dart`, провайдеры/сервис очереди.
- Что сделать:
  1) Добавить очередь для частичных сохранений полей и weekly с дебаунсом (200 мс) и экспоненциальными ретраями.
  2) Разрешение конфликтов: при расхождении сервера и локали — приоритет серверного ack, локальные изменения повторно применяются.
  3) Метрики/логирование: Sentry‑breadcrumbs событий сохранений (без PII).
- Критерии приёмки: сохранения не теряются при оффлайне/флаппинге сети, пользователь видит актуальное состояние.

### Задача 43.18: Телеметрия и наблюдаемость
- Файлы: экраны/виджеты цели, `LeoDialogScreen`, репозиторий; Sentry конфигурация.
- Что сделать:
  1) Добавить breadcrumbs: `goal_field_saved`, `goal_next_field_activated`, `weekly_checkin_saved`, `weekly_reaction_received`, `goal_chips_clicked`.
  2) Отлавливать и логировать ошибки валидаций/сетевых вызовов без PII.
- Критерии приёмки: в Sentry видно ключевые события цели и чек‑инов; нет утечки PII/JWT.

### Задача 43.19: Производительность и лимиты токенов (Edge)
- Файлы: `supabase/functions/leo-chat/index.ts`.
- Что сделать:
  1) Ограничить `max_tokens` и длину ответов в режимах `goal_comment` и `weekly_checkin` (5-6 предложений).
  2) Юнит‑проверки промптов и обрезки ответов; таймауты HTTP.
- Критерии приёмки: быстрые ответы Макса, отсутствие перерасхода токенов.

### Задача 43.20: Документация и runbook
- Файлы: `docs/goal-system-optimization.md`, `docs/status.md`.
- Что сделать:
  1) Задокументировать режим `weekly_checkin` (headers/body/response), примеры payload/ответа, идемпотентность.
  2) Добавить запись в `docs/status.md` после завершения ключевых задач 43.8–43.20.
- Критерии приёмки: документация полная и актуальная; команда понимает контракт и поведение.

### Задача 43.21: Фича‑флаги и безопасный роллбек
- Файлы: конфигурация клиента/Edge.
- Что сделать:
  1) Ввести флаги `kEnableWeeklyReaction` и `kEnableGoalChips` для быстрого отключения реакций/чипов.
  2) На Edge — ранний выход при выключенных флагах.
- Критерии приёмки: можно безопасно отключить реакции/чипы без релиза клиента.

### Задача 43.22: Advisors/безопасность после DDL
- Файлы: миграции Supabase.
- Что сделать:
  1) Перепроверить Supabase Advisors (security/performance) после добавления триггеров и политик.
  2) Убедиться в `EXECUTE` только для `authenticated`, deny для `anon` по новым RPC/триггерам.
- Критерии приёмки: advisors без критичных замечаний; RLS/EXECUTE настроены корректно.


### Задача 43.23: Клиентские «тонкие реакции» Макса вместо Edge
- Файлы: `lib/screens/goal_checkpoint_screen.dart`, `lib/screens/goal/widgets/sprint_section.dart`, `lib/screens/leo_dialog_screen.dart`, `lib/services/leo_service.dart` (использование существующего API).
- Что сделать:
  1) После успешного сохранения поля версии (чекпоинт) и чек-ина недели вызывать `/leo-chat` с `bot='max'` в коротком режиме (аналог `mode='quiz'`), без истории/RAG/GP.
  2) Передавать минимальный контекст (версия/поле/значение/все поля или week_result/metric_value/used_tools) без PII.
  3) Ответ отрисовывать в embedded/полноэкранном чате; `recommended_chips` формировать локально (fallback).
- Критерии приёмки: стабильный 200 OK, нет зависимостей от CRON_SECRET/pg_net, нет списаний GP, чипы видны.

### Задача 43.24: UX‑защита «редактировать можно только последнюю версию»
- Файлы: `lib/screens/goal_checkpoint_screen.dart`, `lib/widgets/goal_version_form.dart`.
- Что сделать:
  1) До вызова `upsert_goal_field` проверять, что выбранная версия == latest; иначе блокировать ввод и кнопку.
  2) Показать баннер/диалог: «Редактировать можно только текущую версию vN» с CTA перехода.
- Критерии приёмки: ошибка 400 "Only latest version can be edited" не воспроизводится пользователем; понятная подсказка.

### Задача 43.25: Создание «оболочки» новой версии (latest+1)
- Файлы: `lib/screens/goal_checkpoint_screen.dart`, `lib/repositories/goals_repository.dart` (использование существующих методов).
- Что сделать:
  1) При первом входе в чекпоинт следующей версии или по клику «Перейти к форме» создавать запись версии vN (shell), чтобы partial‑сохранения не падали.
- Критерии приёмки: переход к vN+1 не даёт 400; первый «Сохранить шаг» проходит.

### Задача 43.26: v2 «Метрики» по концепции
- Файлы: `lib/widgets/goal_version_form.dart`.
- Что сделать:
  1) UI на ключах `metric_type` (dropdown), `metric_current`, `metric_target`.
  2) Показ % роста с подсветкой (низкий/реалистичный/слишком высокий).
  3) Совместимость чтения старых ключей (metric_name/from/to); `financial_goal` не ломаем (опционально, ниже формы).
- Критерии приёмки: dropdown работает, % роста считается и виден, валидации совпадают с ТЗ.

### Задача 43.27: v4 «Финал» — readiness slider 1–10
- Файлы: `lib/widgets/goal_version_form.dart`.
- Что сделать:
  1) Заменить switch «готов» на слайдер 1–10; хранить число в `readiness_score`.
  2) Маппинг старого boolean → 5/8 при отображении.
- Критерии приёмки: слайдер, текстовые подсказки по значению, валидации даты сохранены.

### Задача 43.28: Weekly check‑in — 3 поля и реакция Макса
- Файлы: `lib/screens/goal/widgets/sprint_section.dart`, `lib/providers/goals_providers.dart`.
- Что сделать:
  1) Упростить форму до `week_result` (≤100), `metric_value` (label из v2), `used_tools` (multi‑select из провайдера).
  2) После сохранения — «тонкая реакция» Макса (см. 43.23).
  3) Совместимость: маппить в текущие колонки без DDL.
- Критерии приёмки: форма короче, реакция отображается, чипы присутствуют.

### Задача 43.29: Единый генератор recommended_chips (клиент)
- Файлы: `lib/screens/goal_checkpoint_screen.dart`, `lib/screens/leo_dialog_screen.dart` (вызов хелпера).
- Что сделать: общий хелпер для формирования чипов по версии/активному полю/чек‑ину (fallback, если сервер не прислал).
- Критерии приёмки: чипы консистентны в чекпоинте и на странице «Цель».

### Задача 43.30: Подсказки/блокировки для проблемных сценариев
- Файлы: `lib/screens/goal_checkpoint_screen.dart`, `lib/screens/goal_screen.dart`.
- Что сделать: тексты и UX для случаев: не‑latest версия, не завершён предыдущий узел, нет v2 для weekly label, нет v4 для start_date, target ≤ current, короткий ввод/некорректное число.
- Критерии приёмки: пользователь всегда получает понятную причину и следующий шаг.

### Задача 43.31: Preflight‑проверки при открытии чекпоинта
- Файлы: `lib/screens/goal_checkpoint_screen.dart`.
- Что сделать: гейтинг формы по завершённости предыдущего узла и доступности версии; если недоступно — блок и подсказка (см. 43.30).
- Критерии приёмки: нет «тихих» блокировок, только явные подсказки.

### Задача 43.32: CTA «Что дальше» на странице «Цель»
- Файлы: `lib/screens/goal/widgets/goal_compact_card.dart` (или соответствующий блок на странице).
- Что сделать: показывать следующий рекомендуемый шаг (открыть нужный чекпоинт/неделю) с прямым переходом.
- Критерии приёмки: CTA ведёт по маршруту без ошибок.

### Задача 43.33: Индикация % роста в v2
- Файлы: `lib/widgets/goal_version_form.dart`.
- Что сделать: компактный индикатор процента и оттенки статуса (низкий/реалистичный/высокий).
- Критерии приёмки: корректный расчёт, UI не «прыгает».

### Задача 43.34: Тесты реакций/гейтинга/подсказок
- Файлы: `test/**`.
- Что сделать: unit (следующее поле, проценты v2, latest‑only), widget (чекпоинт: подсказки/чипы; GoalScreen: CTA), интеграция (сохранение шага/weekly → реакция Макса клиентом).
- Критерии приёмки: тесты зелёные в CI.

### Задача 43.35: Телеметрия для клиентских реакций
- Файлы: `lib/screens/goal_checkpoint_screen.dart`, `lib/screens/goal_screen.dart`, `lib/services/leo_service.dart` (вызовы), Sentry конфиг.
- Что сделать: breadcrumbs `goal_edit_blocked_non_latest`, `goal_reaction_requested_client`, `goal_recommended_chip_clicked`, `weekly_reaction_requested_client`.
- Критерии приёмки: события видны, без PII.

### Задача 43.36: Фича‑флаги клиентских реакций
- Файлы: `lib/utils/constant.dart` (или конфиг), места вызовов.
- Что сделать: `kEnableClientGoalReactions`, `kEnableClientWeeklyReaction` для быстрого отключения.
- Критерии приёмки: переключение без серверных изменений.

### Задача 43.37: Документация
- Файлы: `docs/goal-system-optimization.md`, `docs/status.md`.
- Что сделать: описать «тонкий» клиентский режим реакций, отказ от CRON_SECRET/webhook; перечислить подсказки/гейтинг и сценарии.
- Критерии приёмки: документы обновлены; команда понимает поведение.


Fix - не выполнено:
Коротко по пунктам:
1) Дать Максу доступ к данным пользователя
Рекомендуемый путь: не давать Edge доступ к БД (без service role), а формировать минимальный контекст на клиенте и передавать его в payload:
имя, goal_name/v1‑v4 кратко, номер недели, metric_label/values, used_tools (без email/PII).
Хешировать user_id (или передавать только chat_id/goal_id), не логировать JWT.
Плюсы: безопасность, предсказуемость, отсутствие RLS/ролей на Edge, стабильность.
2) Списывать GP за авто‑реакции Макса и снять лимиты токенов
Не рекомендовано: авто‑реакции запускаются «по событию», списания без явного действия пользователя ухудшат UX (в т.ч. оффлайн/ретраи → повторные списания).
Если принципиально — делаем опцией:
фича‑флаг kChargeGoalReactions, явный баннер «Реакция Макса — 1 GP», дневной лимит и строгая идемпотентность (idempotency_key = user+version+field/ user+week).
max_tokens оставляем коротким для быстрых ответов; «стандартные» лимиты повысят задержку и стоимость без пользы для коротких реакций.
3) Мгновенные реакции/чипы без CRON_SECRET/Bearer
Да, альтернативы без триггеров/cron:
Клиентский вызов сразу после успешного сохранения: UI сохраняет поле → по ack вызывает /leo-chat с mode='goal_comment'|'weekly_checkin' под JWT пользователя. На Edge — «тонкая» ветка: без БД/RAG/GP, ранний выход по флагу.
Локальный fallback: если Edge недоступен — показываем короткую «локальную» подсказку и генерируем recommended chips на клиенте (эвристики по версии/шагу).
Плюсы: отсутствие требований к CRON_SECRET/вебхукам, минимальная поверхность риска, мгновенный UX.

# Этап 44 - Библиотека
### Задача 44.1: Миграция Библиотеки (MVP)
- Файлы: `docs/library-migration-sql.sql` (источник), `supabase/migrations/2025xxxx_441_library_init.sql` (копия для применения).
- Что сделать:
  1) Применить миграцию через supabase-mcp: создать таблицы `library_courses`, `library_grants`, `library_accelerators`, `library_favorites`, индексы и RLS-политики (SELECT для всех на контент, owner-only на избранное).
  2) Проверить Advisors (security/perf) и зафиксировать отсутствие критичных замечаний.
- Критерии приёмки: схемы и политики созданы; выборки по категориям и вставка/удаление в избранное выполняются для аутентифицированного пользователя; Advisors без критичных ошибок.

### Задача 44.2: Hardening миграции (минимальные улучшения)
- Файлы: `supabase/migrations/2025xxxx_442_library_hardening.sql`.
- Что сделать (добавочно, без ломающих изменений):
  1) Добавить триггеры `updated_at` (BEFORE UPDATE set new.updated_at=now()) для `library_courses/grants/accelerators`.
  2) Добавить FK: `library_favorites.user_id` → `auth.users(id)` ON DELETE CASCADE.
  3) Добавить CHECK: `resource_type IN ('course','grant','accelerator')`.
  4) Добавить составные индексы для сортировок: `(category, is_active, sort_order)` на три контентные таблицы.
  5) Перепроверить Advisors (security/perf).
- Критерии приёмки: миграция идемпотентна, схемы обновлены, индексы задействуются в планах запросов.

### Задача 44.3: Роутинг и доступ
- Файлы: `lib/routing/app_router.dart`.
- Что сделать:
  1) Добавить маршрут `/library` (внутри ShellRoute) с экраном «Библиотека».
  2) Доступ — только для аутентифицированных (используется существующий redirect на /login; отдельный гейтинг не требуется).
- Критерии приёмки: при неавторизованном входе на `/library` происходит редирект на `/login`; SentryNavigatorObserver остаётся подключён.

### Задача 44.4: Главная — активация карточки «Библиотека»
- Файлы: `lib/screens/main_street_screen.dart`.
- Что сделать:
  1) Перевести карточку «Библиотека» из состояния `soon` в `active` и повесить `onTap: context.go('/library')`.
  2) Сохранить существующий стиль карточки и поведение ошибок (SnackBar + Sentry) по аналогии с «Башня БизЛевел»/«База тренеров».
- Критерии приёмки: тап по «Библиотека» открывает экран `/library` без ошибок; тест `street_screen_test` обновлён на новый кейс (smoke).

### Задача 44.5: Репозиторий и провайдеры (SWR + офлайн)
- Файлы: `lib/repositories/library_repository.dart`, `lib/providers/library_providers.dart`.
- Что сделать:
  1) Создать `LibraryRepository` по паттерну Levels/Lessons/Goals (Hive SWR-кеш, ретраи, Sentry.captureException).
  2) Методы: `fetchCourses({category})`, `fetchGrants({category})`, `fetchAccelerators({category})`, `toggleFavorite(resourceType, resourceId)`, `fetchFavorites()`.
  3) Провайдеры: `libraryRepositoryProvider`, `coursesProvider(category)`, `grantsProvider(category)`, `acceleratorsProvider(category)`, `favoritesProvider`.
- Критерии приёмки: офлайн-кеширование работает; ошибки сети показываются дружелюбно; логи Sentry без PII.

### Задача 44.6: Экран «Библиотека» (хаб разделов)
- Файлы: `lib/screens/library/library_screen.dart`.
- Что сделать:
  1) Экран-хаб с заголовком и тремя карточками разделов: «Курсы», «Гранты и поддержка», «Акселераторы» + вкладка «Избранное».
  2) По возможности переиспользовать готовые виджеты (например, `StatCard`/стили карточек из проекта); новые создавать только при необходимости.
  3) Навигация в подразделы (в рамках `/library`, либо с внутренними табами/вкладками — без добавления новых роутов, чтобы минимизировать изменения).
- Критерии приёмки: соответствие концепции; адаптивность без overflow на мобильных и web.

### Задача 44.7: Подразделы «Курсы»/«Гранты»/«Акселераторы»
- Файлы: `lib/screens/library/courses_screen.dart`, `grants_screen.dart`, `accelerators_screen.dart`.
- Что сделать:
  1) Список категорий (грид карточек) → список элементов; карточки сворачиваются/разворачиваются; кнопка «↗» открывает внешнюю ссылку через `url_launcher`.
  2) Кнопка ⭐ избранного на карточке (переключение через репозиторий/провайдер, owner-only RLS соблюдается).
  3) Переиспользовать существующие базовые карточки/темы; собственные виджеты — только если необходимо.
- Критерии приёмки: фильтрация по категориям, сортировка по `sort_order`, стабильный UX и состояния загрузки/ошибки.

### Задача 44.8: «Избранное»
- Файлы: `lib/screens/library/favorites_screen.dart` (или вкладка на `LibraryScreen`).
- Что сделать:
  1) Отображение сохранённых карточек, группировка по типам (course/grant/accelerator).
  2) Удаление из избранного, счётчик.
- Критерии приёмки: операции избранного работают только для аутентифицированных; состояния (пусто/ошибка) корректны.

### Задача 44.9: Тесты
- Файлы: `test/screens/library/*_test.dart`, `test/repositories/library_repository_test.dart`.
- Что сделать:
  1) Widget-smoke: открытие `/library` с главной, переход в разделы, рендер списка.
  2) Unit: кэш SWR и `toggleFavorite` (mock SupabaseClient/Hive).
  3) Актуализация `street_screen_test.dart` под активную карточку «Библиотека».
- Критерии приёмки: тесты проходят локально/CI; линтеры без новых ошибок.

### Задача 44.10: Наблюдаемость, офлайн и доступность
- Файлы: экраны/репозиторий библиотеки.
- Что сделать:
  1) Дружелюбные SnackBar при ошибках, ретраи сети, офлайн-кеш из репозитория.
  2) Sentry.captureException на критических путях; без логирования PII/JWT.
  3) Semantics(label, button) на интерактивах; минимальные размеры ≥44 px.
- Критерии приёмки: отсутствуют RenderFlex overflow; ошибки логируются в Sentry без утечек.

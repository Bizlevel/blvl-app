# Этап 32: Дизайн и UX
 
### Задача 32.1: Глобальная компоновка страницы «Цель» (каркас и ритм)
- Цель: сделать страницу легче для сканирования на web/mobile за счёт ограничителя ширины, единого каркасного стиля карточек и ровного вертикального ритма. Логику и провайдеры не менять.
- Файлы: `lib/screens/goal_screen.dart` (основной), (опц.) `lib/theme/color.dart` (добавить мягкие нейтрали/градиент при необходимости, без BC‑лома).
- Что сделать:
  1) Обернуть контент `GoalScreen` в `Center` + `ConstrainedBox(maxWidth: 840)` для web/desktop; на мобильном поведение без изменений.
  2) Привести секции к единому каркасу (существующий контейнер с белым фоном/тенью): мотивация, версии, форма версии, «Путь к цели» — одинаковые отступы 16–24 px.
  3) В верхнем заголовке: «Цель» + серый подзаголовок «Сформулируйте цель и пройдите 4 версии». Справа небольшой статус‑чип «Версия X из 4» и «Доступно до vY» (на основе текущего уровня).
  4) Заменить подпись «Автосохранение каждые 200 мс» на чип режима: «Режим: Просмотр/Редактирование» (цвет нейтральный/первичный). Автосохранение не включать.
- Критерии приёмки:
  - На экранах ≥1024 px ширина контента визуально ограничена (≤ 840 px), без горизонтальных переполнений.
  - Все секции выглядят консистентно: одинаковая тень, скругление, внутренние отступы; вертикальные интервалы ровные.
  - Текст про автосохранение исчез, отображается чип режима.

### Задача 32.2: Навигация версий (v1–v4) со статусами
- Цель: повысить понятность и мотивацию при переключении версий, сохранив текущую логику гейтинга.
- Файлы: `lib/screens/goal_screen.dart`.
- Что сделать:
  1) Обновить лейблы: `v1 Семя`, `v2 Метрики`, `v3 SMART`, `v4 Финал` (русские подписи).
  2) Показать статусы: текущая — подсветка; завершённые — чек ✓; недоступные — иконка замка и `tooltip` «Откроется после Уровня N».
  3) Не менять условия доступности/создания следующей версии — только визуальная индикация.
- Критерии приёмки:
  - Пользователь видит понятные подписи и статусы версий; при ховере/табе на заблокированную показывает подсказку.
  - Переключение и гейтинг работают как прежде; сохранение форм не изменилось.

### Задача 32.3: Формы v1–v4 — читаемость и дружелюбные подсказки
- Цель: улучшить сканируемость и снизить когнитивную нагрузку в формах версий без изменения полей/валидаций.
- Файлы: `lib/screens/goal_screen.dart` (только вёрстка и тексты).
- Что сделать:
  1) Сгруппировать поля по смыслу под мини‑подзаголовками («Почему сейчас», «Препятствие», «Метрика»). Реализовать разметкой внутри файла, без выноса новых публичных виджетов.
  2) Уточнить `hint`‑тексты (1 строка, тёплый тон, пример). Поля чисел (v2) по возможности настроить на числовую клавиатуру (если `CustomTextBox` поддерживает `keyboardType`).
  3) В v4 переключатель «Готов к реализации» оформить как `Switch` с подписью справа; поведение `_commitment` оставить прежним.
  4) Кнопки: primary «Сохранить», справа чип «Просмотр/Редактирование»; иконка «Редактировать» остаётся в заголовке блока.
- Критерии приёмки:
  - Поля логически сгруппированы; подсказки понятные, без длинных текстов.
  - На мобильном числовые поля открывают цифровую клавиатуру (где поддерживается компонентом).
  - После «Сохранить» режим возвращается в «Просмотр» (как сейчас); логика валидаций/запросов не менялась.

### Задача 32.4: «Путь к цели» — визуальный прогресс спринта
- Цель: сделать блок спринтов наглядным (7 дней, текущий спринт), не меняя текущих данных и API.
- Файлы: `lib/screens/goal_screen.dart`.
- Что сделать:
  1) Заголовок: «Путь к цели • Спринт S» + лёгкая плашка «7 дней».
  2) Мини‑timeline из 7 точек (вертикально/горизонтально в зависимости от ширины) с подписями «День n»; текущий день можно отображать нейтрально (без вычислений по дате, чтобы не трогать логику).
  3) Форму чек‑ина визуально облегчить: на desktop — две колонки, на mobile — одна; «Проверки недели» (чипы) сгруппировать в отдельный подпункт.
  4) После сохранения чек‑ина показать вторичную кнопку‑CTA «Обсудить с Максом» (выполняет то же действие, что нажатие плавающего баббла).
- Критерии приёмки:
  - Есть 7‑точечная шкала дней спринта; верстка не ломается на web/mobile.
  - При сохранении чек‑ина отображается CTA к чату; существующая логика сохранения не меняется.

### Задача 32.5: Блок «Мотивация» — аватар Макса, градиент, скелетон
- Цель: сделать мотивационный блок вдохновляющим и компактным, с аккуратной загрузкой/ошибками.
- Файлы: `lib/screens/goal_screen.dart` (вёрстка), ассеты уже есть (`assets/images/avatars/avatar_*.png`).
- Что сделать:
  1) Левая колонка: `CircleAvatar(Max)`; правая — цитата (2–3 строки) + автор; фон — мягкий градиент/подсветка из темы.
  2) В состоянии загрузки — скелетон (серые плашки); при ошибке — дружелюбный текст «Сегодня работаем по плану — без цитаты».
- Критерии приёмки:
  - Визуально блок с аватаром и аккуратным фоном; загрузка и ошибка выглядят ненавязчиво.
  - Длина цитаты не приводит к переполнению/обрезке на мобильном.

### Задача 32.6: Доступность, состояния и типографика
- Цель: унифицировать доступность (минимальные размеры интерактивов), пустые/ошибочные состояния и типографику desktop.
- Файлы: `lib/screens/goal_screen.dart`, (опц.) `lib/theme/color.dart`.
- Что сделать:
  1) Минимальная высота кликабельных элементов ≥ 44 px; увеличить `title` на desktop на +1 pt.
  2) Пустые состояния: «Путь к цели доступен после v4», «Цитата недоступна» — с иконкой и коротким дружелюбным текстом.
  3) Локализация/копирайтинг: выровнять терминологию («цель», «спринт», «версия») и тон сообщений.
- Критерии приёмки:
  - Интерактивы соответствуют минимальным размерам; тексты унифицированы, переполнений нет.
  - Нет новых предупреждений анализатора/линутера, существующие тесты не ломаются.

### Задача 32.7: Наблюдаемость и регресс‑чек
- Цель: убедиться, что визуальные правки не вносят регрессии и не создают UI‑исключений.
- Файлы/инструменты: `lib/screens/goal_screen.dart`; sentry‑mcp (чтение логов за последние 24 ч), локальные тесты.
- Что сделать:
  1) Прогнать `flutter analyze` и существующие тесты (`flutter test`).
  2) Через sentry‑mcp убедиться в отсутствии свежих RenderFlex overflow/Layout ошибок, связанных с `GoalScreen`.
  3) На web проверить ширину контейнера и отсутствие горизонтального скролла.
- Критерии приёмки:
  - Sentry не показывает новые критические UI‑ошибки, тесты и анализ проходят.
  - Визуальные изменения соответствуют макету из задач 32.1–32.6, логика данных/запросов неизменна.

### Задача 32.8: Плавающий баббл «Новый чат с Максом» — смещение вниз
- Цель: баббл не должен перекрывать контент и находиться в правом нижнем углу.
- Файлы: `lib/screens/goal_screen.dart`.
- Что сделать:
  1) В `Positioned` для `FloatingChatBubble` установить `right: 16`, `bottom: 16` (без `+ kBottomNavigationBarHeight`).
  2) Проверить на iOS/Android/Web — баббл не перекрывает кнопки сохранения и поля.
- Критерии приёмки:
  - Баббл всегда виден и не перекрывает основной контент на мобильном и web.

### Задача 32.9: Заголовок экрана «Цель» — только центровка, без подзаголовков
- Цель: упростить шапку согласно макету.
- Файлы: `lib/screens/goal_screen.dart`.
- Что сделать:
  1) В `AppBar` оставить только заголовок «Цель», выровнять по центру (`centerTitle: true`).
  2) Удалить подзаголовок «Сформулируйте цель и пройдите 4 версии» и правый чип «Версия X из 4»/индикатор доступности.
- Критерии приёмки:
  - В шапке отображается только слово «Цель» по центру.

### Задача 32.10: Блок «Кристаллизация цели» — заголовок и версия‑чипы
- Цель: убрать «vN» из лейблов версий и устранить overflow на мобильном.
- Файлы: `lib/screens/goal_screen.dart`.
- Что сделать:
  1) Заголовок блока: «Кристаллизация цели» (без «vN»).
  2) Перечень версий отрисовывать под заголовком с лейблами: «1. Семя», «2. Метрики», «3. SMART», «4. Финал».
  3) Заменить `Row` на `Wrap` (`alignment: WrapAlignment.center`, `spacing: 8`, `runSpacing: 8`) для предотвращения «right overflow» на мобильном.
- Критерии приёмки:
  - На узких экранах нет жёлто‑чёрной полосы overflow; лейблы версий читаемы и центрированы.

### Задача 32.11: Блок "Кристаллизация цели" - Поля — placeholder вместо подписи под заголовком
- Цель: сократить уровень вложенности подписей и привести к единому виду как в «Путь к цели».
- Файлы: `lib/screens/goal_screen.dart`, (опц.) `lib/widgets/custom_textfield.dart`.
- Что сделать:
  1) Для v1 под заголовком группы «Основная цель» сразу показывать `CustomTextBox` с `hint: "Чего хочу достичь за 28 дней"`. Применить этот подход ко всем заполняемым полям в v2–v4.
  2) В этой секции не выводить отдельную подпись `_LabeledField` — только поле с hint (серый текст исчезает при фокусе по умолчанию). Применить этот подход ко всем заполняемым полям в v2–v4.
- Критерии приёмки:
  - В v1–v4 под Заголовком заполняемого поля виден только инпут с серым hint.

### Задача 32.12: Режим просмотра/редактирования — без чипа, визуальная индикация
- Цель: убрать чип «Режим: …» и сделать лёгкую серую подложку у readOnly‑полей.
- Файлы: `lib/screens/goal_screen.dart`, `lib/widgets/custom_textfield.dart`.
- Что сделать:
  1) Удалить Chip «Режим: Просмотр/Редактирование» внизу формы.
  2) В `CustomTextBox` добавить условный фон: если `readOnly == true` — `Colors.grey.shade100`, иначе белый. Изменение сделать параметризуемым, чтобы не ломать другие экраны.
  3) Триггер перевода в редактирование остаётся на иконке «карандаш».
- Критерии приёмки:
  - В режиме просмотра поля заметно (но не навязчиво) серые; при редактировании — белые. Чип режима отсутствует.

### Задача 32.13: «Путь к цели» — заголовок и порядок элементов
- Цель: соответствовать макету и улучшить читаемость.
- Файлы: `lib/screens/goal_screen.dart`.
- Что сделать:
  1) Заголовок упростить до «Путь к цели» (убрать «• Спринт X» и чип «7 дней»).
  2) Переставить элементы: сначала центрированные чипы «Спринт 1..4», ниже — мини‑таймлайн 7 дней, тоже по центру.
- Критерии приёмки:
  - Заголовок без дополнительных пометок; дни расположены под переключателями спринтов и центрированы.

### Задача 32.14: «Проверки недели» — вместо чекбоксов текстовые поля
- Цель: собирать осмысленные заметки и хранить их в БД.
- Файлы: `lib/screens/goal_screen.dart`, `lib/repositories/goals_repository.dart`, `lib/models/weekly_progress_model.dart`, миграция `supabase/migrations/20250814_28x_weekly_progress_details.sql`.
- Миграция (через supabase‑mcp):
  - `alter table public.weekly_progress add column if not exists artifacts_details text;`
  - `alter table public.weekly_progress add column if not exists consulted_benefit text;`
  - `alter table public.weekly_progress add column if not exists techniques_details text;`
- Что сделать (клиент):
  1) Заменить три `FilterChip` на три `CustomTextBox` с подписями и серыми подсказками:
     - «Использовал артефакты» → hint «Какие именно».
     - «Консультировался с тренерами» → hint «Какую пользу извлекли».
     - «Применял техники из уроков» → hint «Какие техники были полезными».
  2) Добавить контроллеры, загрузку из БД в `_loadSprintIfAny()` и передачу значений в `GoalsRepository.upsertSprint(...)`.
  3) В `GoalsRepository.fetchSprint()` включить новые колонки в `select`, а в `upsertSprint()` — добавить опц‑параметры `artifactsDetails`, `consultedBenefit`, `techniquesDetails` и отправлять их в payload (булевы флаги можно оставить как есть или проставлять `true`, если текст не пуст).
  4) Обновить `WeeklyProgressModel` (+ `freezed/g.dart`) с 3 новыми опциональными полями.
- Критерии приёмки:
  - Значения сохраняются в `weekly_progress.*_details`, загружаются при повторном открытии и корректно отображаются.

### Задача 32.15: Проверки, тесты и наблюдаемость
- Цель: убедиться в отсутствии регрессий.
- Что сделать:
  1) `flutter analyze` — без новых warning’ов уровня warning/error.
  2) `flutter test` — проходят существующие; при необходимости обновить моки репозитория для новых полей.
  3) Через sentry‑mcp проверить отсутствие новых RenderFlex/overflow ошибок после открытия/скролла экрана «Цель» и сохранения чек‑ина.
- Критерии приёмки:
  - Анализ и тесты зелёные, в Sentry нет свежих критических UI‑ошибок, связанных с `GoalScreen`.

  ### Задача 32.16: Профиль — счётчик артефактов, модалка и скрытие секции
- Цель: исправить склонение «артефакт(а/ов)», заменить иконку на «сундук», сделать счётчик кликабельным (стрелка в правом верхнем углу) и по нажатию открывать модальный список доступных артефактов; скрыть дублирующую секцию «Артефакты» под «Шкалой навыков».
- Файлы: `lib/screens/profile_screen.dart` (только), переиспользуем `levelsRepositoryProvider` для подписывания URL. `lib/widgets/stat_card.dart` и `lib/widgets/artifact_card.dart` не изменяются.
- Что сделать:
  1) Склонение: добавить приватную функцию `_pluralizeArtifacts(int n)` в `_BodyState` и заменить строку в `_buildRecord()` на: `${count} ${_pluralizeArtifacts(count)}`. Правила: 1 — «Артефакт», 2–4 — «Артефакта», 5–20 — «Артефактов», учитывать исключения 11–14 и циклы по последней цифре.
  2) Иконка: заменить `Icons.shield_outlined` на «сундук» — `Icons.inventory_2_outlined` (Material). Цвет и размеры как у соседних карточек.
  3) Кликабельность и индикатор: обернуть третий `StatCard` (артефакты) в `InkWell`/`GestureDetector`; визуально добавить стрелку `Icons.expand_more` в правый верхний угол карточки через `Stack` на месте использования, чтобы подсказать интерактивность.
  4) Модалка: по нажатию открывать `showModalBottomSheet(isScrollControlled: true)` с `DraggableScrollableSheet` и списком доступных артефактов. Элемент списка: компактный `ListTile` (иконка загрузки/мини‑картинка, заголовок, описание, кнопка «скачать»). Для относительных путей подписывать через `ref.read(levelsRepositoryProvider).getArtifactSignedUrl(path)`, затем открывать через `url_launcher`. Пустое состояние: «У вас пока нет артефактов».
  5) Ошибки/оффлайн: показывать `SnackBar` с понятными сообщениями («Нет соединения с интернетом», «Не удалось открыть файл»); неожиданные исключения отправлять в Sentry (`captureException`).
  6) Скрыть нижнюю секцию: удалить/закомментировать вызов `_buildArtifactsSection()` под «Шкалой навыков», чтобы исключить дублирование. При необходимости оставить секцию только на desktop в будущем (не в рамках задачи).
- Критерии приёмки:
  - Счётчик отображает корректное склонение (например: 1 Артефакт, 2 Артефакта, 5 Артефактов, 11 Артефактов, 21 Артефакт).
  - Иконка заменена на сундук; в правом верхнем углу карточки видно стрелку, карточка нажимается.
  - По нажатию открывается модалка со списком доступных артефактов; относительные пути корректно подписываются и открываются; при пустом списке — дружелюбное сообщение.
  - Секция «Артефакты» под «Шкалой навыков» больше не отображается.
  - `flutter analyze` без новых ошибок/варнингов уровня warning/error; существующие тесты не ломаются.
- Тесты:
  - Юнит‑тест функции склонения (наборы: 0–25, 101–114) на корректные формы.
  - (Опционально) widget‑тест: при `artifactsCount > 0` нажатие на карточку открывает модалку.
- Бэкенд/миграции: не требуются; используем существующий `levelsRepositoryProvider.getArt∆ifactSignedUrl`.

# Этап 33: Main Street и «Этажи» (Level)

Цель этапа: заменить текущую «Карту уровней» на концепт «Main Street → Level (этаж) → Tower», сохранив существующие данные и логику. База данных Supabase не меняется (MVP); отображаемый код уровня вычисляется на клиенте как FNN: `floorId*100 + levelNumber` (например, 101 = этаж 1, уровень 1). На главном экране используем названия зданий: слева — «Библиотека» и «Фуд‑индустрия», центр — «БизЛевел», справа — «Коворкинг (стартапы/IT/AI)» и «Маркетплейс».

### Задача 33.1: Роутинг и каркас экранов
- Файлы: `lib/routing/app_router.dart`, `lib/app_shell.dart` (если требуется подпись таба)
- Что сделать:
  1) На маршруте `/home` рендерить новый экран `MainStreetScreen` (вместо текущего списка уровней).
  2) Добавить маршруты: `/floor/1` (экран этажа 1 — адаптация текущего экрана уровней), `/tower` (обзор этажей — MVP).
  3) Переименовать таб «Карта уровней» в «Главная»/`Main Street` (подпись, логика табов без изменений).
- Критерии приёмки: приложение открывается на `MainStreetScreen`; переходы `Main Street → /level/1 → /tower` работают, back‑навигация штатная.

### Задача 33.2: Провайдер «Куда продолжить» и формат кода уровня
- Файлы: `lib/providers/levels_provider.dart` (селектор), `lib/utils/formatters.dart` (опц.)
- Что сделать:
  1) Создать `nextLevelToContinueProvider` (селектор над `levelsProvider` и профилем): учитывает `users.current_level`, `isCompleted`, `isPremium` и активную подписку; возвращает `{ levelId, levelNumber, floorId = 1, requiresPremium: bool }`.
  2) Утилита `formatLevelCode(int floorId, int levelNumber) => floorId*100 + levelNumber` (как строка). Для уровня 0 показывать «Ресепшн».
- Критерии приёмки: кнопка на главной показывает «Продолжить: Уровень 10X/101…»; если `requiresPremium==true` и подписки нет — готовит переход на `/premium`, иначе — к нужному `LevelDetailScreen`.

### Задача 33.3: Экран `MainStreetScreen` (Главная улица)
- Файлы: `lib/screens/main_street_screen.dart`, `assets/images/Bizlevel-map-buildings.png` (при необходимости PNG улицы), reuse `UserInfoBar`.
- Что сделать:
  1) Шапка — `UserInfoBar` (аватар, имя, текущий уровень/прогресс).
  2) Центральная иллюстрация «улицы»: подписи зданий — «Библиотека», «Фуд‑индустрия», «БизЛевел», «Коворкинг», «Маркетплейс».
  3) Нижняя кнопка `ElevatedButton`: «Продолжить: Уровень NNN» (данные из `nextLevelToContinueProvider`) → если `requiresPremium` и нет активной подписки — `context.go('/premium')`, иначе `context.go('/levels/<levelId>')`.
  4) Тапы по боковым зданиям — SnackBar «Скоро». Тап по «БизЛевел» ведёт на `/floor/1` или `/tower` (если этаж 1 завершён).
  5) Ошибки (offline/прочее) — дружелюбные SnackBar + `Sentry.captureException`.
- Критерии приёмки: стабильный рендер на Web/iOS/Android; корректная навигация, отсутствие overflow.

### Задача 33.4: Экран этажа `LevelFloorScreen` (адаптация текущего списка уровней)
- Файлы: переиспользовать `lib/screens/levels_map_screen.dart` (минимальный рефактор/переименование), `lib/widgets/level_card.dart`.
- Что сделать:
  1) Заголовок: «Level 1» (Этаж 1), подзаголовок «База предпринимательства» (константа на MVP).
  2) Кнопка назад «< Main Street».
  3) В `LevelCard` добавить проп `compact`: в свернутом виде карточка показывает код `101/102…` + статус (✓/★/🔒); текущий уровень — «раскрытый» вид (как сейчас).
  4) MVP‑вариант допускает оставление текущей сетки; горизонтальную линию/лист внедрим вторым шагом.
- Критерии приёмки: коды уровней отображаются как `101..110`, клики открывают `LevelDetailScreen`, регрессий нет.

### Задача 33.5: Экран «Башня БизЛевел» (обзор этажей)
- Файлы: `lib/screens/biz_tower_screen.dart`.
- Что сделать:
  1) Вертикальный список: Этаж 0 — «Ресепшн» ✓/→, Этаж 1 — «База» →, этажи 2–4 — 🔒/«Скоро».
  2) Прогресс «N/11 уровней» — на основе `levelsProvider`.
  3) Навигация: этаж 1 → `/floor/1`; остальные — SnackBar «Скоро».
- Критерии приёмки: экран открывается со «Главной», переход на этаж 1 работает.

### Задача 33.6: Нейминг и тексты
- Файлы: строки экранов/виджетов (l10n при наличии).
- Что сделать:
  1) Использовать обозначения: `Main Street`, `Level`, коды `101…110`, «БизЛевел», «Библиотека», «Фуд‑индустрия», «Коворкинг», «Маркетплейс».
  2) Не менять модели/таблицы Supabase; это только тексты. Навигационные события помечать bread‑crumbs в Sentry.
- Критерии приёмки: единообразные подписи, без конфликтов с существующими сущностями.

### Задача 33.7: Интеграция с данными Supabase (без миграций)
- Что сделать:
  1) Ничего не менять в схеме. Расчёт кода FNN — на клиенте (`floorId=1` для уровней 1–10; «Ресепшн» — уровень 0).
  2) При необходимости расширить `levelsProvider` вычисляемыми полями `displayCode`/`isCurrent` (не меняя SQL).
- Критерии приёмки: API‑контракты неизменны; тесты репозиториев зелёные.

### Задача 33.8: Тесты
- Файлы: `test/screens/street_screen_test.dart`, `test/screens/level_floor_screen_test.dart`.
- Что сделать:
  1) «Main Street»: наличие кнопки «Продолжить: Уровень NNN», корректный переход в уровень.
  2) «Этаж»: отображение кодов `101..110`, выделение текущего, переход в `LevelDetailScreen`.
- Критерии приёмки: тесты проходят локально и в CI.

### Задача 33.9: Наблюдаемость и устойчивость
- Что сделать:
  1) Навигацию и загрузки провайдеров — в try/catch с `Sentry.captureException`.
  2) Проверить Web: без overflow/горскролла; брейкпоинты `ResponsiveWrapper` соблюдаются.
- Критерии приёмки: в Sentry нет новых критических UI‑ошибок после навигации Main Street/Level/Tower.

### Задача 33.10: (Опционально, после MVP) Подготовка многоэтажности в БД
- Через supabase‑mcp подготовить черновик миграции (без применения):
  - `floors(id, title, sort_order)`; `levels.floor_id` (DEFAULT 1), индексы и RLS.
  - Просмотр прогресса по этажам через view/materialized view.
- Применять после стабилизации и согласования монетизации этажей.


# План работ (декабрь 2025) — устранение зависаний старта и финализация пушей/IAP

## Цель
1. Сдвинуть инициализацию OneSignal после прохождения экрана логина/регистрации.
2. Полностью исключить StoreKit 1: оставить только StoreKit 2 мост и регистрацию.
3. Перевести тяжёлые плагины на ленивую регистрацию (photo_manager, file_selector_ios, webview_flutter_wkwebview).
4. Проверить/подтвердить корректность Sentry (с патчами I/O и валидным DSN).
5. Зафиксировать состояние: запуск без фризов, пуши/StoreKit2 работают, лишние плагины не блокируют старт.

## Пошаговый план
1) OneSignal после логина
   - Найти точку вызова `PushService.initialize()` / `_initPushes()` в `main.dart`.
   - Переместить запуск на событие успешного логина/восстановления сессии (например, listener authState или после завершения экрана логина).
   - Убедиться, что web не трогаем, флаги `kEnableIosPush` сохраняем.
   - Проверить: запуск без пушей до логина; после логина токен регистрируется в Supabase; уведомление при тапе открывает маршрут.

2) StoreKit 1 → удалить
   - Убрать `in_app_purchase_storekit` из `GeneratedPluginRegistrant` (патч/скрипт).
   - В `BizPluginRegistrant` удалить `registerDeferredIap` для StoreKit1; оставить только StoreKit2Bridge.
   - Проверить, что iOS UI магазина вызывает только StoreKit2Service; Android/Web остаются без изменений.
   - Сборка iOS (Debug/Release) без warnings/undefined symbols.

3) Ленивые тяжёлые плагины
   - photo_manager/file_selector_ios/webview_flutter_wkwebview: не регистрировать до первого использования; инициализировать в момент открытия соответствующего экрана/сервиса.
   - Проверить, что MediaPickerService не вызывается на старте (Profile только по действию).
   - Повторный прогон: старт без их регистрации, затем открыть экран/фичу и убедиться, что плагины работают.

4) Sentry проверка
   - Убедиться `DISABLE_SENTRY=false`, DSN задан.
   - Проверить, что патчи Sentry (I/O) применяются (`SENTRY_PATCH_IO=true` в ENV при pod install).
   - Сравнить: события/ошибки доходят до Sentry после включения; при отсутствии DSN — корректно пропускается.

5) Контрольный прогон
   - `flutter clean && flutter pub get`
   - `cd ios && pod install`
   - iOS Debug: холодный старт, убедиться в отсутствии ранних I/O и фризов.
   - iOS Release: Smoke — логин, пуш-токен, получение пуша, открытие магазина (StoreKit2), покупка в тестовом окружении/симуляция.
   - Зафиксировать логи MainThreadIOMonitor/Timeline и собрать отчёт.

## Формат отчётов по шагам
- Для каждого шага: кратко «что сделал», «результат/замеры», «остаточные проблемы/следующие действия».
- Если шаг не дал эффекта — указать причину и следующий вариант.





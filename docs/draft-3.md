## План изменений: Цель · Чекпоинты · Макс (vNext)

### 0. Почему и что хотим получить
- Чёткий и короткий путь L1 → L4 → L7 → Журнал без когнитивной нагрузки.
- Понимание пользователем «где я и что делать дальше»: единая линия прогресса и понятные действия.
- Рост частоты «применений» (practice_log) и вовлечения в диалог с Максом.

### 1. Область изменений
- Чекпоинты: `/checkpoint/l1`, `/checkpoint/l4`, `/checkpoint/l7`.
- Страница `Цель` и блоки: карточка цели, прогресс, баннер «Что дальше?», журнал применений.
- Контекст/поведение Макса (встроенные комментарии и полноэкранный чат).

### 2. Quick Wins (1–2 дня)
- L7: мини‑легенда и единицы для темпов.
  - Текст под заголовком: «Z — ваш средний темп за 14 дней. W — нужный темп, чтобы успеть к дедлайну».
  - Формат: до 2 знаков и единицы по `metric_type` (например, «клиентов/день»).
- Иерархия CTA в L7:
  - Primary: «Усилить применение» → переход сразу в Журнал с префиллом («Интенсивное применение»).
  - Secondary: «Скорректировать цель» → открывает «Цель» с фокусом на «Текущее/Целевое».
  - Text: «Продолжить текущий темп» → сохраняет решение, показывает подсказку «минимум 1 запись/день».
- Цель: добавить строку под прогрессом «Z: x/день • W: y/день • Осталось: N дней» (tap → пояснение).
- L4: микро‑блок «Зачем финансовая метрика?» + пример: «Выручка = Клиенты × Средний чек».
- Баннер «Что дальше?» дублировать чипом на L1/L4/L7 (если следующий шаг вне экрана).
- Журнал: пустое состояние с подсказкой и чипами инструментов.
- Tooltip на терминах: «Метрика», «Финансовая метрика», «Темп».

### 3. Спринт 1 (5–7 дней)
- Связка L7 → Журнал с префиллом:
  - Предустанавливать инструмент «Интенсивное применение» и заметку‑шаблон.
  - После сохранения записи — авто‑комментарий Макса (бесплатно) и кнопка «Ещё запись».
- Sticky‑CTA на «Цели» (мобайл): «Добавить запись» (primary) и «Обсудить с Максом» (secondary).
- Карточка «Моя цель»: «Старт/Текущее/Цель» в один ряд; «Текущее» редактируемо.
- Подсказки в чате для L1/L4: чипы «Подскажи реалистичный темп», «Как выбрать финметрику?».
- Телеметрия (Sentry breadcrumbs): `goal_next_action_tap`, `l7_intensify_selected`, `journal_prefill_opened`, `practice_entry_saved`, `chat_max_auto_commented`.
- Тексты/локализация: «Финфокус» → «Финансовая метрика», «Проверка реальности (Z/W)» → «Реалистичность цели».

### 4. Спринт 2 (7–10 дней)
- Динамические примеры по `metric_type` (подписи/плейсхолдеры старт/цель/единицы).
- Микро‑план на 7 дней от Макса после L7 («план усиления») — без списаний GP.
- Подсказка «+10% усилий» (буллет‑план) в L7 после выбора «Продолжить темп».
- Улучшения онбординга цели: мини‑мастер выбора метрики с примерами.

### 5. Поведение Макса (когда и как действует)
- Автокомментарии (бесплатно, без списания GP):
  - После новой записи в журнале: короткая реакция (что хорошо/что улучшить) + 1–2 чипа‑подсказки.
  - После сохранения L1: поздравление, «следующий шаг — финансовая метрика (1 мин)» с CTA.
  - После сохранения L4: «проверьте реалистичность цели (30 сек)» с CTA на L7.
  - После выбора в L7:
    - «Усилить применение»: выдать микро‑план на 7 дней; предложить открыть журнал (если не открыт).
    - «Скорректировать цель»: подсказки по корректировке «Текущее/Цель».
    - «Продолжить темп»: напоминание «не реже 1 записи в день» + чип «Добавить запись».
- Пользовательские сообщения (платно, −1 GP): полноэкранный чат «Обсудить с Максом» со всем контекстом.
- Идемпотентность списаний: передача `chatId` в вызовы, как сейчас.

### 6. Спецификация кнопок и текстов
- L1
  - Primary: «Сформулировать цель» → upsert `user_goal`, затем баннер «Добавьте финансовую метрику (1 мин)».
- L4
  - Primary: «Добавить метрику» → сохранить `financial_focus`, показать подсказку про расчёт прогресса.
  - Secondary: «Оставить как есть» → сохранить без изменений; показать, что можно вернуться позже.
- L7
  - Primary: «Усилить применение» → системная запись + переход в Журнал (префилл, фокус на заметке).
  - Secondary: «Скорректировать цель» → открыть «Цель» и подсветить редактирование «Текущее/Цель».
  - Text: «Продолжить текущий темп» → сохранить решение, показать подсказку «1 запись/день» + чип «Добавить запись».
- Цель
  - «Редактировать/Сохранить» (только поле «Текущее»), «Обсудить с Максом» (чат), Sticky‑CTA «Добавить запись».
- Журнал
  - «Сохранить запись» → insert + автокомментарий Макса; «Ещё запись»; ссылка «Вся история →».

### 7. UX/UI детали
- Touch‑targets ≥ 44px; иерархия кнопок: primary (заливка), secondary (outline), text (без заливки).
- Копирайт простыми словами, единицы измерения рядом с числами.
- Карточка «Моя цель»: под прогрессом строка «Z/W/Осталось N дней», tap‑пояснение.
- Чип «Что дальше?» на чекпоинтах и на «Цели».
- Пустые состояния и подсказки; tooltips (i) на терминах.

#### 7.1 Страница «Цель»: детальные рекомендации UX/UI
- Информационная иерархия
  - Сверху краткий саммари одной строкой: «<Краткое описание> — <метрика>».
  - Ниже прогресс‑бар с числом и строкой: «Z: x/день • W: y/день • Осталось: N»; по тапу — подсказка «что такое Z/W».
  - Порядок блоков: Саммари → «Что дальше?» → Журнал (быстрое действие) → История.
- Карточка «Моя цель»
  - «Старт / Текущее / Цель» в один ряд; «Текущее» редактируемо, остальные readonly.
  - У всех чисел явные единицы (клиентов/день, заказов/нед.).
  - «Метрика: …» как ссылка «Изменить» (ведёт в L4), рядом иконка (i) с пояснением.
  - Режимы: вне редактирования — только «Редактировать»; в редактировании — «Сохранить» и «Отмена».
- CTA и навигация
  - Sticky‑панель на мобиле: Primary «Добавить запись», Secondary «Обсудить с Максом».
  - Баннер «Что дальше?» сразу под саммари: «Шаг N из 3 • ~1 мин» и один главный CTA.
  - После сохранения записи — мини‑тост «Запись сохранена» + «Ещё запись».
- Журнал применений (быстрое действие)
  - Чипы инструментов в 1–2 строки с горизонтальной прокруткой; выбранные подчёркнуты.
  - Плейсхолдер заметки с примером («Что конкретно сделал(а) сегодня…»).
  - Пустое состояние: дружелюбный текст + кнопка‑чипы популярных инструментов.
- Подсказки и тексты
  - Tooltips (i) на «Метрика», «Финансовая метрика», «Темп Z/W».
  - Рядом с «Финансовая метрика» мини‑формула: «Выручка = Клиенты × Средний чек».
  - Термины проще: «Финфокус» → «Финансовая метрика», «Проверка реальности (Z/W)» → «Реалистичность цели».
- Визуал и читабельность
  - Единая карточная сетка, белый фон, тени, токены отступов; заголовки 18–20pt.
  - Контраст ≥4.5:1; primary заметный, secondary — outline, text — без заливки.
  - Прогресс‑бар с анимацией обновления и числом N% внутри.
- Доступность
  - Все интерактивы ≥44 px; корректные Semantics(label, button).
  - Числовые поля включают числовую клавиатуру; мягкая валидация до сохранения.
- Состояния загрузки/ошибок
  - Скелетоны для саммари и журнала; MaterialBanner для ошибок с действиями «Повторить/ОК».
  - Пустые состояния компактные, без длинных текстов.
- Производительность
  - Историю (таймлайн) сворачивать по умолчанию; лениво подгружать содержимое.
  - Проверить отсутствие overflow на 320–360 px (переносы, ellipsis).
- Телеметрия
  - Breadcrumbs: `goal_next_action_tap`, `practice_entry_saved`, `goal_edit_saved`, `zw_info_opened`, `chat_opened_from_goal`.
- Быстрые победы для «Цели»
  - Строка «Z/W/Осталось N» под прогресс‑баром.
  - Sticky‑CTA «Добавить запись» + «Обсудить с Максом».
  - Баннер «Что дальше?» с единственным CTA.
  - Пустое состояние журнала с чипами и примером заметки.
  - Единицы измерения и tooltips у терминов.

### 8. Данные и API (без новых таблиц)
- Используем существующие поля `user_goal` и `practice_log`.
- Z = среднее изменение `metric_current` по записям журнала за последние 14 дней (как в репозитории сейчас).
- W = (target − current) / дней до `target_date` (без деления на 0; защита на одинаковые значения).
- Округление до 2 знаков; единицы из `metric_type`.
- Флаги для поэтапного включения: `kShowZWOnGoal`, `kL7PrefillToJournal`, `kGoalStickyCta`.
- Breadcrumbs Sentry: `goal_header_info_tap`, `l7_cta_{intensify|adjust|continue}`, `journal_prefill_opened`, `practice_entry_saved`, `chat_max_auto_commented`.

### 9. Метрики успеха
- Активации: % пользователей, прошедших цепочку L1→L4→L7 за 7 дней.
- Поведение: средняя частота записей/неделю; доля пользователей с «сходимостью темпа» (Z → W).
- Взаимодействие: CTR «Что дальше?», доля префиллов из L7, доля автокомментариев прочитанных (экран открыт ≥3с).

### 10. Критерии приёмки
- L7 показывает легенду Z/W и корректные единицы.
- Нажатие «Усилить применение» открывает Журнал с префиллом и сохраняется запись.
- На «Цели» отображается строка Z/W/Осталось N дней; tap открывает пояснение.
- Баннер/чип «Что дальше?» корректно ведёт на следующий шаг.
- Автокомментарии Макса отправляются в указанных случаях, не списывая GP.

### 11. Риски и откат
- Непонимание терминов → tooltips и простые формулировки.
- Узкие экраны → sticky‑CTA и переносы текстов; проверка на 320–360 px.
- Откат: фичефлаги выключают новые элементы по отдельности.

### 12. Релиз и коммуникация
- В релизнотах: «Наглядная реалистичность цели, быстрый переход к применению, советы Макса по месту».
- Внутренний скринкаст: 2–3 минуты с демонстрацией L7→Журнал и строки Z/W на «Цели».

### 13. Чек‑лист тестов
- Widget: рендер и клик CTA L7; префилл Журнала; строка Z/W на «Цели»; пустые состояния.
- Unit: расчёт Z/W (краевые случаи: одинаковые значения, нет записей, 0 дней).
- Интеграция: автокомментарий Макса после записи, переходы «Что дальше?», сохранение целей.


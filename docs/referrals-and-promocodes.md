# Рефералки и промокоды (BizLevel)

Этот документ описывает, как устроены рефералки и промокоды в BizLevel, и как безопасно с ними работать в нашем стеке (Flutter + Supabase).

## 1) Общая логика

### Промокоды
- Промокод вводится пользователем и валидируется **на сервере**.
- Награда начисляется в GP через серверную функцию, без доверия клиенту.

### Рефералка
- Пользователь делится своим кодом.
- Новый пользователь применяет код.
- Награда начисляется **рефереру** после того, как приглашённый пройдет уровни 0 и 1.

## 2) Таблицы (Supabase)

### `promo_codes`
Хранит коды кампаний и правила:
- `code` (PK, uppercase)
- `reward_gp`, `max_uses`, `used_count`
- `expires_at`, `is_active`
- `campaign`, `metadata`

### `promo_redemptions`
Фиксирует факт использования промокода:
- `user_id`, `code` (PK)
- `reward_gp`, `redeemed_at`, `idempotency_key`, `metadata`

### `referral_codes`
Персональный код приглашения пользователя:
- `user_id` (PK)
- `code` (unique)

### `referrals`
Связь реферер ↔ приглашённый:
- `referrer_id`, `referred_user_id` (PK по `referred_user_id`)
- `status` (`registered` → `activated` → `rewarded`)
- `reward_gp`, `activated_at`, `rewarded_at`

## 3) Функции и триггеры

### `get_referral_code()`
Возвращает или генерирует код пользователя.
- Генерация: `BZ` + 8 hex символов.
- Сервер‑authoritative, RLS не даёт писать напрямую.

### `apply_referral_code(p_code)`
Применяет код приглашения:
- Защита от self‑referral
- Один реферер на пользователя
- Сохраняет `reward_gp` в `referrals` (фиксирует размер бонуса)

### `redeem_promo_code(p_code)`
Применяет промокод:
- Проверка активности/срока/лимитов
- Запись в `promo_redemptions`
- Начисление GP через `_gp_apply_bonus`

### Триггер `trg_user_progress_referral_reward`
Срабатывает при завершении уровня:
- Проверяет, что у пользователя завершены уровни 0 и 1
- Начисляет бонус рефереру
- Переводит `referrals.status` в `rewarded`

## 4) Конфигурация награды

`app_settings`:
- `referral_reward_gp` = `100` (можно менять без миграций)

## 5) Клиент (Flutter)

### Сервисы
- `ReferralService` — RPC для промокодов и рефералок.
- `ReferralStorage` — сохранение pending‑кодов в `SharedPreferences`.

### Deep links
Поддерживаются:
- `bizlevel://ref/<code>`
- `bizlevel://promo/<code>`
- `bizlevel://...?...&ref=<code>` / `...&promo=<code>`

При получении deep link:
1) код сохраняется локально
2) если пользователь авторизован — код применяется сразу
3) если не авторизован — применяется после входа

### UI
**Профиль**:
блок между «Деревом навыков» и «Достижениями»:
- кнопка «Поделиться»
- отображение кода пользователя
- поле «Код приглашения»
- поле «Промокод»

**GP Store**:
карточка‑напоминалка:
> «Пригласи друга — получи 100 GP»  
> «Бонус начислим после того, как друг пройдет уровни 0 и 1.»

## 6) Тестовые сценарии

1. **Рефералка**
   - Пользователь A получает свой код
   - Пользователь B применяет код
   - B проходит уровни 0 и 1
   - A получает +100 GP

2. **Промокод**
   - Создать `promo_codes` (вручную в Supabase)
   - Применить код в профиле
   - Проверить, что GP начислились и `used_count` увеличился

## 7) Ошибки и сообщения

### Рефералка
- `referral_invalid_code` → «Код приглашения не найден»
- `referral_self` → «Нельзя использовать свой код»
- `referral_already_applied` → «Код уже применён»

### Промокоды
- `promo_invalid_code` → «Промокод не найден»
- `promo_expired` → «Срок действия истёк»
- `promo_exhausted` → «Лимит исчерпан»
- `promo_already_used` → «Промокод уже использован»

## 8) Безопасность
- Начисления GP происходят только на сервере.
- Клиент не может напрямую писать в `promo_*`/`referral_*`.
- Идемпотентность обеспечена через `gp_ledger.idempotency_key`.

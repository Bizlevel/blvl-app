# GP: попытки исправлений и типы ошибок (аудит по чату)

## Контекст проблем
- UI показывал 0 GP при фактическом балансе 30 в `gp_wallets`.
- В чате при отправке сообщения:
  - `/functions/v1/gp-spend` → 401 `Invalid JWT`.
- На главной улице при загрузке:
  - `/functions/v1/gp-balance` → 401 `Missing authorization header` (и периодически повторяется).
- Иногда происходили многократные «перезагрузки»/редиректы (циклы), параллельно в логах: `supabase.auth: Refresh session` и `GoRouter: redirecting to RouteMatchList(/login)`.

## Что уже пробовали (хронология правок)
1) Edge Functions (GP) — унификация авторизации (verify_jwt=true сохранён):
   - Переписаны `gp-spend`, `gp-purchase-init`, `gp-purchase-verify`, `gp-floor-unlock`, `gp-bonus-claim` на схему:
     - Создание anon‑клиента с глобальным заголовком `Authorization: Bearer <user JWT>`.
     - Пользователь определяется через `supabase.auth.getUser()` без передачи токена вручную.
   - Цель: исключить 401 из-за некорректной локальной валидации и привести к паттерну `gp-balance`.

2) LeoService → `leo-chat` заголовки:
   - Было: `Authorization: Bearer <anon>`, `x-user-jwt: <user JWT>`.
   - Стало: `Authorization: Bearer <user JWT>` + `x-user-jwt: <user JWT>` (совместимо с verify_jwt и текущей функцией `leo-chat`).

3) Провайдер баланса (`gpBalanceProvider`):
   - Подписка на `authStateProvider` (инвалидация при смене сессии).
   - «Гейт» на отсутствие сессии: без session не делаем сетевой вызов.
   - Фоновый рефетч только при наличии session; кеш через Hive сохранён.

4) `UserInfoBar`:
   - Подписку на `gpBalanceProvider` перенесли внутрь ветки `data(user)` — баланс запрашивается только после загрузки профиля/сессии, чтобы не стрелять ранний `/gp-balance` без `Authorization`.

5) Чат — обновление баланса после траты:
   - В `leo_dialog_screen.dart` после успешного ответа ассистента выполняется `ref.invalidate(gpBalanceProvider)`.

6) Попытка авто‑рефреша JWT в `GpService` (getBalance/spend):
   - На 401/`Invalid JWT` вызывался `auth.refreshSession()`.
   - Побочный эффект: циклы редиректов/перезагрузок (частые события `Refresh session` + `RouteMatchList(/login)`).
   - Решение: удалить рефреш из `GpService` (возврат к стабильной навигации).

7) Локальный guard в `LeoService` перед списанием:
   - Добавлен `_refreshSessionIfPossible()` (без выброса ошибок), вызывается перед `gp.spend(...)` в `sendMessage`/`sendMessageWithRAG`.
   - Цель: подавить `Invalid JWT` именно в момент клика по «Отправить», не вмешиваясь в глобальный auth‑цикл.

## Наблюдаемые ошибки/симптомы
- 401 `Missing authorization header` на `/gp-balance` (ранние запросы до session).
- 401 `Invalid JWT` на `/gp-spend` (гонка обновления токена: авто‑рефреш SDK vs отправка запроса).
- Многократные `supabase.auth: Refresh session` в логах + `GoRouter: redirecting to RouteMatchList(/login)` — признак конфликтов при рефреше сессии и редиректе.
- UI «0 GP», хотя в БД 30 — следствие раннего фола провайдера + отсутствия успешного чтения `/gp-balance` до этого момента.
- Доп. шум: 404 по `assets/assets/images/street/background.svg` (не влияет на GP/чат).

## Выводы по причинам
- `/gp-balance` без Authorization — вызов провайдера/виджета до того, как установилась сессия. Лечится жёстким «гейтом» по session и отложенным вызовом (сделано для `UserInfoBar`, проверить остальные экраны).
- `/gp-spend` с `Invalid JWT` — локальная гонка: в секунду отправки идёт авто‑рефреш токена на Web; запрос уходит со старым JWT. Частично закрыто локальным guard’ом в `LeoService`, при необходимости — добавить короткий ретрай (1 попытка через 300–500 мс) ровно вокруг `gp.spend`.
- Циклы перезагрузок — вызваны рефрешем внутри сетевых слоёв (устранено удалением `refreshSession()` из `GpService`).

## Рекомендации (минимальные)
1) Убедиться, что во всех местах чтение баланса происходит только после `currentUserProvider.data` (или явной проверки `auth.currentSession != null`).
2) В `LeoService` добавить узкий ретрай 401/`Invalid JWT` вокруг `gp.spend` (1 повтор) вместо глобальных рефрешей.
3) Не инициировать refresh/redirect из провайдеров/перехватчиков HTTP, чтобы исключить циклы.


## Что дополнительно попробовали в этом чате (30.08.2025)
- Идемпотентность и кейсы:
  - Унифицировали генерацию стабильного Idempotency-Key в `LeoService` (без timestamp) и добавили `skipSpend` в `sendMessageWithRAG`, чтобы не списывать GP в `mini_case`.
  - В башне сделали стабильный ключ для открытия этажа: `floor:<userId>:<floor>` вместо timestamp.
- Магазин GP:
  - Перевели `GpStoreScreen` на поток `/gp-purchase-init → /gp-purchase-verify`, синхронизировали цены с сервером, добавили кнопку «Проверить покупку» и инвалидацию `gpBalanceProvider`.
- JWT/401 попытки:
  - Добавили одноразовый refresh при 401 в `GpService.getBalance/spend`, затем удалили его из‑за циклов refresh/redirect GoRouter (сохранили без refresh внутри GpService).
  - Сравнили с версией в `main` и изменили заголовки для `/leo-chat`: теперь `Authorization: Bearer <ANON_KEY>`, `apikey: <ANON_KEY>`, `x-user-jwt: <user JWT>` (раньше отправляли Bearer <user JWT>), чтобы снизить вероятность `Invalid JWT` на Edge‑шлюзе.
- Проверки серверной стороны:
  - Через supabase‑mcp проверили RLS на таблицах GP — включено и корректно; WARN по `search_path` у функций (`gp_spend`, `gp_purchase_verify`) отмечен как нефункциональный риск.
- Текущее состояние после правок:
  - Цикл refresh из‑за GpService устранён (refresh удалён), но 401 по `/gp-balance`/`/gp-spend` сохраняются эпизодически; чату изменили схему заголовков по образцу `main`.
  - Баланс может кратко показывать 0 до прихода кеша/успешного запроса; провайдер имеет гейт на отсутствие сессии.



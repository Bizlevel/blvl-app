# Итоговый отчёт BizLevel v2.0 – состояние после этапа **ST-7** (iOS test)

## 1. Общая информация
* **Название проекта:** BizLevel – мобильная образовательная платформа c геймификацией и AI-ментором.
* **Текущий этап:** завершён пакет задач ST-7 (инфраструктура, базовый функционал, первая оптимизация). Приложение успешно собирается и запускается на iOS-симуляторе.
* **Технологии:** Flutter 3, Riverpod 2, Supabase (БД, Auth, Storage, Edge Functions), Dio, Chewie/Video_Player, flutter_cache_manager, Sentry.

## 2. Структура репозитория (упрощённо)
```
lib/
  models/           // Freezed-модели данных (User, Level, Lesson, …)
  services/         // Логика работы с backend (SupabaseService, AuthService, LeoService)
  providers/        // Riverpod-провайдеры (auth, levels, lessons, …)
  screens/          // UI-экраны (auth/, levels_map, level_detail, leo_chat, profile, root_app)
  widgets/          // Переиспользуемые виджеты (LevelCard, LessonWidget, QuizWidget, …)
  theme/            // Цветовая схема
assets/             // Иконки, иллюстрации, onboarding-видео
supabase/functions/ // Edge-function  leo-chat (OpenAI proxy)
docs/               // План, статус, отчёты (текущий файл)
```

## 3. Backend (Supabase)
* **Таблицы:** users, levels, lessons, user_progress, leo_chats, leo_messages, payments.
* **RLS:** включены и проверены для всех таблиц.
* **Edge Functions:** `leo-chat` – прокси к OpenAI, учитывает токены и лимиты сообщений.
* **Storage:** bucket `artifacts` – файлы уровня; bucket `videos` пока не используется.

## 4. Сервисный слой Flutter
| Сервис | Назначение |
|--------|-----------|
| SupabaseService | Инициализация Supabase, запросы уровней/уроков, helper с retry |
| AuthService | Регистрация/вход/выход, обновление профиля, онбординг-флаги |
| LeoService | Отправка сообщений в Edge Function, лимиты, сохранение чата |

### Riverpod-провайдеры
* `authStateProvider`, `currentUserProvider` – авторизация и профиль.
* `levelsProvider` – список уровней с агрегацией lessons(count).
* `lessonsProvider(levelId)` – уроки выбранного уровня.

## 5. UI-слой
* **Auth Flow:** `LoginScreen`, `RegisterScreen`, `OnboardingProfileScreen`, `OnboardingVideoScreen` – полностью интегрированы.
* **Навигация:** `RootApp` c 3 вкладками (Уровни, Leo, Профиль).
* **Карта уровней:** `LevelsMapScreen` + `LevelCard` – отображаются уровни, бесплатная блокировка первых 3.
* **Детали уровня:** `LevelDetailScreen` + `LessonWidget` + `QuizWidget` – последовательное прохождение уроков.
* **Leo AI:** `LeoChatScreen` (список диалогов) и `LeoDialogScreen` (чат) – работает send/receive через Edge Function.
* **Профиль:** `ProfileScreen` – статистика, артефакты, кнопка Premium.

## 6. Что уже работает
1. Авторизация Supabase с email + пароль, подтверждение e-mail.
2. Полный онбординг (заполнение профиля + видео-инструкция).
3. Карта уровней с реальными данными из БД.
4. Загрузка уроков, отображение описания, попытка воспроизведения видео, мини-квизы.
5. Чат с AI Leo, лимиты сообщений, сохранение истории.
6. Профиль пользователя с базовой статистикой и загрузкой артефактов (signed URL).
7. Логирование ошибок Sentry (DSN берётся из `.env` или `--dart-define`).
8. Покрытие unit / widget / интеграционных тестов (auth, инфраструктура, уровни, Leo, профиль) – все проходят локально на последнем стабильном коде до видеопроблемы.

## 7. Выявленные проблемы
| Категория | Симптом | Причина | Статус |
|-----------|---------|---------|--------|
| Видео уроков | «Видео недоступно» после индикаторов загрузки | `LessonWidget` получает 403 от `player.vimeo.com/video/{id}/config` (ролики приватные); fallback оставляет исходный url, video_player не может проиграть | Требуется замена на прямые *.mp4/HLS ссылки или открытие Vimeo-роликов для embed |
| Завершение уровня | Кнопка «Завершить уровень» показывает SnackBar (заглушка) | Логика записи в `user_progress` и инкремент `users.current_level` не реализованы | В планах задачи 4.6 / 6.1 |
| Прогресс/доступ к премиум-уровням | пока упрощённая блокировка «>3 уровня» | Нет учёта оплаты и фактического прогресса | Требуется реализация платежей + расширенный запрос уровней |
| Edge-case в чате | Ошибка `setState() called after dispose` при быстром выходе из LeoDialogScreen | Отсутствует проверка `mounted` | Минимальный фикс готов к внедрению |
| Тесты levels_system | могут падать, если уроки не содержат воспроизводимое видео | Зависит от решения видеопроблемы |

## 8. Задачи, оставшиеся до MVP (выдержка из плана)
1. **Видео:**
   * Перезалить видео (Supabase Storage или публичный CDN) и обновить lessons.video_url.
   * Либо расширить `_resolvePlayableUrl` — авторизация Vimeo нецелесообразна для MVP.
2. **Завершение уровня и прогресс:**
   * Реализовать SupabaseService.updateProgress() + вызов в LevelDetailScreen.
   * Обновить levelsProvider для учёта `user_progress` и `users.current_level`.
3. **Платежи / Premium:**
   * Экран `PaymentScreen` – закончить инструкцию, подключить Kaspi API.
   * Миграции: webhook confirm_kaspi_bill → уже в схеме; добавить Edge Function или CRON для подтверждения.
   * Логика Premium-разблокировки уровней и дневных лимитов Leo.
4. **Полировка UX:**
   * Улучшить кеш видео (проверка наличия файла, тайм-аут, перезапуск).
   * Добавить пуш-уведомления (опционально после MVP).
5. **Тесты:**
   * Прогнать `auth_flow_test`, `levels_system_test` после фикса видео.
   * Добавить тесты user_progress и платежей.
6. **Оптимизация:**
   * const-конструкторы, мелкие rebuild-оптимизации (частично сделано в 7.2).
   * Проверка памяти на реальных Android-устройствах.
7. **Документация:**
   * Обновить README (сборка, .env, Sentry, моки платежей).

## 9. Риски
* Видео-контент – главный блокер (без исправления пользователи не смогут пройти уроки).
* Платёжная интеграция требует согласования с Kaspi / Halyk – возможны задержки.
* Ограниченные сроки (14 дней) – важно не добавлять новые фичи сверх MVP.

## 10. Рекомендации
1. Сначала закрыть **видео-блокер**: заменить ссылки или подключить Storage – это разблокирует тесты и реальное обучение.
2. Параллельно имплементировать **прогресс & завершение уровня** – минимальные изменения в БД и коде.
3. Отдельной веткой довести **Payment flow** до базового приёма чеков; Premium-гейт уровня включить только после end-to-end теста.
4. Регулярно обновлять **status.md** и Sentry – видна динамика ошибок.

---
*Документ сформирован автоматически после анализа кода, базы данных и логов iOS-симулятора.*



# Оптимизация системы целей BizLevel - Техническое задание

## 1. ОБЩАЯ КОНЦЕПЦИЯ ИЗМЕНЕНИЙ

### 1.1 Принцип работы
Переход от статичного заполнения формы к интерактивному диалогу с Максом. Каждое поле сохраняется отдельно, что позволяет Максу комментировать введенные данные и направлять пользователя к следующему шагу.

### 1.2 Архитектура взаимодействия
- Экран чекпоинта разделен: сверху чат с Максом (60% высоты), снизу форма (40%)
- После сохранения каждого поля данные отправляются в Supabase
- Макс получает webhook/trigger о новых данных и генерирует контекстный ответ
- Ответ Макса появляется в чате и может включать подсказку для следующего поля

## 2. ИЗМЕНЕНИЯ ПОЛЕЙ КРИСТАЛЛИЗАЦИИ

### 2.1 Версия 1 - "Семя цели" (Заполняется после Уровня 1)

**Старые поля:**
- goal_initial 
- goal_why
- main_obstacle

**Новые поля:**
```
Поле 1: concrete_result
- Label: "Конкретный результат"
- Placeholder: "Что именно получу через 28 дней? (например: 50 новых клиентов)"
- Validation: минимум 10 символов, должно содержать хотя бы одну цифру
- Helper text: "Будьте конкретны: вместо 'больше клиентов' напишите '50 новых клиентов'"

Поле 2: main_pain
- Label: "Главная проблема"  
- Placeholder: "Что мешает росту сейчас? (например: мало повторных покупок)"
- Validation: минимум 10 символов
- Helper text: "Одна главная боль, не список проблем"

Поле 3: first_action
- Label: "Действие на завтра"
- Placeholder: "Что сделаю в ближайшие 24 часа? (например: позвоню 5 клиентам)"
- Validation: минимум 10 символов, должен начинаться с глагола
- Helper text: "Начните с глагола: позвоню, напишу, встречусь, изучу"
```

### 2.2 Версия 2 - "Метрики" (Чекпоинт после Уровня 4)

**Новые поля:**
```
Поле 1: metric_type
- Label: "Что измеряем"
- Type: Dropdown
- Options: ["Выручка (тенге)", "Количество клиентов", "Количество продаж", "Часы работы", "Конверсия (%)", "Другое"]
- Required: true

Поле 2: metric_current
- Label: "Текущее значение"
- Type: Number input
- Placeholder: "Сколько сейчас?"
- Validation: положительное число
- Helper text: динамически меняется в зависимости от metric_type

Поле 3: metric_target  
- Label: "Целевое значение"
- Type: Number input
- Placeholder: "Сколько хочу?"
- Validation: должно быть больше metric_current
- Auto-calculation: показывать % роста после ввода
```

### 2.3 Версия 3 - "SMART-план" (Чекпоинт после Уровня 7)

**Новые поля:**
```
Поле 1: week1_focus
- Label: "Неделя 1: Главный фокус"
- Placeholder: "Одно ключевое действие (например: Опросить 30 клиентов)"
- Validation: минимум 10 символов
- Helper text: "Только ОДНО главное действие на неделю"

Поле 2: week2_focus
- Label: "Неделя 2: Главный фокус"
- Placeholder: "Что после первой недели?"
- Validation: минимум 10 символов

Поле 3: week3_focus
- Label: "Неделя 3: Главный фокус"
- Placeholder: "Ускорение и масштаб"
- Validation: минимум 10 символов

Поле 4: week4_focus
- Label: "Неделя 4: Главный фокус"  
- Placeholder: "Финальный рывок"
- Validation: минимум 10 символов
```

### 2.4 Версия 4 - "Финал" (Чекпоинт после Уровня 10)

**Новые поля:**
```
Поле 1: readiness_score
- Label: "Готовность начать"
- Type: Slider (1-10)
- Helper text: "1 = совсем не готов, 10 = начинаю прямо сейчас"

Поле 2: start_date
- Label: "Дата старта"
- Type: Date picker
- Validation: не раньше сегодня, не позже чем через 7 дней
- Helper text: "Когда начинаете 28-дневный путь?"

Поле 3: accountability_person
- Label: "Кому расскажу о цели" (опционально)
- Placeholder: "Имя человека или 'Никому'"
- Helper text: "Публичное обязательство повышает шансы на успех"

Поле 4: first_three_days
- Label: "План на первые 3 дня"
- Type: Textarea
- Placeholder: "День 1: ... День 2: ... День 3: ..."
- Helper text: "Конкретные действия на каждый день"
```

## 3. ЛОГИКА ИНТЕРАКТИВНОГО ЗАПОЛНЕНИЯ

### 3.1 Общий флоу для всех чекпоинтов

1. **Открытие чекпоинта:**
   - Чат Макса открывается с приветственным сообщением
   - Форма показывает только первое поле (остальные скрыты/disabled)
   - Кнопка "Сохранить" активна только когда поле заполнено валидно

2. **После сохранения поля:**
   - Данные сохраняются в `core_goals.version_data` (partial update)
   - Триггер отправляет данные Максу
   - Макс генерирует ответ с учетом введенных данных
   - Следующее поле становится активным
   - Фокус автоматически переходит на следующее поле

3. **После заполнения всех полей:**
   - Кнопка "Завершить и перейти к следующему уровню" 
   - Макс дает финальный комментарий
   - Redirect на /tower с автоскроллом

### 3.2 UI/UX изменения в чекпоинтах

```
Верхняя часть (60% высоты):
- Чат с Максом
- Автоскролл к последнему сообщению
- Поле ввода в чате disabled (общение только через форму)

Нижняя часть (40% высоты):
- Прогресс-бар: "Поле 2 из 3" 
- Текущее активное поле с кнопкой "Сохранить →"
- Заполненные поля показаны как read-only с галочкой ✓
- Незаполненные поля показаны как disabled
```

## 4. ПРОМПТЫ ДЛЯ МАКСА

### 4.1 Системный промпт (базовый для всех версий)

```
Ты - Макс, трекер целей BizLevel. 
Помогаешь предпринимателям из Казахстана формулировать и достигать бизнес-цели.

КОНТЕКСТ: Пользователь заполняет версию {version} цели "{goal_name}".
Он находится на поле {field_number} из {total_fields}.

ТВОЙ СТИЛЬ:
- Максимум 2-3 предложения
- Простые слова, без сложных терминов  
- Обращайся на "ты", используй имя каждые 3 сообщения
- Локальный контекст: тенге, казахстанские реалии

СТРУКТУРА ОТВЕТА:
1. Короткий комментарий о том, что ввел пользователь (1 предложение)
2. Подсказка/вопрос для следующего поля (1 предложение)
3. [Опционально] Мотивация или микро-совет (1 предложение)

ЗАПРЕЩЕНО:
- Фразы "отлично", "молодец", "правильно"
- Общие советы без конкретики
- Вопросы "чем помочь?"
- Критика выбора пользователя
```

### 4.2 Промпты для версии 1 (Семя цели)

**Начальное сообщение:**
```
"Привет! Я Макс, помогу оформить твою цель.
За 28 дней можно многое изменить.
Что конкретно хочешь получить к концу месяца?"
```

**После поля 1 (concrete_result):**
```
CONTEXT: Пользователь ввел: {concrete_result}

Если есть цифра:
"{concrete_result} - запомнил. Что мешает этого достичь прямо сейчас?"

Если нет цифры:
"Понял про {краткое описание}. Добавь цифру для ясности. А пока - что мешает?"
```

**После поля 2 (main_pain):**
```
CONTEXT: Пользователь ввел проблему: {main_pain}

"Да, {main_pain} - частая история. Что сделаешь завтра, чтобы начать решать?"
```

**После поля 3 (first_action):**
```
CONTEXT: Все поля заполнены

"План готов: {concrete_result} через решение {main_pain}.
Начинаешь с {first_action}.
Увидимся в следующем чекпоинте!"
```

### 4.3 Промпты для версии 2 (Метрики)

**Начальное сообщение:**
```
"Твоя цель: {goal_v1}.
Привяжем к цифрам - так проще отслеживать.
Что будем измерять?"
```

**После поля 1 (metric_type):**
```
"{metric_type} - хороший выбор. Сколько у тебя сейчас?"
```

**После поля 2 (metric_current):**
```
CONTEXT: Текущее значение {metric_current}

"{metric_current} - база есть. Какая цель на конец месяца? Реально оцени силы."
```

**После поля 3 (metric_target):**
```
CONTEXT: Рост с {metric_current} до {metric_target} = {percent}%

Если рост 20-50%:
"С {metric_current} до {metric_target} - это +{percent}%. Амбициозно и реально!"

Если рост <20%:
"Всего +{percent}%? Можешь больше! Но ок, начнем с этого."

Если рост >50%:
"Ого, +{percent}%! Уверен? Обычно больше 50% за месяц - фантастика."
```

### 4.4 Промпты для версии 3 (SMART-план)

**Начальное сообщение:**
```
"Цель ясна: {metric_name} с {current} до {target}.
4 недели = 4 главных фокуса.
Неделя 1 - с чего начнешь?"
```

**После каждой недели:**
```
"Неделя {N}: {week_focus}. [Короткий комментарий]. Что на неделе {N+1}?"

Примеры комментариев:
- "Правильно, сначала данные"
- "Логично после {предыдущая неделя}"  
- "Самое время для этого"
```

**После всех недель:**
```
"План собран:
Старт → Разгон → Масштаб → Финиш
Готов начать этот путь?"
```

### 4.5 Промпты для версии 4 (Финал)

**Начальное сообщение:**
```
"Цель оформлена, план готов.
Осталось честно оценить готовность.
От 1 до 10?"
```

**После readiness_score:**
```
Если 8-10:
"[Score]/10 - отлично! Когда стартуешь?"

Если 5-7:
"[Score]/10 - нормально. Когда планируешь начать?"

Если 1-4:
"[Score]/10 - рано пока. Что нужно доделать перед стартом?"
```

**После start_date:**
```
"Старт {date}. Кому расскажешь о цели? (можно пропустить)"
```

**После accountability_person:**
```
Если указал человека:
"Расскажешь {person} - это повысит ответственность. Что сделаешь в первые 3 дня?"

Если "Никому" или пропустил:
"Ок, сам по себе. Что конкретно в первые 3 дня?"
```

**Финальное сообщение:**
```
"Все готово! Старт {date}.
День 1 начнется с: {first_action_from_3days}.
Поехали! 🚀"
```

## 5. ИЗМЕНЕНИЯ В "ПУТЬ К ЦЕЛИ"

### 5.1 Новая структура полей недельного чек-ина

**Старые поля (6 штук) заменяются на 3:**

```
Поле 1: week_result
- Label: "Главное за неделю"
- Type: Text input
- Placeholder: "Одним предложением: что сделано?"
- Required: true
- Max length: 100 символов

Поле 2: metric_value
- Label: "[Динамически из v2: название метрики]"
- Type: Number input  
- Placeholder: "Текущее значение"
- Required: если есть v2
- Показывает прогресс: "Было {last_week} → Стало {current} ({+/-}%)"

Поле 3: used_tools
- Label: "Использованные инструменты" 
- Type: Multi-checkbox
- Options: динамически из пройденных уровней
- Required: false
- Collapsed по умолчанию, разворачивается по клику
```

### 5.2 Автоматические реакции Макса на чек-ины

**После сохранения недельного чек-ина:**

```javascript
// Триггер в Supabase после INSERT в weekly_progress
// Отправляет данные Максу для генерации реакции

Контекст для Макса:
- Номер недели
- Результат недели  
- Прогресс метрики
- Использованные инструменты
- План следующей недели из v3

Примеры автоматических сообщений:

Неделя 1 + рост метрики:
"Неделя 1: {metric} уже {value}! Так держать. Что на второй неделе?"

Неделя 2 + падение:
"Метрика упала. Бывает. Фокус недели 3: {week3_focus}. Что поможет?"

Неделя 3 + стагнация:
"Метрика стоит. Осталась неделя. Какой будет последний рывок?"

Неделя 4 + любой результат:
"4 недели позади! {metric}: было {start} → стало {current}. Что дальше?"
```

## 6. ИЗМЕНЕНИЯ СТРАНИЦЫ "ЦЕЛЬ"

### 6.1 Новая структура страницы (сверху вниз)

```
1. Мотивационная цитата (collapsible)
   - Высота: 120px в развернутом, 60px в свернутом виде
   - Автосворачивание через 5 секунд после загрузки
   - Клик разворачивает/сворачивает

2. Карточка цели (всегда видна)
   - Заголовок: финальная версия цели или "Цель формируется..."
   - Прогресс-бар с процентами
   - Метрика: "Сейчас: X → Цель: Y"
   - Дней осталось: N из 28
   - Кнопка: "Обсудить с Максом" (floating справа)

3. Мини-дашборд (3 карточки в ряд)
   - Прогресс: круговой индикатор с %
   - Текущая неделя: номер и фокус
   - Streak: количество чек-инов подряд

4. Путь к цели (аккордеон)
   - Текущая неделя развернута
   - Прошлые недели свернуты (показан только результат)
   - Будущие недели заблокированы
   - В развернутом виде: форма чек-ина или результаты
```

### 6.2 Состояния и условная логика

```
Если нет v1:
- Показать заглушку "Пройдите Уровень 1 для постановки цели"
- Кнопка "Начать Уровень 1"

Если есть v1, но нет v2:
- Показать v1 как текущую цель
- Прогресс 25%
- Сообщение: "Пройдите уровни 2-4 для добавления метрик"

Если есть v2, но нет v3:
- Показать метрики
- Прогресс 50%
- Недельный путь заблокирован

Если есть v3, но нет v4:
- Прогресс 75%
- Недельный путь активен, но без даты старта

Если есть v4:
- Полный функционал
- Отсчет 28 дней от start_date
- Все элементы активны
```

## 7. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ

### 7.1 База данных

```sql
-- Изменения в core_goals.version_data
-- Добавить поддержку partial updates через JSONB операторы
-- Каждое поле сохраняется отдельно при вводе

-- Новая таблица для отслеживания прогресса заполнения
goal_checkpoint_progress:
- user_id
- version
- field_name  
- completed_at
- max_interaction_id (для связи с чатом)

-- Триггер после UPDATE core_goals
-- Если изменилось version_data, отправить webhook Максу
```

### 7.2 API endpoints

```
POST /api/goal-field
- Сохраняет одно поле версии цели
- Триггерит генерацию ответа Макса
- Возвращает: success + следующее активное поле

GET /api/goal-progress/:version
- Возвращает какие поля уже заполнены
- Используется при открытии чекпоинта

POST /api/max-goal-comment
- Вызывается после сохранения поля
- Параметры: version, field_name, field_value, all_fields
- Возвращает: сообщение Макса для чата
```

### 7.3 Фронтенд

```
Компоненты для рефакторинга:

1. GoalCheckpointScreen:
   - Разделить на ChatSection и FormSection
   - Добавить пошаговую логику активации полей
   - Интегрировать автосохранение по полям

2. GoalScreen:
   - Новый layout с collapsible цитатой
   - Мини-дашборд с 3 виджетами
   - Аккордеон для недельного пути

3. WeeklyCheckinForm:
   - Сократить до 3 полей
   - Добавить динамическую подгрузку инструментов
   - Автовызов Макса после сохранения
```

## 8. МЕТРИКИ УСПЕХА

После внедрения отслеживать:

1. **Completion rate версий:**
   - v1 → v2: целевой 70% (сейчас ~40%)
   - v2 → v3: целевой 60%
   - v3 → v4: целевой 50%

2. **Engagement с Максом:**
   - Сообщений на пользователя: рост с 3 до 10+
   - Частота взаимодействий: минимум раз в 3 дня

3. **Недельные чек-ины:**
   - Week 1: 60% пользователей с v4
   - Week 2: 40%
   - Week 3: 30%
   - Week 4: 20%

4. **Время на заполнение:**
   - v1: не более 3 минут
   - v2: не более 2 минут
   - v3: не более 5 минут
   - v4: не более 3 минут

## 9. API: серверная реакция Макса на сохранение поля (goal_comment)

### 9.1 Событие и контракт

```
POST /functions/v1/leo-chat
Headers:
  Content-Type: application/json
  Authorization: Bearer <CRON_SECRET>
Body:
{
  "mode": "goal_comment",
  "version": <1|2|3|4>,
  "field_name": "<ключ поля>",
  "field_value": <json>,
  "all_fields": { ... }   // jsonb core_goals.version_data после merge
}
```

Ответ (успех):
```
{
  "message": { "role": "assistant", "content": "...короткий ответ Макса..." },
  "usage": { "prompt_tokens": n, "completion_tokens": m, "total_tokens": k },
  "recommended_chips": ["строки"] // опционально, подсказки по следующему шагу
}
```

Примечания:
- Тело запроса отправляет триггер/функция БД после частичного сохранения поля.
- Авторизация: только через `Authorization: Bearer <CRON_SECRET>` (без JWT пользователя).
- В этом режиме не используются история, RAG и списания GP.
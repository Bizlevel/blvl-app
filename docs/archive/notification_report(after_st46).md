## Отчёт по уведомлениям (после Этапа 46)

### 1. Текущее состояние (по коду и статус‑докам)
- **Локальные уведомления (OS‑level):**
  - Подключён `flutter_local_notifications` (^17.2.1). Инициализация и расписание выполняются в рантайме.
  - В `main.dart` выполняется подготовка таймзон (`timezone`), затем:
    - `NotificationsService.initialize()` — базовая инициализация плагина; на iOS запрашиваются разрешения (`alert/badge/sound`).
    - `NotificationsService.scheduleWeeklyPlan()` — планируются еженедельные напоминания: Пн 09:00 (план недели), Ср 14:00 (середина недели), Пт 16:00 (напоминание), Вс 10:00/13:00/18:00 (чек‑ин).
  - Сообщения/каналы: Android‑канал `goal_weekly_channel` (importance/prioritiy high).
  - Обработчик тапа по уведомлению не задан (нет deeplink‑навигации).

- **Внутренние уведомления (UI в приложении):**
  - Повсеместно используются `SnackBar` (навигация, ошибки/успехи сохранений, магазин GP и пр.).
  - `NotificationBox` (иконка «колокол» с бейджем) — декоративный индикатор в AppBar некоторых экранов (не связан с системными уведомлениями).

- **Покрытие платформ:**
  - iOS: разрешения запрашиваются корректно; локальные уведомления работают.
  - Android (<13): планирование уведомлений работает; канал создаётся.
  - Android (13+): разрешение `POST_NOTIFICATIONS` в манифесте отсутствует (см. раздел «Проблемы»).
  - Web: плагин не работает; инициализация обёрнута в `try/catch` — падений нет, уведомлений нет (по плану).

### 2. Что работает стабильно / Где есть проблемы
- **Работает:**
  - iOS локальные уведомления, Android до 13, UI‑`SnackBar`, визуальный `NotificationBox`.

- **Проблемы/риски:**
  1) Android 13+ требует явного разрешения: нет `<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>` и нет runtime‑запроса разрешения ⇒ уведомления не показываются.
  2) Таймзона: используется `DateTime.now().timeZoneName` для `tz.getLocation(...)`, что не всегда IANA‑идентификатор ⇒ возможный фолбэк на UTC и сдвиг времени уведомлений.
  3) Перезагрузка устройства: нет `RECEIVE_BOOT_COMPLETED` и логики восстановления расписания ⇒ уведомления могут «теряться» до повторного планирования.
  4) Тап по уведомлению ничего не делает (нет `onDidReceiveNotificationResponse`) ⇒ отсутствует переход на нужный экран (`/goal`, `/goal-checkpoint/:v` и т.д.).
  5) Small icon Android: используется `ic_launcher`, что может давать залитую квадратную иконку вместо монохромной **status**‑иконки.
  6) Remote push (FCM) отсутствует по MVP — ограничение по замыслу (не баг).

### 3. Куда добавить внутренние уведомления (in‑app)
- **Башня BizLevel:**
  - Баннер «Открыт доступ к этажу» с CTA «Перейти к этажу» (сейчас Snackbar; предложено унифицировать стилем/компонентом и добавить мини‑историю событий в «Центре уведомлений»).
  - Баннер «Чекпоинт цели доступен» (после завершения уровня 4/7/10) с CTA «Перейти к vN».
  - Информационные тултипы при блокировке узла («Завершите предыдущий уровень/кейс»), уже есть Snackbar — предложено добавить ненавязчивый info‑hint на плитке (hover/long‑press, a11y).

- **Уровни (уроки/квиз/артефакты):**
  - Toast/Banner «Видео недоступно — включён fallback», «Скачивание артефакта началось», «Файл сохранён/ошибка» (сейчас частично покрыто Snackbar; унифицировать).
  - Мини‑индикатор «Уровень завершён» (success‑индикатор есть компонентно; показывать централизованно).

- **Цель/чекпоинты:**
  - «Шаг сохранён / открыто следующее поле» — уже есть; унифицировать тексты и визуал (UIS).
  - «Версия vN готова на X% — что дальше?» — мягкая подсказка рядом с карточкой цели.

- **Чаты (Лео/Макс):**
  - В фоне (на других вкладках приложения): ненавязчивый in‑app баннер «Новый ответ от Макса/Лео» с переходом в чат (без системного пуша).
  - Подсказки‑чипы уже есть; добавить мягкий «подмигивающий» индикатор, если есть новые рекомендованные фразы.

- **GP/магазин:**
  - «Баланс низкий (<N GP)» — in‑app баннер с CTA «Пополнить». 
  - «Покупка ожидает подтверждения / Успешно / Ошибка верификации» — централизованный баннер вместо разрозненных Snackbar.

- **Библиотека:**
  - «Новые материалы в разделе X» — in‑app баннер после обновления данных (без навязчивости).

- **Центр уведомлений (необязательный, по клику на колокол):**
  - История последних 10–20 событий: «Открыт доступ к этажу», «Шаг v3 сохранён», «Успешная покупка 1400 GP», «Новый ответ Макса», «Добавлены новые курсы в Библиотеке».

### 4. Куда добавить внешние уведомления (OS‑level)
- **Цель и недельный цикл:**
  - Оставить текущие еженедельные напоминания (Пн/Ср/Пт/Вс), скорректировать локальное время через IANA‑таймзону.
  - Опционально: ежедневный «фокус‑слот» (1 уведомление в выбранное пользователем время, DND‑дружелюбные окна).
  - Чекпоинт цели v2/v3/v4 «готов/почти готов» (только при явном согласии). 

- **GP‑экономика:**
  - «Баланс ниже N GP — сообщения будут недоступны» (OS‑push), deeplink в `/gp-store`.
  - «Покупка GP: нужно завершить проверку» (если верификация отложена) / «Покупка подтверждена».

- **Чаты:**
  - «Новый ответ от Макса/Лео» (в будущем, при подключении сервера/FCM; локально не надёжно без фоновых задач). Deeplink в `/chat` c параметрами.

- **Библиотека:**
  - Раз в неделю дайджест новых материалов (FCM/opt‑in).

- **Deeplink‑маршруты для пушей:** `/goal`, `/goal-checkpoint/:version`, `/tower?scrollTo=N`, `/levels/:id`, `/gp-store`, `/chat?bot=max`, `/library`.

### 5. Рекомендации и план
- **М0 (фиксы без изменения концепции):**
  1) Android 13+: добавить в манифест `POST_NOTIFICATIONS` и вызывать runtime‑запрос разрешения при инициализации.
  2) Таймзоны: использовать `flutter_native_timezone` → IANA‑таймзона → `tz.setLocalLocation(...)`. Исключить зависимость от `DateTime.timeZoneName`.
  3) Добавить `onDidReceiveNotificationResponse` и маршрутизацию по тапу (deeplink на релевантный экран).
  4) Small icon: добавить монохромную `ic_stat_notify` и указать её в `AndroidInitializationSettings`.
  5) (Опционально) `RECEIVE_BOOT_COMPLETED` и восстановление расписаний после ребута.

- **М1 (улучшения локальных уведомлений и in‑app):**
  - Каналы/категории: разбить уведомления на типы (goal_weekly, goal_checkpoint, gp, chat) для контроля приоритетов.
  - Идемпотентное планирование: перед планированием — `cancelAll()` или точечный `cancel(id)`, хранить флаг/версию расписания в Hive.
  - Локализация текстов уведомлений; унификация внутренних уведомлений через общий компонент (баннер/инфо‑панель) + словарь `UIS`.
  - Центр уведомлений в приложении (по клику на «колокол»), с логированием событий (без PII).
  - A11y: Semantics для баннеров/кнопок уведомлений, min‑hit‑targets ≥44 px (согласовано с темой).

- **М2 (дорога к FCM):**
  - Подключить `firebase_messaging` (opt‑in), запросить разрешения (iOS/Android 13+), обрабатывать `onMessage`/`onBackgroundMessage`.
  - Проработать серверную отправку (через Supabase/Edge Functions/внешний воркер), без PII, с deeplink‑payload.
  - Наблюдаемость: добавлять `Sentry`‑breadcrumbs: `push_received`, `push_opened`, `local_notif_scheduled`.

### 6. Тест‑чеклист
- iOS: первый запуск → запрос разрешений → планирование → получение пуша в заданное время → тап открывает нужный экран.
- Android 13+: запрос `POST_NOTIFICATIONS` → при отказе мягкий fallback → при согласии пуши приходят.
- Перезагрузка устройства: расписание сохраняется/восстанавливается (если включим поддержку ребута).
- Web: отсутствие падений при инициализации (локальные уведомления отключены).
- Таймзоны: время доставки соответствует локальному времени пользователя (проверка 2–3 часовыми поясами).
- A11y: баннеры доступны читателям экрана; hit‑targets соблюдены.



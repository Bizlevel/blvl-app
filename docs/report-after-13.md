# Технический аудит проекта BizLevel (Финальный отчет)

## Executive Summary

Проект BizLevel представляет собой мобильное приложение на Flutter с бэкендом на Supabase. На данном этапе анализа проект демонстрирует использование **современного и адекватного технологического стека** (`Flutter 3+`, `Riverpod`, `Supabase`, `Sentry`), что является прочной основой для дальнейшего развития. Архитектура имеет **хорошее слоистое основание** (`models`, `services`, `providers`, `screens`), способствующее логическому разделению ответственности.

Ключевой и наиболее критичной находкой является **проблема сильной связанности (high coupling) из-за повсеместного использования статических классов-сервисов** (`AuthService`, `SupabaseService`). Этот архитектурный антипаттерн **критически снижает тестируемость** и гибкость приложения, являясь основным источником технического долга. Второй важной проблемой является **отсутствие централизованной системы навигации (роутера)**, что усложняет поддержку, обработку deep-линков и масштабирование UI-логики.

**Ключевые риски**:
1.  **Низкая тестируемость**: Невозможность написания юнит-тестов для ключевых компонентов бизнес-логики и UI.
2.  **Высокая стоимость изменений**: Любые изменения в базовых сервисах (например, замена Supabase) потребуют рефакторинга всего приложения.
3.  **Сложность поддержки навигации**: Логика переходов между экранами усложнена и децентрализована.
4.  **Наличие потенциального бага**: Обнаружена вероятная ошибка в логике обновления профиля пользователя, которая может влиять на онбординг.

**Приоритетные рекомендации**:
1.  **Рефакторинг сервисного слоя** с использованием Dependency Injection через Riverpod.
2.  **Внедрение `GoRouter`** для централизации и упрощения навигации.
3.  **Исправление бага** в `AuthService.updateProfile`.

## Детальный анализ

### 1. Архитектура и структура проекта
*   **Текущее состояние**: Проект использует слоеную архитектуру. Структура директорий (`models`, `providers`, `screens`, `services`, `widgets`) логична и понятна. Управление состоянием реализовано через `Riverpod`.
*   **Сильные стороны**:
    *   Четкое разделение ответственности на уровне директорий.
    *   Реактивное управление состоянием аутентификации через `StreamProvider` — эффективный подход.
    *   Принципы DRY и KISS частично соблюдаются на локальном уровне (например, переиспользуемые виджеты).
*   **Проблемы и риски**:
    *   **Нарушение принципов SOLID (Dependency Inversion)**: Компоненты высокого уровня (виджеты, провайдеры) напрямую зависят от конкретных реализаций низкого уровня (статические сервисы), а не от абстракций. (Приоритет: Высокий)
    *   **Отсутствие роутера**: Логика навигации реализована прямо в UI-слое (`main.dart`, `LoginScreen`), она сложна и зависит от нескольких асинхронных состояний. Это плохо масштабируется. (Приоритет: Высокий)
    *   **Отсутствие слоя репозитория**: Провайдеры напрямую обращаются к клиенту Supabase для выполнения запросов к БД. Для усложняющейся логики это приведет к дублированию кода и усложнению. (Приоритет: Средний)
*   **Рекомендации**:
    *   Преобразовать статические сервисы в инстанцируемые классы и предоставлять их через `Riverpod` провайдеры.
    *   Внедрить `GoRouter` для управления навигацией, создать карту маршрутов.
    *   Создать слой `Repository` (например, `UserRepository`, `LessonsRepository`) для инкапсуляции логики доступа к данным.

### 2. Технологический стек
*   **Текущее состояние**: Flutter `(>=3.0.0)`, `Riverpod`, `Supabase`, `Sentry`, `Freezed`, `flutter_lints`, `dio`, `video_player` и др.
*   **Сильные стороны**:
    *   Стек полностью современный и активно поддерживается сообществом.
    *   Выбранные технологии хорошо подходят для быстрой разработки MVP и дальнейшего масштабирования.
*   **Проблемы и риски**:
    *   Версии зависимостей в `pubspec.yaml` могут быть не последними. Требуется проверка и обновление. (Приоритет: Низкий)
    *   Файл `.env` включен в `assets`, что может привести к случайной компрометации секретов, если он попадет в систему контроля версий.
*   **Рекомендации**:
    *   Провести аудит версий зависимостей (`flutter pub outdated`) и обновить их.
    *   Убедиться, что `.env` файл находится в `.gitignore` и не попадает в репозиторий.

### 3. Качество кода
*   **Текущее состояние**: Используются линтеры (`flutter_lints`) и генерация кода (`freezed`), что положительно влияет на качество. Именование в целом понятное.
*   **Сильные стороны**:
    *   Использование `freezed` обеспечивает неизменяемость моделей данных.
    *   Наличие типизированной ошибки `AuthFailure` является хорошей практикой.
    *   Комментарии присутствуют и объясняют неочевидные моменты (например, про реактивную навигацию).
*   **Проблемы и риски**:
    *   **Нарушение DRY**: В `AuthService` дублируются блоки `try-catch`. (Приоритет: Средний)
    *   **Потенциальный баг**: В `AuthService.updateProfile` жестко прописано `onboarding_completed: false`. (Приоритет: Критический)
    *   **Ручное управление состоянием**: `LoginScreen` использует `setState` для управления флагом загрузки, хотя Riverpod предоставляет для этого более мощные инструменты. (Приоритет: Средний)
*   **Рекомендации**:
    *   Провести рефакторинг `AuthService` для устранения дублирования кода.
    *   Исследовать и исправить логику `updateProfile`.
    *   Рефакторить экраны с асинхронными операциями, перенеся управление состоянием (loading/error) в `StateNotifier` или `AsyncNotifier`.

### 4. Тестирование
*   **Текущее состояние**: В `dev_dependencies` есть `integration_test`, что говорит о возможном наличии интеграционных тестов. Однако, unit-тестирование затруднено.
*   **Проблемы и риски**:
    *   **Низкая тестируемость**: Из-за использования статических сервисов, написание юнит-тестов для виджетов и провайдеров, которые от них зависят, крайне затруднено. Невозможно проверить логику компонента, не делая реальных сетевых запросов. (Приоритет: Высокий)
*   **Рекомендации**:
    *   После рефакторинга сервисного слоя (внедрения DI), начать покрывать новую и существующую бизнес-логику юнит-тестами.
    *   Написать widget-тесты для ключевых экранов, используя переопределение провайдеров (`ProviderScope(overrides: ...)`).

*(Остальные пункты, такие как Безопасность, Производительность, DevOps, я заполню на основе лучших практик и экстраполяции, так как полный доступ к инфраструктуре отсутствует)*

### 5. Безопасность
*   **Текущее состояние**: Присутствуют базовые меры безопасности.
*   **Сильные стороны**:
    *   В конфигурации Sentry удаляется заголовок `Authorization`.
    *   Используется Supabase, который по умолчанию предоставляет хорошие механизмы защиты.
*   **Проблемы и риски**:
    *   **Row Level Security (RLS)**: Нет уверенности, что RLS в Supabase настроены корректно и для всех таблиц. Без этого пользователи потенциально могут получить доступ к чужим данным. (Приоритет: Критический)
    *   **Управление секретами**: `.env` в `assets` (уже упоминалось).
*   **Рекомендации**:
    *   **Провести полный аудит правил RLS в Supabase.** Каждая таблица с пользовательскими данными должна иметь политику, разрешающую чтение/запись только владельцу записи (`auth.uid() = user_id`).
    *   Хранить секреты для разных окружений (dev, prod) отдельно.

### 7. База данных (Supabase)
*   **Текущее состояние**: Используется `users` таблица для профилей.
*   **Рекомендации**:
    *   Проверить наличие индексов для всех внешних ключей и часто фильтруемых полей (`id`, `email`).
    *   Разработать и задокументировать стратегию миграций схемы БД. Использовать `supabase/migrations`.

## Технический долг

| Задача                                                                              | Описание                                                                                  | Приоритет    | Оценка времени (чел/дней) |
| ----------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------- | ------------ | ------------------------- |
| 1. Рефакторинг сервисного слоя (DI)                                                 | Преобразовать статические сервисы в инстанцируемые классы, предоставлять через Riverpod.   | **Высокий**  | 2-3                       |
| 2. Внедрение роутера (`GoRouter`)                                                   | Заменить всю навигацию на `GoRouter`, создать карту маршрутов.                            | **Высокий**  | 2-3                       |
| 3. Исправление бага в `updateProfile`                                               | Найти причину и исправить логику `onboarding_completed: false`.                           | **Критический**| 0.5                       |
| 4. Создание слоя репозиториев                                                       | Создать `UserRepository` и, возможно, другие, для инкапсуляции запросов к Supabase.       | Средний      | 1-2                       |
| 5. Рефакторинг UI-состояния (`LoginScreen` и др.)                                   | Заменить `setState` на `AsyncNotifier` / `StateNotifier` для асинхронных операций.       | Средний      | 1                         |
| 6. Аудит и обновление зависимостей                                                  | Проверить и обновить все пакеты в `pubspec.yaml`.                                         | Низкий       | 0.5                       |

## Roadmap рекомендаций

### Краткосрочные улучшения (1-2 недели)
1.  **Исправить баг в `updateProfile`** (Критический).
2.  **Провести рефакторинг сервисного слоя (DI)**. Это разблокирует возможность тестирования и является фундаментом для дальнейших улучшений.
3.  **Начать внедрение `GoRouter`** с ключевых экранов (Auth, Root).

### Среднесрочные улучшения (1-3 месяца)
1.  **Завершить миграцию на `GoRouter`** для всего приложения.
2.  **Покрыть юнит-тестами** всю бизнес-логику в сервисах и репозиториях.
3.  **Создать слой репозиториев** для всех сущностей.
4.  **Провести аудит и настроить RLS** в Supabase.
5.  **Начать писать widget-тесты** для основных пользовательских сценариев.

### Долгосрочные улучшения (3+ месяцев)
1.  Разработать CI/CD пайплайн для автоматического тестирования и сборки.
2.  Настроить детальный мониторинг производительности (Sentry Performance).
3.  Рассмотреть возможность внедрения E2E тестов (`integration_test` или `patrol`).

## Метрики и KPI

*   **Качество кода**:
    *   **Метрика**: Покрытие тестами (Test Coverage).
    *   **Baseline**: ~0% для юнит-тестов из-за проблем с DI.
    *   **Цель (3 мес.)**: > 60% для сервисов и репозиториев.
*   **Стабильность**:
    *   **Метрика**: Crash-free users (Sentry).
    *   **Baseline**: (Нужно посмотреть в Sentry).
    *   **Цель**: 99.5%
*   **Технический долг**:
    *   **Метрика**: Количество задач по рефакторингу в бэклоге.
    *   **Baseline**: ~6 (согласно отчету).
    *   **Цель**: Систематическое уменьшение, не более 1-2 критических задач в любой момент времени.

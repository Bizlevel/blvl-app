### Отчёт: Маршруты, логика и промпты ботов Лео и Макс

Этот документ описывает, где и как в приложении участвуют боты Лео и Макс, какие источники данных они используют, как формируются их промпты (по режимам), и как устроен жизненный цикл данных от экрана до Edge Functions и БД. Основано на текущем состояниии кода и документации проекта (`docs/status.md`, `docs/bizlevel-concept.md`).

### 1) Где участвуют боты (экраны и маршруты)

- **Общий экран чатов**: `LeoChatScreen` (маршрут `/chat`)
  - Переключение бота: Лео или Макс (состояние списка чатов и FAB зависят от выбранного бота).
  - Список диалогов фильтруется по полю `bot` в таблице `leo_chats` и скрывает пустые чаты (с `message_count = 0`).
  - Создание чата происходит только после первого сообщения пользователя (нет «пустых» чатов).
  - Источники: `leo_chats` (бот, summary, last_topics, message_count), `leo_messages` (история). Баланс GP отображается в UI отдельно.

- **Диалог**: `LeoDialogScreen` (в полноэкранном и embedded режимах)
  - Полноэкранный режим: из `/chat`, с выбранным ботом.
  - Embedded-режим: внутри чекпоинтов цели (см. ниже), без bottom sheet.
  - Отображает историю сообщения, отправляет текст на Edge Function `/leo-chat`.
  - Для Макса может отображать «чипы» быстрых ответов (`recommended_chips`).

- **Карта уровней / Уроки**: `LevelDetailScreen`
  - `FloatingChatBubble`: на видеоблоках и квизах – открывает `LeoDialogScreen` (по умолчанию с Лео). Формируется `systemPrompt` контекста блока/урока.
  - Квиз-блок `_QuizBlock`: использует `LeoQuizWidget` (режим `mode='quiz'` для `/leo-chat`). Квиз-режим не тратит GP и не создаёт чатов.

- **Страница цели**: `GoalScreen`
  - Кнопка «Обсудить с Максом» → полноэкранный `LeoDialogScreen(bot='max')`.
  - Макс использует контекст цели и недельного пути, если они есть, для персонализации.

- **Чекпоинты цели (v2/v3/v4)**: `GoalCheckpointScreen` (маршрут `/goal-checkpoint/:version`)
  - Встроенный чат Макса (embedded `LeoDialogScreen`) с контекстом текущей версии цели.
  - Кнопка «Применить предложение» позволяет префиллить форму версии данными из ответа ассистента и затем сохранить через `GoalsRepository`.

- **Мини‑кейсы**: `MiniCaseScreen` (маршрут `/case/:id`)
  - Диалог в режиме `case` (см. ниже). Не тратит GP, не создаёт чатов Лео/Макса.

Сопутствующие файлы/виджеты: `lib/services/leo_service.dart`, `lib/screens/leo_dialog_screen.dart`, `lib/widgets/leo_quiz_widget.dart`, `lib/screens/level_detail_screen.dart`, `lib/screens/goal/goal_checkpoint_screen.dart`, `lib/screens/goal/goal_screen.dart`, `lib/widgets/floating_chat_bubble.dart`, `lib/screens/leo_chat_screen.dart`.

### 2) Источники данных и их доступность

- **Профиль пользователя (`public.users`)**
  - Поля: `id`, `email`, `name`, `about`, `goal`, `avatar_id`, `persona_summary`, `current_level`, (и др.).
  - Заполняется на уровне 0 (профиль) и может обновляться позднее (в т.ч. аватар, цель, о себе). `persona_summary` формируется на стороне сервера/функций.

- **Цель и версии (`public.core_goals`)**
  - Версии: v1 (уровень 1), v2 (после уровня 4), v3 (после уровня 7), v4 (после уровня 10).
  - Используются Максом для персонализации и контекста диалога; на чекпоинтах доступны для редактирования/создания.

- **Недельный путь (`public.weekly_progress`)**
  - Поля: `planned_actions`, `completed_actions`, `completion_status`, `metric_value`, `metric_progress_percent`, `artifacts_details`, `consulted_benefit`, `techniques_details`, `chat_session_id`, `updated_at`, `week_number`.
  - Используется Максом (контекст недели, прогресс, итоги; при сохранении чек‑ина автоматически инициируется чат Макса).

- **Чаты и сообщения**
  - `public.leo_chats`: `id`, `user_id`, `bot` ('leo'|'max'), `summary`, `last_topics`, `message_count`, `updated_at`.
  - `public.leo_messages`: история сообщений (user/assistant), служебные поля; на ответ ассистента срабатывает триггер памяти.

- **Память пользователя (`public.user_memories`)**
  - Хранятся извлечённые факты и подсказки; наполняются Edge Function `leo-memory` (по триггеру и в cron‑режиме), доступны для включения в контекст `/leo-chat`.

- **RAG‑документы (`public.documents`)**
  - Эмбеддинги, метаданные (`level_id`, `skill_id`, `title`, `section`, `tags`). Поиск через RPC `match_documents(metadata_filter jsonb)`.
  - Лео использует RAG для ответов по материалам уровня/скилла (фильтрация по `levelContext`).

- **Навыки/прогресс**
  - `public.skills`, `public.user_skills` (+1 очко навыка по завершению уровня, через RPC `update_current_level`).

- **GP‑ядро (кошелёк и операции)**
  - Таблицы: `gp_wallets`, `gp_ledger`, `gp_purchases`, `gp_bonus_rules`, `gp_bonus_grants`, `floor_access`, `packages`, `package_items`, `user_packages`.
  - RPC: `gp_balance`, `gp_spend`, `gp_floor_unlock` (или пакетная `gp_package_buy`), `gp_bonus_claim`, `gp_purchase_*`.
  - Списание 1 GP за сообщение в чате (кроме режимов `quiz`/`case`). Есть фича‑флаг `kDisableGpSpendInChat` (временно выключает списания).

Все таблицы под RLS (owner‑only на пользовательских данных). Ошибки логируются без PII в Sentry.

### 3) Канал взаимодействия: Edge Function `/leo-chat`

- **Параметры запроса** (клиент → сервер):
  - `bot`: `'leo' | 'max'` (определяет персоналию и набор контекстов).
  - `mode`: `'default' | 'quiz' | 'case'` (режим диалога: полноценный, чат‑квиз, мини‑кейс).
  - `message`: пользовательское сообщение (обязательно для создания/продолжения чата).
  - `system`/`systemPrompt` (опционально): локальный системный контекст (например, из уровня/блока).
  - `userContext`/`levelContext` (опционально): ID уровня, краткая выжимка, и т.д. (для RAG/персонализации).

- **Серверный сбор контекста** (сервер → конструктор промпта):
  - Общие источники: профиль (`users`), свёртки/summary и `last_topics` из `leo_chats`, «память» (`user_memories`).
  - Для Лео: фокус на уровне/уроке, поиск по `documents` через `match_documents` с `metadata_filter` (например, `level_id`, `skill_id`, `tags`).
  - Для Макса: цель (v1–v4), недельный путь (`weekly_progress`), напоминания/проверки, цитата дня (`motivational_quotes`); может возвращать `recommended_chips`.
  - История диалога и свёртки дозируются, чтобы вписаться в лимит токенов (кэш на 2–5 мин для персоны и RAG).

- **Ответ функции** (сервер → клиент):
  - `assistant_message` (обязательный текст ответа), опционально `recommended_chips` (для Макса), служебные поля.
  - После ответа триггер вызывает `leo-memory` (идемпотентное извлечение фактов, upsert в `user_memories`, обновление `leo_chats.summary/last_topics`).

### 4) Режимы и конструктор промптов

- **Лео (bot='leo', mode='default')**
  - Роль: бизнес‑ментор по материалам уровня/скилла; даёт краткие практические рекомендации, персонализирует примеры.
  - Контекст: профиль (имя/цель/о себе/персона), RAG‑документы по `levelContext`, свёртки чата, релевантные «памятки».
  - Гайдлайны: короткий, структурированный, без PII, с actionable‑шагами; может ссылаться на артефакты уровня.
  - Скелет промпта (концептуально):
    1) «Ты — Лео, бизнес‑ментор BizLevel…»
    2) «Контекст пользователя: … (имя, цель, ключевые факты)»
    3) «Материалы (RAG): … (тезисы из документов)»
    4) «История/свёртки: … (кратко)»
    5) «Отвечай кратко, по шагам, предложи следующий конкретный шаг/артефакт»

- **Макс (bot='max', mode='default')**
  - Роль: трекер цели; помогает формулировать/уточнять версии v1–v4, недельные планы/итоги, держит фокус и динамику.
  - Контекст: `core_goals` v1–v4, `weekly_progress` (текущая неделя, статус/метрика), напоминания, «память», цитата дня.
  - Может вернуть `recommended_chips` (быстрые фразы) – клиент отобразит их как «чипы» под полем ввода.
  - Скелет промпта (концептуально):
    1) «Ты — Макс, коуч‑трекер BizLevel…»
    2) «Цель пользователя (v1–v4): …»
    3) «Неделя N: план/выполнение/метрика …»
    4) «Контекст/память: …»
    5) «Дай конкретный, дружелюбный, мотивационный ответ; предложи следующий шаг и 2–4 быстрых варианта ответов (chips)»

- **Квиз (mode='quiz')** — применяется в `LeoQuizWidget` внутри уровней
  - Назначение: проверить ответ на вопрос (варианты), дать краткий фидбек.
  - Контекст: минимальный; RAG/«память»/история отключены; не создаёт чат, не тратит GP.
  - Скелет промпта: «Проверь ответ пользователя на вопрос X. Ответь кратко: правильно/неправильно + короткая подсказка; без лишнего контекста».

- **Мини‑кейс (mode='case')** — в `MiniCaseScreen`
  - Назначение: короткая фасилитация кейса; как квиз‑режим, без RAG/истории/GP.
  - Скелет промпта: «Смоделируй быстрый разбор кейса: задай 1–2 уточнения, предложи 1 практический шаг».

Примечание: точные тексты серверных промптов развиваются и «усилены» для Макса под версии v2/v3/v4; клиент передаёт только вспомогательный `systemPrompt` по необходимости (например, контекст блока урока).

### 4.1) Шаблоны промптов (используемые тексты) и области применения

Ниже приведены безопасные шаблоны промптов, отражающие текущую спецификацию. Они используются на стороне Edge Function `/leo-chat` (сервер формирует итоговый промпт из блоков ниже и собранного контекста). Клиент может добавлять локальный `systemPrompt` для уровня/блока.

- [ЛЕО • default] (Сценарии: A, F)
  «Ты — Лео, бизнес‑ментор платформы BizLevel. Отвечай кратко и по делу, давай чёткие, применимые шаги. Учитывай контекст пользователя и материалы уровня. Когда уместно, ссылайся на практики/артефакты уровня. Избегай PII и не раскрывай внутренние данные.
  Контекст пользователя: {{user_profile_summary}}
  Материалы (RAG): {{rag_theses}}
  Свёртка диалога: {{chat_summary}}
  Памятки: {{user_memories_snippets}}
  Задача: ответь на сообщение пользователя максимально практично (списком шагов), предложи следующий конкретный шаг.»

- [ЛЕО • quiz] (Сценарии: B)
  «Режим проверки ответа. Вопрос: {{question}}
  Ответ пользователя: {{user_answer}}
  Правильный ответ: {{correct_answer}}
  Инструкция: ответь одним‑двумя предложениями: “Правильно/Неправильно” и короткая подсказка. Не используй историю, RAG или память.»

- [МАКС • default] (Сценарии: C, D, F)
  «Ты — Макс, коуч‑трекер целей BizLevel. Отвечай дружелюбно, мотивирующе и конкретно. Учитывай текущую версию цели и недельный прогресс. Предлагай следующий шаг и 2–4 коротких варианта ответов (chips), если уместно.
  Профиль/персона: {{user_profile_summary}}
  Цель (версии v1–v4): {{goal_versions_compact}}
  Текущая неделя: {{weekly_progress_compact}}
  Свёртка диалога: {{chat_summary}}
  Памятки: {{user_memories_snippets}}
  Цитата дня: {{quote_of_the_day_optional}}
  Задача: помоги сфокусироваться на ближайшем шаге и метрике. Предложи чипы быстрых ответов при необходимости.»

- [МИНИ‑КЕЙС • case] (Сценарии: E)
  «Режим мини‑кейса. Сформулируй 1–2 уточняющих вопроса и предложи 1 практический шаг. Не используй историю, RAG или память. Будь кратким.»

Метки применения по сценариям A–H:
- A (урок → чат Лео): [ЛЕО • default]
- B (квиз): [ЛЕО • quiz]
- C (чекпоинт цели embedded): [МАКС • default]
- D (страница цели): [МАКС • default]
- E (мини‑кейс): [МИНИ‑КЕЙС • case]
- F (экран чатов): [ЛЕО • default] или [МАКС • default] по выбору бота
- G/H — не промпты, а служебная логика устойчивости/кэша

### 5) Жизненный цикл и события

- **Создание сообщения**: пользователь вводит текст → клиент (через `LeoService`) при необходимости списывает 1 GP (`gp_spend`, тип spend_message) → вызывает `/leo-chat`.
- **Ответ ассистента**: сервер формирует ответ, возвращает в клиент; клиент добавляет в ленту.
- **Память**: триггер на `leo_messages` запускает `leo-memory`, которая извлекает факты и обновляет `user_memories`/свёртки чата (`leo_chats.summary/last_topics`).
- **Инвалидации и кэш**: при ключевых действиях (покупка GP, завершение уровня, сохранение версии цели, чек‑ин недели) инвалидаируются провайдеры (`gpBalanceProvider`, `levelsProvider`, `goalLatestProvider`, `goalVersionsProvider`, `userSkillsProvider`, `towerNodesProvider`).
- **Безопасность/устойчивость**: RLS owner‑only, Sentry без PII/JWT, экспоненциальные ретраи сети, `refreshSession` при 401 (вызовы Edge).

### 6) Перечень таблиц/функций, задействованных ботами

- Чаты: `leo_chats(bot, summary, last_topics, message_count)`, `leo_messages` (+триггер вызова `leo-memory`).
- Память: `user_memories` (ANN‑индексы HNSW/IVFFLAT, upsert фактов), Edge Function `leo-memory`.
- Контекст цели: `core_goals` (версии v1–v4), `weekly_progress` (+индексы и триггеры `updated_at`).
- RAG: `documents` (+индексы по embedding и GIN по metadata), RPC `match_documents(metadata_filter jsonb)`.
- Профиль: `users` (в т.ч. `persona_summary`, `current_level`).
- GP: RPC `gp_balance`, `gp_spend`, `gp_bonus_claim`, `gp_floor_unlock` или `gp_package_buy` (пакетный доступ), таблицы `gp_*`, `floor_access`, `packages`, `user_packages`.

### 7) Сквозные сценарии

- **Квиз уровня (Leo, quiz)**: `_QuizBlock` → `LeoQuizWidget` → `/leo-chat(mode=quiz)` → краткий ответ → при верном ответе разблокируется «Далее». GP не списывается, чаты не создаются.
- **Урок/видео (Leo, default)**: `FloatingChatBubble` → `LeoDialogScreen(bot='leo')` → `/leo-chat` с `systemPrompt` блока/урока и `levelContext` → ответ с учётом RAG‑документов.
- **Чекпоинт цели (Max, embedded)**: `GoalCheckpointScreen` → встроенный `LeoDialogScreen(bot='max')` → `/leo-chat` → «Применить предложение» заполняет форму → сохранение версии → инвалидации и возврат на башню.
- **Страница цели (Max, default)**: `GoalScreen` → «Обсудить с Максом» → `LeoDialogScreen(bot='max')` → `/leo-chat` с контекстом цели/недели → возможные `recommended_chips`.
- **Мини‑кейс (case)**: `MiniCaseScreen` → `/leo-chat(mode=case)` → краткая фасилитация без истории/GP/RAG.

### 8) Навигация и гейтинг

- Навигация GoRouter: `/chat`, `/levels/:id`, `/goal`, `/goal-checkpoint/:version`, `/case/:id`, `/tower` и др.
- Доступ уровней >3 через GP (этажи), покупка через RPC пакета `gp_package_buy('FLOOR_<n>')`, статус доступа синхронизируется в `floor_access` и `user_packages`.
- Чекпоинты цели и мини‑кейсы встроены в «Башню»; последовательность: предыдущий узел должен быть завершён; квизы/кейсы не тратят GP.

### 9) Примечания по Sentry и устойчивости

- В клиенте включены breadcrumbs по основным событиям: открытия чатов/башни, GP‑операции, автоскролл башни, ретраи.
- Исключены утечки JWT/PII: `beforeSend` чистит события, сетевые ошибки обрабатываются дружелюбно.
- На 401/Invalid JWT — единоразовый `refreshSession` в `LeoService` перед повтором запроса к Edge.

---

Если понадобится конкретика по участкам кода, см.: `lib/services/leo_service.dart` (вызовы `/leo-chat`, режимы, GP‑списания и ретраи), `lib/widgets/leo_quiz_widget.dart` (quiz‑режим), `lib/screens/leo_dialog_screen.dart` (диалог, embedded/полноэкранный), `lib/widgets/floating_chat_bubble.dart` (системные промпты в уровнях), `lib/screens/goal/goal_checkpoint_screen.dart` (встроенный чат Макса и «Применить предложение»), а также миграции/описания функций в `docs/status.md` и архитектурные детали в `docs/bizlevel-concept.md`.

### 10) Путь пользователя: когда что включается для генерации ответа

Ниже — сквозные сценарии с точками, где подключаются алгоритмы, промпты и данные.

- **A) Урок → чат с Лео (mode=default)**
  1) Пользователь находится на `LevelDetailScreen` в блоке «Видео»/«Описание».
  2) Нажимает `FloatingChatBubble` → открывается `LeoDialogScreen(bot='leo')`.
  3) Клиент формирует payload:
     - `bot='leo'`, `mode='default'`
     - `message`: ввод пользователя
     - `systemPrompt`: краткий контекст блока/урока (локальный)
     - `levelContext`: id/код уровня, опц. краткая выжимка
  4) До отправки (если `kDisableGpSpendInChat=false`) → `GpService.spend(type=spend_message, amount=1, idempotency_key)` (RPC `gp_spend`). На недостатке баланса: модал «Пополнить GP».
  5) Вызов Edge `/leo-chat`.
  6) Сервер строит промпт Лео:
     - Добавляет профиль (имя/цель/о себе/персона)
     - Подтягивает RAG‑материалы через `match_documents(metadata_filter={level_id/skill_id/tags})`
     - Краткие свёртки истории чата и «памятки» (`user_memories`)
  7) Ответ → клиент отображает; триггер `leo-memory` извлекает факты и обновляет `user_memories` и `leo_chats.summary/last_topics`.
  8) Фоном инвалидируется `gpBalanceProvider`.

- **B) Квиз в уроке (LeoQuizWidget, mode=quiz)**
  1) Пользователь выбирает вариант в `_QuizBlock`.
  2) Клиент формирует payload: `bot='leo'`, `mode='quiz'`, `message` с контекстом вопроса/ответа.
  3) GP не списывается, чат не создаётся.
  4) Edge `/leo-chat` формирует краткий проверочный ответ без истории/RAG/памяти.
  5) Клиент показывает фидбек; при верном ответе разблокируется «Далее».

- **C) Чекпоинт цели v2/v3/v4 (embedded Макс, mode=default)**
  1) Экран `GoalCheckpointScreen(:version)` загружает текущие данные версии через `GoalsRepository`.
  2) Встроенный `LeoDialogScreen(bot='max', embedded=true)`.
  3) Отправка сообщения: (если списания включены) GP −1 через `gp_spend` → Edge `/leo-chat`.
  4) Сервер строит промпт Макса:
     - `core_goals` (актуальная версия, истории версий)
     - `weekly_progress` (если есть), напоминания/проверки, цитата дня
     - «Память» и свёртки чатов Макса
  5) Ответ может включать `recommended_chips`.
  6) Кнопка «Применить предложение» префиллит форму версии; «Сохранить» → `GoalsRepository` → инвалидация `goalLatest/goalVersions` → возврат в `/tower?scrollTo=<next>`.

- **D) Страница цели → чат с Максом (mode=default)**
  1) На `GoalScreen` пользователь нажимает «Обсудить с Максом» → `LeoDialogScreen(bot='max')`.
  2) Клиент: (опц.) GP −1 → Edge `/leo-chat`.
  3) Сервер: как в (C), но без формы версии; при наличии `weekly_progress.chat_session_id` может подмешать контекст недели.
  4) Ответ + `recommended_chips` → клиент показывает чипы как быстрые вставки текста.
  5) После сохранения чек‑ина недели (в другом блоке) автоматически открывается чат Макса с контекстом недели.

- **E) Мини‑кейс (mode=case)**
  1) `MiniCaseScreen` открыт из «Башни».
  2) Клиент вызывает `/leo-chat(mode='case')` без списания GP и без истории/RAG.
  3) Сервер даёт короткую фасилитацию; чат не сохраняется как `leo_chats`.

- **F) Общий экран чатов (`/chat`)**
  1) Пользователь выбирает бота (Лео/Макс) — список фильтруется по `leo_chats.bot`.
  2) «Новый диалог» создаётся только после первого пользовательского сообщения (избегаем пустых чатов).
  3) Отправка сообщения: (опц.) GP −1 → Edge `/leo-chat`.
  4) Макс может вернуть `recommended_chips`.

- **G) Ошибки/устойчивость и токены**
  1) 401/Invalid JWT → `LeoService.refreshSession()` и одноразовый повтор запроса.
  2) Сеть: экспоненциальный retry; дружелюбные ошибки в UI; Sentry без PII.
  3) Фича‑флаг `kDisableGpSpendInChat=true` отключает списание GP на клиенте (временный режим «бесплатно»).

- **H) Кэширование и инвалидации**
  1) Сервер кэширует персонализацию/RAG (2–5 мин) для снижения latency.
  2) Клиент (Hive SWR) кэширует уровни/уроки/цели/GP; при сохранениях/покупках/завершениях — инвалидация соответствующих провайдеров.


Отчёт по проблемам «урок-видео» и «завершение уровня»
Как «должно» работать (см. bizlevel-concept / implementation-plan)
 • При открытии уровня последовательно показывается: видео-урок → мини-квиз.
 • Видео берётся из поля lessons.video_url (предполагалось, что это либо прямой .mp4/HLS, либо обычная Vimeo-ссылка, которую приложение конвертирует в прямой url).
 • После прохождения всех уроков плавающая кнопка «Завершить уровень» должна:
  – создать/обновить запись в user_progress (is_completed = true);
  – поднять users.current_level, чтобы разблокировать следующий уровень;
  – вернуть пользователя на карту уровней c обновлённым прогрессом.
Что происходит сейчас
 a) Видео не воспроизводится
  • В логе видно несколько ошибок Failed to resolve Vimeo url … status code 403 и далее Video init error: PlatformException(VideoError … OSStatus -12847).
  • LessonWidget.resolvePlayableUrl делает GET https://player.vimeo.com/video/{id}/config. Если Vimeo-ролик закрыт (privacy «Private» / «Only on …»), этот энд-поинт отдаёт 403, а наша функция оставляет исходный url «https://vimeo.com/{id}».
  • video_player не умеет проигрывать веб-страницу, получает CoreMediaError и отрисовывает «Видео недоступно», что и видит пользователь (четыре спиннера → заглушка).
 b) «Завершить уровень» остаётся заглушкой
  • В LevelDetailScreen FloatingActionButton просто показывает SnackBar (‘Уровень завершён (заглушка)’).
  • Нет записи в user_progress и не меняется users.current_level, поэтому уровень не считается пройденным, прогресс не обновляется.
Причины и рекомендации
  1) Провал загрузки видео
  • Причина — неправильный/закрытый источник. В status.md уже отмечено: «Видео … возвращает 403 — нужно использовать прямые mp4/HLS ссылки».
  Решения (минимальные правки кода / данных):
   a. В Supabase→lessons.video_url сразу хранить прямой progressive .mp4 либо HLS .m3u8 (можно получить из Vimeo вручную — меню → Embed → «Download»). Тогда LessonWidget минует вызов config-API и просто кэширует файл.
   b. Либо открыть видео в Vimeo (privacy = “Public”/“Hide from Vimeo but allow embedding”), чтобы https://player.vimeo.com/video/{id}/config отдавал JSON без 403.
   c. Если видео должно быть приватным — использовать Vimeo oAuth API и сервер-side proxy (больше кода; не рекомендуется для MVP).
   d. Альтернатива «без Vimeo» — залить mp4 в Supabase Storage и давать signed URL (уже есть вспомогательный метод getArtifactSignedUrl).
  2) Завершение уровня
  • Нужно реализовать логику в LevelDetailScreen вместо SnackBar:
   a. SupabaseService.addOrUpdateProgress(levelId)
    – upsert в table user_progress {user_id, level_id, is_completed = true}.
    – если user.current_level == текущий level.number → инкрементировать users.current_level.
   b. После успешного апдейта: Navigator.pop(context) (вернуться на карту уровней) или показывать диалог «Уровень X завершён!».
   c. Обновить levelsProvider/LevelsMapScreen, чтобы считать completed статус (select levels left join user_progress). Тогда карта уровней сразу подсветит новый открытый уровень.
Ошибки побочного характера
 • В логе также есть setState() called after dispose из LeoDialogScreen — вызывается, если пользователь быстро вышел из чата во время await. Перед setState() достаточно добавить if (!mounted) return; (не блокирует текущую задачу).
Приоритет следующих действий
 1) Данные: заменить ссылки video_url на рабочие mp4/HLS (быстрее всего).
 2) Код:
  – в resolvePlayableUrl добавить лог более понятный пользователю (SnackBar «Видео недоступно, свяжитесь с поддержкой»).
  – реализовать SupabaseService.updateProgress() и вызвать его из LevelDetailScreen.
 3) Затем прогнать tests/auth_flow & levels_system — они падали именно из-за 403/заглушки.
После этих правок пользователь должен видеть реальные видео и возможность завершать уровни, а карта уровней — корректный прогресс.
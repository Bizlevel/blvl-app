Что сделать дальше (в Supabase). У меня нет app.service_role_key
1) Починить запуск leo-memory по триггеру
Проверить/задать переменные в БД, которые использует HTTP‑вызов:
sql
-- Проверка
SELECT current_setting('app.supabase_url', true)  AS supabase_url,
       current_setting('app.service_role_key', true) AS service_role_key;

-- Если пусто — установить (подставьте ваши значения):
ALTER DATABASE postgres SET app.supabase_url = 'https://<YOUR_PROJECT>.supabase.co';
ALTER DATABASE postgres SET app.service_role_key = '<YOUR_SERVICE_ROLE_KEY>';

-- Применить сразу для текущей сессии:
SELECT set_config('app.supabase_url', 'https://<YOUR_PROJECT>.supabase.co', false);
SELECT set_config('app.service_role_key', '<YOUR_SERVICE_ROLE_KEY>', false);



Задать секрет для edge‑функции leo-memory:
  - В Supabase Studio → Edge Functions → leo-memory → Settings → Add secret.
  - CRON_SECRET = Cron_Bizlevel_2025
  - Redeploy функции leo-memory.

2) Протестировать пайплайн памяти
Ручной вызов триггерной функции (используем последний ассистентский месседж):
sql
WITH m AS (
  SELECT id, chat_id, user_id, content
  FROM public.leo_messages
  WHERE role = 'assistant'
  ORDER BY created_at DESC
  LIMIT 1
)
SELECT public.call_leo_memory(m.id, m.chat_id, m.user_id, m.content, NULL)
FROM m;



Отправить новое сообщение Лео (чтобы сработал AFTER INSERT триггер).
Проверить обработку:
sql
SELECT m.id, p.processed_at
FROM leo_messages m
LEFT JOIN leo_messages_processed p ON p.message_id = m.id
WHERE m.role = 'assistant'
ORDER BY m.created_at DESC
LIMIT 5;

-- Итоги чата
SELECT summary, last_topics
FROM leo_chats
WHERE id = '<chat_id>';



3) Убедиться, что RAG использует метаданные (smoke)
Проверка RPC в SQL (используем embedding из документа уровня 1):
sql
SELECT (match_documents(d.embedding, 0.35, 6, '{"level_id":1}'::jsonb)).*
FROM public.documents d
WHERE (d.metadata->>'level_id')::int = 1
LIMIT 1;


Отправить вопрос Лео с текущим levelContext (клиент его шлёт автоматически) и посмотреть логи edge‑функции leo-chat:
  - Должно быть: “levelContext from client: ЕСТЬ” и без ошибок “RAG match_documents error”.

4) Для “Алекса” (конкретика ответа)
Чтобы ответы были предметнее (без RAG), заполните минимум по вашему user_id:
sql
INSERT INTO public.core_goals(user_id, version, goal_text, version_data, updated_at)
VALUES ('<USER_ID>', 1, 'Открыть точку кофе за 28 дней', '{"metric":"ежедневная выручка, тенге"}'::jsonb, now());

INSERT INTO public.weekly_progress(user_id, sprint_number, achievement, metric_actual, created_at)
VALUES ('<USER_ID>', 1, 'Выбрана локация, заключена аренда', 'выручка=0', now());

INSERT INTO public.reminder_checks(user_id, day_number, reminder_text, is_completed)
VALUES ('<USER_ID>', 1, '5 холодных звонков поставщикам', false);

INSERT INTO public.motivational_quotes(quote_text, author, is_active)
VALUES ('Дорогу осилит идущий', 'Народная мудрость', true);



Что прповерить
Появился ли summary/last_topics в leo_chats.
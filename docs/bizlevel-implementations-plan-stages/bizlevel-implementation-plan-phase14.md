# Этап 47: Уведомления

## Задача 47.1: M0 — критические исправления локальных уведомлений
**Цель:** обеспечить базовую работоспособность локальных уведомлений на iOS/Android с корректной таймзоной, разрешениями, deeplink‑навигацией, small‑icon и идемпотентным расписанием. Основано на `docs/notification_report_enhanced.md`.
**Пакеты/доки:**
- `flutter_local_notifications` — `https://pub.dev/packages/flutter_local_notifications`
- `timezone` — `https://pub.dev/packages/timezone`
- `flutter_native_timezone` — `https://pub.dev/packages/flutter_native_timezone`
- GoRouter — `https://pub.dev/packages/go_router`
- Android 13+ POST_NOTIFICATIONS — `https://developer.android.com/develop/ui/views/notifications/notification-permission`
**Действия:**
1) Android 13+ разрешения:
   - Добавить в `android/app/src/main/AndroidManifest.xml`:
   ```xml
   <uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>
   ```
   - Запрашивать разрешение через API плагина (без `permission_handler`):
   ```dart
   final androidPlugin = FlutterLocalNotificationsPlugin()
     .resolvePlatformSpecificImplementation<AndroidFlutterLocalNotificationsPlugin>();
   await androidPlugin?.requestNotificationsPermission();
   ```
   - Гвард по версии Android: вызывать запрос только при `SDK >= 33` (Android 13+) — иначе пропускать.
2) Таймзоны (IANA):
   - Подключить `flutter_native_timezone`; заменить установку локали:
   ```dart
   final name = await FlutterNativeTimezone.getLocalTimezone();
   tz.setLocalLocation(tz.getLocation(name));
   ```
3) Deeplink‑навигация по тапу:
   - При инициализации `_plugin.initialize(...)` добавить обработчик:
   ```dart
   await _plugin.initialize(
     initSettings,
     onDidReceiveNotificationResponse: (details) {
       final payload = details.payload;
       if (payload == null) return;
       final data = json.decode(payload);
       AppRouter.instance.go(data['route']); // "/goal", "/tower", ...
     },
   );
   ```
   - При планировании добавлять `payload`, например: `{ "route": "/goal" }`.
4) Android small icon:
   - Добавить монохромный ресурс `ic_stat_tower` и использовать его в настройках Android канала.
5) Boot‑receiver (опционально):
   - Добавить `RECEIVE_BOOT_COMPLETED` и ресивер, который выполняет `scheduleWeeklyPlan()` после перезагрузки.
6) Идемпотентность расписания:
   - Использовать стабильные ID уведомлений (как сейчас: 1001/1002/1003/11xx) и безопасно вызывать планирование на старте.
7) Обработка холодного старта:
   - При запуске приложения читать `getNotificationAppLaunchDetails()`; если присутствует payload с маршрутом — выполнить «отложенную» навигацию после инициализации роутера (`AppRouter.instance`).
**Критерии приёмки:**
- Android 13+: при первом запуске запрашивается разрешение; при отказе приложение не падает; при разрешении уведомления приходят по расписанию.
- Таймзона соответствует локальной (проверка на 3+ IANA‑поясах).
- Тап по уведомлению открывает нужный экран из любого состояния (foreground/background/terminated).
- В статус‑баре Android отображается монохромная small‑icon.

## Задача 47.2: Каналы уведомлений и сегментация (Android)
**Цель:** разделить уведомления по каналам для управляемости и UX.
**Каналы:**
- `goal_critical` (MAX) — важные цели/дедлайны
- `goal_reminder` (HIGH) — план/середина недели/чекин
- `gp_economy` (HIGH) — покупки/баланс
- `education` (DEFAULT) — материалы/курсы/библиотека
- `chat_messages` (HIGH) — ответы ИИ‑тренеров
**Действия:**
- Создать каналы один раз при инициализации на Android через `AndroidNotificationDetails` и/или метод регистрации каналов.
- Привязать существующие еженедельные уведомления к `goal_reminder`.
- Подготовить маппинг каналов под будущие сценарии (GP/чат/библиотека).
**Критерии приёмки:**
- Каналы видны в настройках приложения на Android; уведомления приходят в соответствующие каналы.

## Задача 47.3: In‑app баннеры и замена Snackbar в ключевых местах
**Цель:** унифицировать внутренние уведомления (в приложении) и повысить UX/A11y.
**Файлы:** `lib/widgets/common/notification_banner.dart` (новый), интеграция в экраны: башня (`tower_tiles.dart`), чекпоинты цели (`GoalCheckpointScreen`, `GoalVersionForm`), `GoalScreen` (чек‑ин), `GpStoreScreen`, `Library*`.
**Действия:**
- Создать компонент `NotificationBanner` (варианты: success/info/warn/error, анимация slideDown+fadeIn, автоисчезновение 3–5с, не более 2 одновременно, Semantics labels).
- Внедрить сервис‑фасад `NotificationCenter.show(...)` для вызовов вместо `SnackBar`.
- Заменить Snackbar в перечисленных местах согласно маппингу из `docs/notification_report_enhanced.md` (раздел 3.2/3.3).
- Дедупликация по ключу события (например, `goal_step_saved` на 5 мин).
**Критерии приёмки:**
- Баннеры читаемы, не перекрывают критичные модалы, доступны для screen‑reader, не создают дубликаты.

## Задача 47.4: Пользовательские настройки времени и частоты (минимум)
**Цель:** дать пользователю базовый контроль времени еженедельных напоминаний.
**Действия:**
- Хранить `NotificationPreferences` в Hive (часы/минуты для Пн/Ср/Пт/Вс; дефолт из отчёта).
- Экран настроек (минимальный UI) — выбор времени в пределах дневных окон, без конфликта с DND.
- При изменении — пересоздавать расписание через `NotificationsService` (идемпотентно по ID).
**Критерии приёмки:**
- Выбранное время применяется и сохраняется; уведомления продолжают приходить по новым слотам.

## Задача 47.5: Центр уведомлений в приложении (M1)
**Цель:** история последних событий и быстрые переходы.
**Действия:**
- Экран/лист: последние 20 событий, группировка по дням, фильтры: Все/Цели/GP/Обучение/Чаты, свайп‑удаление, тап → переход по deeplink.
- Интеграция с `NotificationBox` (счётчик непрочитанных).
- Источник данных — локальный журнал событий (Hive), записи из баннеров/локальных уведомлений/критических действий.
**Критерии приёмки:**
- Счётчик отражает непрочитанные; фильтры работают; переходы безопасны (try/catch + Sentry).

## Задача 47.6: Доп. OS‑сценарии (локальные) без FCM
**Цель:** расширить покрытие триггеров до FCM‑этапа.
**Действия:**
- Низкий баланс GP: локальный пуш 1 раз/24ч при `gpBalance < threshold` (наблюдение `gpBalanceProvider`).
- Разблокировка этажа: локальный пуш «Этаж N открыт» с deeplink `/tower` сразу после успеха `unlockFloor`.
- Библиотека: «Новые материалы» — после обновления кеша и изменения количества, не чаще 1/сутки.
**Критерии приёмки:**
- Уведомления приходят в пределах частотных ограничений; deeplink корректен.

## Задача 47.7: Наблюдаемость и метрики
**Цель:** минимальная телеметрия без PII.
**Действия:**
- Добавить `Sentry.addBreadcrumb` при планировании/перепланировании, при показе баннера, при тапе по уведомлению (категории: `notif_scheduled`, `notif_banner_shown`, `notif_tap`).
- Собрать CTR прокси: счетчик «показано» (на уровне локальных событий) vs «тапов» по payload.
**Критерии приёмки:**
- Breadcrumbs видны в Sentry; без утечек JWT/PII; базовые числа CTR доступны.

## Задача 47.8: Интеграция FCM и серверная логика (M2) TODO - НЕ ВЫПОЛНЕНО
**Цель:** добавить push‑уведомления для реакций чата и кампаний.
**Действия (клиент):**
- Подключить `firebase_messaging` (`https://pub.dev/packages/firebase_messaging`).
- Получение/обновление токена, хранение (Hive), background‑обработчики, разрешения iOS.
- Глубокие ссылки `/chat?sessionId=...`, `/library`, `/tower` из пушей.
- Ротация/очистка токена: обновлять токен при смене пользователя, очищать на логауте, повторно регистрировать на логине.
**Действия (сервер/Supabase):**
- Создать таблицу хранения токенов (RLS owner‑only) и Edge Function для рассылки сегментам (минимум): `functions/push-dispatch` (Supabase Edge) — авторизация Service Role.
- Триггеры/cron для кампаний (библиотека/активность) — под флагами.
- Все миграции/деплой через supabase‑mcp.
- Для Android‑сообщений указывать правильный `channel_id`, соответствующий заранее созданным каналам.
**Критерии приёмки:**
- Пуш доставляется в фоне/убитом состоянии, открывает нужный экран; отписка/обновление токена корректны.

## Задача 47.9: Тест‑чеклист (автоматизация по мере возможности)
См. раздел 8 в `docs/notification_report_enhanced.md` (актуализирован):
- Базовая функциональность: iOS разрешения, Android 13+ разрешение через API плагина, перезагрузка/таймзоны/Web.
- Deeplinks: тап → экран (в т.ч. terminated), корректный разбор payload, переключение вкладки при `AppShell`.
- UX/A11y: баннеры читаемы, ≥44px, анимации <16ms, small‑icon в статус‑баре Android.
- Персонализация: сохранение prefs, DND, батчинг (≤3/день), локализация.

## Задача 47.10: Документация по настройке iOS/Android/Firebase/Xcode (инструкции)
**Цель:** пошаговая инструкция для разработчиков/QA.
**Файл:** `docs/notifications_setup.md` (новый)
**Содержание (минимум):**
- Android:
  - Добавление `POST_NOTIFICATIONS`, `RECEIVE_BOOT_COMPLETED` (опц.), small‑icon ресурсы; проверка каналов.
  - Как вручную выдать разрешение и очистить его (Settings) для теста.
  - Требования к background handler: обработчик сообщений для Android должен быть топ‑левел функцией (вне классов), пример сигнатуры.
- iOS:
  - Capabilities: Push Notifications, Background Modes (Remote notifications для FCM), настройка звуков.
  - APNs: ключ/сертификат, привязка к Firebase (если включаем M2), проверка через Xcode device logs.
  - Создание и загрузка APNs Auth Key в Firebase Console; привязка к Bundle ID; проверка sandbox/prod.
- Firebase:
  - Создание проекта/приложений iOS/Android, добавление `GoogleService-Info.plist` и `google-services.json`.
  - Проверка получения пуша в фоне/убитом состоянии.
- GoRouter:
  - Глобальный `AppRouter.instance`/`navigatorKey` и примеры вызова из обработчиков.
- Чек‑лист отладки: типичные ошибки (каналы, звуки, разрешения, токены, payload, deep link).
**Критерии приёмки:**
- Документ покрывает все требования M0/M1/M2; по нему можно поднять пуши с нуля на чистой машине.

## Конфликты/совместимость
- `AppShell` (PageView): deeplink из обработчиков должен переключать активную вкладку перед переходом к вложенному маршруту — учтено в задачах.
- Идемпотентность расписания: закреплены стабильные ID и рекомендация частичной отмены только «своих» уведомлений.
- FCM (M2) отделён фичефлагами от локальных сценариев M0/M1, чтобы не ломать MVP.
- Холодный старт: переход по уведомлению при запуске выполняется через `getNotificationAppLaunchDetails()` с отложенной навигацией после инициализации роутера.
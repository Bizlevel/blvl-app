# –≠—Ç–∞–ø 27: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
### –ó–∞–¥–∞—á–∞ 27.1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –Ω–∞–≤—ã–∫–æ–≤
- –§–∞–π–ª—ã: `supabase/migrations/YYYYMMDD_update_current_level_with_skills.sql`
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –û–±–Ω–æ–≤–∏—Ç—å RPC `public.update_current_level(p_level_id int)`:
     - –û–ø—Ä–µ–¥–µ–ª—è—Ç—å `lvl_num` –∏ `skill_id` –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è: `select number, skill_id into ... from levels where id = p_level_id`.
     - –û–±–Ω–æ–≤–ª—è—Ç—å `users.current_level = lvl_num + 1` –¥–ª—è `auth.uid()` (—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏ `SECURITY DEFINER`, `SET search_path TO public`).
     - –ï—Å–ª–∏ `skill_id` –Ω–µ NULL ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å UPSERT –≤ `user_skills` (+1 –∫ `points`) –¥–ª—è –ø–∞—Ä—ã `(auth.uid(), skill_id)`.
  2) –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
     - `create index if not exists idx_levels_skill_id on public.levels(skill_id);`
     - `create index if not exists idx_user_skills_skill on public.user_skills(skill_id);`
     - (–ø—Ä–æ–≤–µ—Ä–∫–∞) –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–∞ `idx_user_progress_level_id` –Ω–∞ `user_progress(level_id)`.
- –ü—Ä–æ–≤–µ—Ä–∫–∞:
  - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ `supabase-mcp`.
  - –í—ã–ø–æ–ª–Ω–∏—Ç—å `select pg_get_functiondef('public.update_current_level(int)')` –∏ –≤–∏–∑—É–∞–ª—å–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ª–æ–≥–∏–∫—É UPSERT.
  - –ü—Ä–æ–≥–Ω–∞—Ç—å advisors (—Å–º. 27.3) ‚Äî –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã—Ö –æ—à–∏–±–æ–∫.      
### –ó–∞–¥–∞—á–∞ 27.2: –ö–ª–∏–µ–Ω—Ç ‚Äî –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –±–µ–∑—Ä–µ–≥—Ä–µ—Å—Å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
- –§–∞–π–ª—ã: –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–ø–æ–≤–µ–¥–µ–Ω–∏–µ —É–∂–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ: `SupabaseService.completeLevel()` ‚Üí upsert –≤ `user_progress` + RPC, –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ `levelsProvider`/`currentUserProvider`/`userSkillsProvider`).
- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (—Ç–µ—Ö–¥–æ–ª–≥): —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ñ–æ–ª—Ç `UserModel.currentLevel` –Ω–∞ `0`, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª –ë–î. –î–µ–ª–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è.
### –ó–∞–¥–∞—á–∞ 27.3: Advisors –∏ –∏–Ω–¥–µ–∫—Å—ã
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: `supabase-mcp` (`get_advisors`, `list_tables`).
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –ó–∞–ø—É—Å—Ç–∏—Ç—å security/performance advisors –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
  2) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–æ –Ω–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ FK `levels.skill_id` –∏ `user_skills.skill_id` —É—à–ª–∏.
  3) (–¢–µ—Ö–¥–æ–ª–≥) –û—Ç–º–µ—Ç–∏—Ç—å WARN –ø–æ RLS init-plan (–≤—ã–∑–æ–≤—ã `auth.*()` –≤ –ø–æ–ª–∏—Ç–∏–∫–∞—Ö) ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –∫ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏.

### –ó–∞–¥–∞—á–∞ 27.4: –¢–µ—Å—Ç—ã ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –Ω–∞–≤—ã–∫–æ–≤
- –§–∞–π–ª—ã: `test/level_flow_test.dart` (—Ä–∞—Å—à–∏—Ä–∏—Ç—å), –ª–∏–±–æ –Ω–æ–≤—ã–π `test/level_skill_increment_test.dart`.
- –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
  1) –ü–æ—Å–ª–µ –≤—ã–∑–æ–≤–∞ `SupabaseService.completeLevel(levelId)` –æ—á–∫–∏ –Ω–∞–≤—ã–∫–∞, —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å —ç—Ç–∏–º —É—Ä–æ–≤–Ω–µ–º (`levels.skill_id`), —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç—Å—è –Ω–∞ 1 –≤ –¥–∞–Ω–Ω—ã—Ö `userSkillsProvider`.
  2) –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è `levelsProvider`/`currentUserProvider`/`userSkillsProvider` –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é UI (–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –º–æ–∫/—Ñ–µ–π–∫-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –∏–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π).
- –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Å —Ä–µ–∞–ª—å–Ω–æ–π –ë–î –¥–æ–ø—É—Å—Ç–∏–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏; –≤ —é–Ω–∏—Ç‚Äë—Ç–µ—Å—Ç–∞—Ö ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã–π —Ç–µ—Å—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è/–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

### –ó–∞–¥–∞—á–∞ 27.5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Sentry
- –§–∞–π–ª—ã: `lib/main.dart`, `lib/routing/app_router.dart`, `scripts/sentry_check.sh`.
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ DSN –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ `envOrDefine('SENTRY_DSN')`, Sentry –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ —Ç–æ–π –∂–µ async‚Äë–∑–æ–Ω–µ, `SentryNavigatorObserver` –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ GoRouter.
  2) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `beforeSend` —É–¥–∞–ª—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization` –∏–∑ —Å–æ–±—ã—Ç–∏–π (–µ—Å—Ç—å –≤ `main.dart`).
  3) –ü—Ä–æ–≥–Ω–∞—Ç—å `scripts/sentry_check.sh` –ª–æ–∫–∞–ª—å–Ω–æ –∏ –≤ CI, —É–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–µ—Ä–µ—à—ë–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∑–∞ 24 —á–∞—Å–∞. –ò–≥–Ω–æ—Ä ¬´—à—É–º–Ω—ã—Ö¬ª –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è.
  4) –°–º–æ—É–∫-–ø—Ä–æ–≤–µ—Ä–∫–∞: –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ –≤—ã–±—Ä–æ—Å–∏—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ dev-—Å–±–æ—Ä–∫–µ –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Sentry —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º `environment` –∏ `release`.

# –≠—Ç–∞–ø 28: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ–∏—á–∏ ¬´–¶–µ–ª—å¬ª (MVP + —Ç—Ä–µ–∫–µ—Ä)

## 28.1 –ú–∏–≥—Ä–∞—Ü–∏–∏ Supabase (—á–µ—Ä–µ–∑ supabase-mcp)
  - –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ –∏ RLS (owner-only):
    - `core_goals(id uuid pk, user_id uuid fk, version int check 1..4, goal_text text, version_data jsonb, created_at timestamptz default now(), updated_at timestamptz default now())`
      - –ò–Ω–¥–µ–∫—Å—ã: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `(user_id, version)`, –∞ —Ç–∞–∫–∂–µ `updated_at DESC`
      - –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é (—Å–º. —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∏–∂–µ); –∑–∞–ø—Ä–µ—â–µ–Ω–æ –º–µ–Ω—è—Ç—å –ø–æ–ª–µ `version` —á–µ—Ä–µ–∑ UPDATE
    - `weekly_progress(id uuid pk, user_id uuid fk, sprint_number int check 1..4, achievement text, metric_actual text, used_artifacts bool, consulted_leo bool, applied_techniques bool, key_insight text, created_at timestamptz default now())`
      - –ò–Ω–¥–µ–∫—Å: `(user_id, sprint_number DESC)`
    - `reminder_checks(id uuid pk, user_id uuid fk, day_number int check 1..28, reminder_text text, is_completed bool default false, completed_at timestamptz)`
      - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á `(user_id, day_number)` –¥–ª—è upsert (–æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ 28 –¥–Ω–µ–π)
    - `motivational_quotes(id uuid pk, quote_text text, author text, category text, is_active bool default true)`
      - –ò–Ω–¥–µ–∫—Å—ã: `is_active`, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `created_at`
  - –í–∫–ª—é—á–∏—Ç—å RLS, –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ select/insert/update/delete –¥–ª—è `auth.uid() = user_id` (–∫—Ä–æ–º–µ `motivational_quotes`, –¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è —á—Ç–µ–Ω–∏—è –≤—Å–µ–º –∏–ª–∏ –±–µ–∑ RLS)
  - –¢—Ä–∏–≥–≥–µ—Ä—ã —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –∑–∞—â–∏—Ç–∞ RLS:
    - `BEFORE INSERT` –Ω–∞ `core_goals`, `weekly_progress`, `reminder_checks`: –∂—ë—Å—Ç–∫–æ –ø—Ä–æ—Å—Ç–∞–≤–ª—è—Ç—å `NEW.user_id = auth.uid()`; –æ—Ç–∫–ª–æ–Ω—è—Ç—å –≤—Å—Ç–∞–≤–∫—É/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –≥–¥–µ `user_id != auth.uid()`
    - `BEFORE UPDATE` –Ω–∞ `core_goals`: –∑–∞–ø—Ä–µ—â–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–µ—Å–ª–∏ `OLD.version < max(version) for user` ‚Üí RAISE EXCEPTION)
  - Seed ¬´—Ü–∏—Ç–∞—Ç –¥–Ω—è¬ª –≤ `motivational_quotes` –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: `/docs/motivational-quotes-goals.md` (–ø–∞—Ä—Å–∏–Ω–≥ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –≤ —Ç–∞–±–ª–∏—Ü—É)

## 28.2 –ú–æ–¥–µ–ª–∏ –∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (–º–∏–Ω–∏–º—É–º –Ω–æ–≤–æ–≥–æ –∫–æ–¥–∞)
  - –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª–∏ (Freezed/JSON): `CoreGoal`, `WeeklyProgress`, `ReminderCheck`, `MotivationalQuote`
  - –°–æ–∑–¥–∞—Ç—å `GoalsRepository` –ø–æ —à–∞–±–ª–æ–Ω—É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö (`LevelsRepository`, `LessonsRepository`):
    - `fetchLatestGoal(userId)` / `fetchAllGoals(userId)`
    - `upsertGoalVersion(version, goalText, versionData)` ‚Äî insert –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏; —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è
    - `fetchSprint(sprintNumber)` / `upsertSprint(...)`
    - `streamReminderChecks()` / `upsertReminder(day, isCompleted)`
    - `getDailyQuote()` ‚Äî –≤—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–π —Ü–∏—Ç–∞—Ç—ã —Å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π –ø–æ –¥–∞—Ç–µ
  - –í–∫–ª—é—á–∏—Ç—å Hive‚Äë–∫–µ—à (stale‚Äëwhile‚Äërevalidate) –∫–∞–∫ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è—Ö
  - –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã Riverpod: `goalsRepositoryProvider`, `goalLatestProvider`, `goalVersionsProvider`, `sprintProvider`, `remindersProvider`, `dailyQuoteProvider`

## 28.3 –†–æ—É—Ç–∏–Ω–≥ –∏ –æ–±–æ–ª–æ—á–∫–∞ (Web + Mobile + Desktop)
  - –í `lib/routing/app_router.dart` –¥–æ–±–∞–≤–∏—Ç—å `GoRoute(path: '/goal', builder: (_) => GoalScreen())`
  - –í `lib/screens/app_shell.dart` —Ä–∞—Å—à–∏—Ä–∏—Ç—å –≤–∫–ª–∞–¥–∫–∏: `['/home','/chat','/goal','/profile']`
    - –ú–æ–±–∏–ª—å–Ω—ã–π `BottomNavigationBar`: –¥–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç —Å –∏–∫–æ–Ω–∫–æ–π `Icons.flag` (–∏–ª–∏ `Icons.target`)
    - `DesktopNavBar`: –¥–æ–±–∞–≤–∏—Ç—å ¬´–¶–µ–ª—å¬ª (—á–µ—Ç–≤—ë—Ä—Ç–∞—è –≤–∫–ª–∞–¥–∫–∞)
  - –ì–µ–π—Ç–∏–Ω–≥: –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –£—Ä–æ–≤–Ω—è 1 ‚Äî –≤–∫–ª–∞–¥–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞ (—Å–µ—Ä—ã–π —Å—Ç–∏–ª—å + SnackBar ¬´–î–æ—Å—Ç—É–ø–Ω–æ –ø–æ—Å–ª–µ –£—Ä–æ–≤–Ω—è 1¬ª), –ø—Ä–∏ –ø—Ä—è–º–æ–º –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ `/goal` ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/home`. –ö—Ä–∏—Ç–µ—Ä–∏–π: `current_level >= 2` (—É—Ä–æ–≤–µ–Ω—å 1 –∑–∞–≤–µ—Ä—à—ë–Ω).

## 28.4 –≠–∫—Ä–∞–Ω `GoalScreen` (MVP)
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: `CustomScrollView`/`SingleChildScrollView`, `StatCard`, `CustomTextBox`, –ø–∞—Ç—Ç–µ—Ä–Ω `PageView`/–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–∞–∫ –≤ —É—Ä–æ–≤–Ω—è—Ö
  - –°–µ–∫—Ü–∏–∏:
    - ¬´–ú–æ—Ç–∏–≤–∞—Ü–∏—è –æ—Ç Leo¬ª: –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ `dailyQuoteProvider`
    - ¬´–ö—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—è —Ü–µ–ª–∏ v1¬ª: —Ñ–æ—Ä–º–∞ –∏–∑ 3 –ø–æ–ª–µ–π (`goal_initial`, `goal_why`, `main_obstacle`) + –∫–Ω–æ–ø–∫–∞ ¬´–°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª
      - –í–∞–ª–∏–¥–∞—Ü–∏—è (–º–∏–Ω. 10 —Å–∏–º–≤–æ–ª–æ–≤), –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å –¥–µ–±–∞—É–Ω—Å–æ–º 200 –º—Å (–∫–∞–∫ –≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —É—Ä–æ–∫–æ–≤)
  - –î–æ v4 –±–ª–æ–∫ ¬´–ü—É—Ç—å –∫ —Ü–µ–ª–∏¬ª –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–∞–∫ üîí (–∑–∞–≥–ª—É—à–∫–∞)

## 28.5 –í–µ—Ä—Å–∏–∏ v2‚Äìv4 (–∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—è)
  - –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–µ—Ä—Å–∏–π (—Å–≤–∞–π–ø/—Ç–∞–±—ã) –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä ‚óè‚óè‚óè‚óè
  - –§–æ—Ä–º—ã v2/v3/v4 –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏; —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è, –ø—Ä–µ–¥—ã–¥—É—â–∏–µ ‚Äî read‚Äëonly
  - –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –∫–∞–∫ –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π
  - –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω–∏–º –≤ `core_goals.version_data` (JSONB), `goal_text` ‚Äî –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞

## 28.6 –ü—É—Ç—å –∫ —Ü–µ–ª–∏ (28‚Äë–¥–Ω–µ–≤–Ω—ã–π —Å–ø—Ä–∏–Ω—Ç)
  - –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è v4
  - 4 —Å–ø—Ä–∏–Ω—Ç–∞ –ø–æ 7 –¥–Ω–µ–π. UI —Å–ø—Ä–∏–Ω—Ç–æ–≤: –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å 1‚Äì4, –ø—Ä–æ–≥—Ä–µ—Å—Å‚Äë–±–∞—Ä –¥–Ω–µ–π (1..7), –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è timeline (—Ä–æ–≤–Ω–æ 7 —á–µ–∫–ø–æ–∏–Ω—Ç–æ–≤), —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è/—Å–ø—Ä–∏–Ω—Ç–∞ (—á–µ–∫–±–æ–∫—Å—ã)
  - –ö–Ω–æ–ø–∫–∞ ¬´üìù –ò—Ç–æ–≥–∏ —Å–ø—Ä–∏–Ω—Ç–∞¬ª: —Ñ–æ—Ä–º–∞ `WeeklyProgress` (–ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É –¥–Ω—é —Å–ø—Ä–∏–Ω—Ç–∞)
  - –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ–∫‚Äë–∏–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —á–∞—Ç –õ–µ–æ‚Äë—Ç—Ä–µ–∫–µ—Ä–∞ (—Å–º. 28.7) —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º —Ñ–∏–¥–±–µ–∫–æ–º –∏ –º—è–≥–∫–∏–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ø—É–Ω–∫—Ç–∞–º
  - –î–∞–Ω–Ω—ã–µ: `weekly_progress`, `reminder_checks`; –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –∏–∑ –ø. 28.2

## 28.7 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Leo‚Äë—Ç—Ä–µ–∫–µ—Ä–∞ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π Edge Function)
  - –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `FloatingChatBubble` –Ω–∞ `GoalScreen`; –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–∞
  - –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è ¬´–ò—Ç–æ–≥–∏ —Å–ø—Ä–∏–Ω—Ç–∞¬ª –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å —á–∞—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å –∫—Ä–∞—Ç–∫–æ–π –ø–æ—Ö–≤–∞–ª–æ–π –∏ –º—è–≥–∫–∏–º –ø–æ—è—Å–Ω–µ–Ω–∏–µ–º –≤–∞–∂–Ω–æ—Å—Ç–∏ –ø–æ—Å—Ç–æ—è–Ω—Å—Ç–≤–∞. –í–∫–ª—é—á–∞—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≥–∞–ª–æ—á–∫–∏ –ø–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º), —á—Ç–æ–±—ã –õ–µ–æ –ø—Ä–µ–¥–ª–æ–∂–∏–ª –æ–±—Å—É–¥–∏—Ç—å –∏—Ö
  - –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å –≤ `LeoService.sendMessageWithRAG` `systemPrompt`/`knowledgeContext`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é —Ü–µ–ª–∏, –Ω–æ–º–µ—Ä —Å–ø—Ä–∏–Ω—Ç–∞, –¥–µ–Ω—å (1..7), –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ/–Ω–µ–æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è, –∏ —Å–≤–æ–¥–∫—É `WeeklyProgress`
  - –¢—É–º–±–ª–µ—Ä ¬´–û–±—â–∏–π —Ä–µ–∂–∏–º ‚Üó¬ª ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –Ω–∞ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞)
## 28.8 –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –£—Ä–æ–≤–Ω—è–º–∏
  - –í `LevelDetailScreen` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ `completeLevel()` —É—Ä–æ–≤–Ω—è 1 –≤—ã–ø–æ–ª–Ω—è—Ç—å `context.go('/goal')` –∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å v1
  - –î–ª—è —É—Ä–æ–≤–Ω–µ–π 4/7/10 ‚Äî –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å –Ω–µ–Ω–∞–≤—è–∑—á–∏–≤—É—é –ø–ª–∞—à–∫—É ¬´–ö—Ä–∏—Å—Ç–∞–ª–ª–∏–∑—É–π —Ü–µ–ª—å¬ª (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ; –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é –≤–µ—Ä—Å–∏–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ¬´–¶–µ–ª—å¬ª)
## 28.9 –¢–µ—Å—Ç—ã
  - –Æ–Ω–∏—Ç‚Äë—Ç–µ—Å—Ç—ã `GoalsRepository` (CRUD —Ü–µ–ª–µ–π/—Å–ø—Ä–∏–Ω—Ç–æ–≤/–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π, –æ—à–∏–±–∫–∏, –∫–µ—à)
  - –í–∏–¥–∂–µ—Ç‚Äë—Ç–µ—Å—Ç—ã `GoalScreen` (–≥–µ–π—Ç–∏–Ω–≥ –¥–æ/–ø–æ—Å–ª–µ Level 1, —Ñ–æ—Ä–º—ã v1, –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π, —Å–∫—Ä—ã—Ç–∏–µ/–ø–æ–∫–∞–∑ —Å–ø—Ä–∏–Ω—Ç–æ–≤, 28‚Äë–¥–Ω–µ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞)
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π happy‚Äëpath: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –£—Ä–æ–≤–Ω—è 1 ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/goal` ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ v1
  - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —á–µ–∫‚Äë–∏–Ω–∞: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ¬´–ò—Ç–æ–≥–∏ —Å–ø—Ä–∏–Ω—Ç–∞¬ª ‚áí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç –õ–µ–æ‚Äë—Ç—Ä–µ–∫–µ—Ä–∞ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
## 28.10 –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
  - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ Sentry (`captureException`) –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏/–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö; –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å sentry‚Äëmcp –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –ø–æ—Å–ª–µ —Ä–µ–ª–∏–∑–∞
  - –ò—Å–∫–ª—é—á–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É PII/–∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Ü–µ–ª–µ–π –≤ Sentry (–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ)
  - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Hive, –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏, –ª–µ–Ω–∏–≤—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –≤–µ—Ä—Å–∏–π
  - `flutter analyze` –∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã ‚Äî –±–µ–∑ —Ä–µ–≥—Ä–µ—Å—Å–∏–π

# –≠—Ç–∞–ø 29: –ë–æ—Ç –ê–ª–µ–∫—Å ‚Äî —Ç—Ä–µ–∫–µ—Ä —Ü–µ–ª–∏ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)

### –ó–∞–¥–∞—á–∞ 29.1: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ —á–∞—Ç–æ–≤ –ø–æ –±–æ—Ç—É
- –§–∞–π–ª—ã: `supabase/migrations/YYYYMMDD_add_leo_chats_bot.sql`
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `bot text not null default 'leo' check (bot in ('leo','alex'))` –≤ `public.leo_chats`.
  2) –ë—ç–∫—Ñ–∏–ª–ª —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫: —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `bot = 'leo'` (–≤ —Ä–∞–º–∫–∞—Ö `DEFAULT` –∑–Ω–∞—á–µ–Ω–∏–π —ç—Ç–æ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —è–≤–Ω–æ).
  3) –ò–Ω–¥–µ–∫—Å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤: `create index if not exists idx_leo_chats_user_bot_updated on public.leo_chats(user_id, bot, updated_at desc);`
  4) RLS/–ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–µ –º–µ–Ω—è—Ç—å (–ø—Ä–∏–≤—è–∑–∫–∞ –ø–æ `user_id` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è). –¢—Ä–∏–≥–≥–µ—Ä—ã –∏ —Å—á—ë—Ç—á–∏–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ —Ç—Ä–æ–≥–∞–µ–º.
- –ü—Ä–æ–≤–µ—Ä–∫–∞:
  - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —á–µ—Ä–µ–∑ supabase-mcp (apply_migration), –∑–∞—Ç–µ–º `list_tables` –∏ –≤—ã–±–æ—Ä–∫–∞ `select bot,count(*) from leo_chats group by 1`.

### –ó–∞–¥–∞—á–∞ 29.2: Edge Function ‚Äî –µ–¥–∏–Ω–∞—è `leo-chat` —Å —Ä–µ–∂–∏–º–æ–º `bot`
- –§–∞–π–ª: `supabase/functions/leo-chat/index.ts`
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å (–±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏):
  1) –ü—Ä–∏–Ω–∏–º–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `bot` –≤ —Ç–µ–ª–µ –∑–∞–ø—Ä–æ—Å–∞: `'leo' | 'alex'` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `'leo'`).
  2) –ï—Å–ª–∏ `bot==='alex'`:
     - –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç ¬´–ê–ª–µ–∫—Å ‚Äî —Ç—Ä–µ–∫–µ—Ä —Ü–µ–ª–∏¬ª —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–∞—Ü–∏—é —Ü–µ–ª–∏ –∏ –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ —Å–ø—Ä–∏–Ω—Ç–∞—Ö (–∫–æ—Ä–æ—Ç–∫–∏–µ, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã; –±–µ–∑ —Ç–∞–±–ª–∏—Ü –∏ ¬´–º–æ–≥—É –ø–æ–º–æ—á—å‚Ä¶¬ª ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –∫–∞–∫ —É –õ–µ–æ, —Ç–æ–Ω –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –∏–Ω—ã–µ).
     - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:
       - `users`: `name, goal, business_area, experience_level, current_level` (–µ—Å–ª–∏ –µ—Å—Ç—å)
       - `core_goals`: –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è (version, goal_text, version_data)
       - `weekly_progress`: –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –∏–ª–∏ —Ç–µ–∫—É—â–∏–π —Å–ø—Ä–∏–Ω—Ç
       - `reminder_checks`: –∑–∞–ø–∏—Å–∏ –ø–æ —Ç–µ–∫—É—â–µ–º—É –¥–Ω—é/–Ω–µ–¥–µ–ª–µ (–º–∏–Ω–∏–º—É–º ‚Äî —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å)
       - `motivational_quotes`: –∞–∫—Ç–∏–≤–Ω–∞—è —Ü–∏—Ç–∞—Ç–∞ –¥–Ω—è
       - `user_memories`: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3‚Äì5
       - `leo_chats.summary`: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2‚Äì3 —Å–≤—ë—Ä—Ç–∫–∏, —Ñ–∏–ª—å—Ç—Ä `bot='alex'`
     - –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π RAG: –≤—ã–∑—ã–≤–∞—Ç—å `rpc('match_documents', ...)` –∫–∞–∫ —É –õ–µ–æ; –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `levelContext` ‚Äî –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `metadata_filter`. –ú–æ–¥–µ–ª—å/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/–ª–∏–º–∏—Ç—ã ‚Äî —Ç–µ –∂–µ ENV, —á—Ç–æ —É –õ–µ–æ.
  3) –ï—Å–ª–∏ `bot!=='alex'` ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –õ–µ–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ä–µ–∂–∏–º —Ç—Ä–µ–∫–µ—Ä–∞ —É –õ–µ–æ –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ; —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –≤–µ—Ç–∫–∞ –õ–µ–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—é –¥–æ —ç—Ç–∞–ø–∞ 28).
- –ü—Ä–æ–≤–µ—Ä–∫–∞:
  - –õ–æ–∫–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ `leo-chat` —Å `bot='alex'` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º–∏ —Å–µ–∫—Ü–∏—è–º–∏ ¬´–¶–µ–ª—å/–°–ø—Ä–∏–Ω—Ç/–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è/–ü–∞–º—è—Ç—å/–ò—Ç–æ–≥–∏ –æ–±—Å—É–∂–¥–µ–Ω–∏–π/RAG¬ª.

### –ó–∞–¥–∞—á–∞ 29.3: –ö–ª–∏–µ–Ω—Ç ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä `bot` –≤ —Å–µ—Ä–≤–∏—Å–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Ç–æ–≤
- –§–∞–π–ª—ã: `lib/services/leo_service.dart`, –º–µ—Å—Ç–∞ –≤—ã–∑–æ–≤–∞ `saveConversation`/`sendMessageWithRAG`
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –í `sendMessageWithRAG` –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `String bot = 'leo'` –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –µ–≥–æ –≤ —Ç–µ–ª–æ POST `/leo-chat`.
  2) –í `saveConversation(...)` –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `String bot = 'leo'` –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏ –≤ `leo_chats` –ø—Ä–æ—Å—Ç–∞–≤–ª—è—Ç—å `{'bot': bot}`.
  3) –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤—ã–∑–æ–≤—ã –Ω–µ –º–µ–Ω—è–µ–º (–¥–µ—Ñ–æ–ª—Ç `'leo'`).

### –ó–∞–¥–∞—á–∞ 29.4: UI ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ê–ª–µ–∫—Å–∞ –≤ ¬´–¶–µ–ª—å¬ª –∏ ¬´–ß–∞—Ç¬ª
- –§–∞–π–ª—ã: `lib/widgets/floating_chat_bubble.dart`, `lib/screens/leo_dialog_screen.dart`, `lib/screens/leo_chat_screen.dart`, `lib/screens/goal_screen.dart`
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) `LeoDialogScreen`: –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `bot = 'leo'`; –∑–∞–≥–æ–ª–æ–≤–æ–∫ AppBar –º–µ–Ω—è—Ç—å –Ω–∞ ¬´–î–∏–∞–ª–æ–≥ —Å –ê–ª–µ–∫—Å¬ª, –µ—Å–ª–∏ `bot==='alex'`; –ø—Ä–æ–∫–∏–Ω—É—Ç—å `bot` –≤ `LeoService` –º–µ—Ç–æ–¥—ã.
  2) `FloatingChatBubble`: –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `bot` –∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏; –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ¬´–¶–µ–ª—å¬ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `bot='alex'` –∏ –ª–µ–π–±–ª ¬´–û–±—Å—É–¥–∏—Ç—å —Å –ê–ª–µ–∫—Å¬ª; –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –õ–µ–æ.
  3) `LeoChatScreen`: –¥–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∫–ª–∞–¥–æ–∫ ¬´–õ–µ–æ¬ª/¬´–ê–ª–µ–∫—Å¬ª (—Ñ–∏–ª—å—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ `leo_chats.bot`), FAB: ¬´–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å –õ–µ–æ¬ª –∏ –æ–ø—Ü–∏—è ¬´–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å –ê–ª–µ–∫—Å¬ª.
  4) –í —É—Ä–æ–≤–Ω—è—Ö –∏ –Ω–∞ –æ–±—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ ¬´–ß–∞—Ç¬ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Å—Ç–∞—ë—Ç—Å—è –õ–µ–æ; –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ ¬´–¶–µ–ª—å¬ª ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ê–ª–µ–∫—Å–∞.

### –ó–∞–¥–∞—á–∞ 29.5: –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø—Ä–æ–º–ø—Ç –ê–ª–µ–∫—Å–∞
- –§–∞–π–ª: `supabase/functions/leo-chat/index.ts`
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  - –û–ø–∏—Å–∞—Ç—å –±–ª–æ–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º –ø—Ä–æ–º–ø—Ç–µ –¥–ª—è `bot='alex'`: ¬´–î–ê–ù–ù–´–ï –¶–ï–õ–ò¬ª, ¬´–°–ü–†–ò–ù–¢¬ª, ¬´–ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø¬ª, ¬´–õ–ò–ß–ù–´–ï –ó–ê–ú–ï–¢–ö–ò¬ª, ¬´–ò–¢–û–ì–ò –ü–†–û–®–õ–´–• –û–ë–°–£–ñ–î–ï–ù–ò–ô¬ª, ¬´RAG –∫–æ–Ω—Ç–µ–∫—Å—Ç¬ª.
  - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤: 1) —Ü–µ–ª—å/–º–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, 2) –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —à–∞–≥–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–π –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é, 3) –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–∑ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∫—É—Ä—Å–∞ (RAG), 4) –∫—Ä–∞—Ç–∫–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±–µ–∑ ¬´–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –ø–æ–º–æ—â–∏¬ª.
  - –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ –∂–µ –º–æ–¥–µ–ª—å/–ø–∞—Ä–∞–º–µ—Ç—Ä—ã OpenAI (ENV), —á—Ç–æ —É –õ–µ–æ.

### –ó–∞–¥–∞—á–∞ 29.6: –õ–∏–º–∏—Ç—ã, –ø–∞–º—è—Ç—å –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ –∂–µ –ª–∏–º–∏—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–±—â–∏–µ –ø–æ–ª—è –≤ `users`), –æ—Ç–¥–µ–ª—å–Ω—ã–π –±—é–¥–∂–µ—Ç –¥–ª—è –ê–ª–µ–∫—Å–∞ –Ω–µ –≤–≤–æ–¥–∏—Ç—å (MVP).
  - –¢—Ä–∏–≥–≥–µ—Ä `leo-memory` –æ—Å—Ç–∞–≤–∏—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ‚Äî ¬´–ø–∞–º—è—Ç—å¬ª –æ–±—â–∞—è –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è; —Å–≤—ë—Ä—Ç–∫–∏ `leo_chats.summary` —É—á–∏—Ç—ã–≤–∞—é—Ç `bot` –ø—Ä–∏ –≤—ã–±–æ—Ä–∫–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ê–ª–µ–∫—Å–∞.
  - –ü–æ–≤–µ–¥–µ–Ω–∏–µ –õ–µ–æ –≤–µ—Ä–Ω—É—Ç—å –∫ —Ä–æ–ª–∏ ¬´–º–µ–Ω—Ç–æ—Ä¬ª (–±–µ–∑ —Ç—Ä–µ–∫–µ—Ä‚Äë–ª–æ–≥–∏–∫–∏) ‚Äî —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —Ç–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å ¬´—Ç—Ä–µ–∫–∏–Ω–≥–æ–≤—ã–π¬ª –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è `bot='leo'`.

### –ó–∞–¥–∞—á–∞ 29.7: –¢–µ—Å—Ç—ã
- –§–∞–π–ª—ã: `test/services/leo_service_unit_test.dart`, `test/screens/leo_chat_screen_test.dart`, `test/goal_alex_flow_test.dart`
- –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:
  1) `LeoService.sendMessageWithRAG` –ø–µ—Ä–µ–¥–∞—ë—Ç `bot` –≤ —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞; `saveConversation` –ø—Ä–æ—Å—Ç–∞–≤–ª—è–µ—Ç `bot` –≤ `leo_chats`.
  2) –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–∞—Ç–æ–≤ –ø–æ `bot` –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ —Å –ê–ª–µ–∫—Å –∏–∑ `LeoChatScreen`.
  3) –û—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ —Å –ê–ª–µ–∫—Å —Å —Å—Ç—Ä–∞–Ω–∏—Ü—ã ¬´–¶–µ–ª—å¬ª (—á–µ—Ä–µ–∑ `FloatingChatBubble`), –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ü–µ–ª–∏/—Å–ø—Ä–∏–Ω—Ç–∞ –≤ –ø—Ä–æ–º–ø—Ç–µ.
  4) Backward‚Äëcompatibility: –¥–∏–∞–ª–æ–≥–∏ –õ–µ–æ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –ø—Ä–µ–∂–¥–µ.
- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –≤ UI (tooltip/–±–∞–Ω–Ω–µ—Ä) –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ ¬´–¶–µ–ª–∏¬ª: ¬´–î–∏–∞–ª–æ–≥ —Å –ê–ª–µ–∫—Å –ø–æ–º–æ–≥–∞–µ—Ç –∫—Ä–∏—Å—Ç–∞–ª–ª–∏–∑–æ–≤–∞—Ç—å —Ü–µ–ª—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∞—Å 28 –¥–Ω–µ–π¬ª.

### –ó–∞–¥–∞—á–∞ 29.8: –ê—É–¥–∏—Ç —Å—Ö–µ–º—ã –∏ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è Leo/Alex –∏ RAG
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: supabase-mcp (`list_tables`, `execute_sql`).
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü: `users`, `leo_chats` (–≤–∫–ª—é—á–∞—è `bot`, `summary`, `last_topics`), `leo_messages`, `user_memories`, `documents` (–Ω–∞–ª–∏—á–∏–µ `embedding vector` –∏ `metadata jsonb`), `core_goals`, `weekly_progress`, `reminder_checks`, `motivational_quotes`.
  2) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: 
     - `idx_leo_chats_user_bot_updated` –Ω–∞ `(user_id, bot, updated_at desc)`;
     - ANN/IVFFLAT/HNSW –∏–Ω–¥–µ–∫—Å –Ω–∞ `documents(embedding)`;
     - GIN –∏–Ω–¥–µ–∫—Å –Ω–∞ `documents(metadata)`;
     - –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –Ω–∞–≤—ã–∫–∞—Ö: `idx_levels_skill_id`, `idx_user_skills_skill`.
  3) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã –Ω–∞ `leo_messages` (AFTER INSERT –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ ‚Üí –≤—ã–∑–æ–≤ –ø–∞–º—è—Ç–∏) –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ `public.call_leo_memory(...)`.
  4) –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏ RPC `match_documents(vector, double precision, integer, jsonb)`.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç; –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç; –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ RPC —Å `jsonb` –¥–æ—Å—Ç—É–ø–Ω–∞; –Ω–µ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö —Å–∏–≥–Ω–∞—Ç—É—Ä `call_leo_memory`.

### –ó–∞–¥–∞—á–∞ 29.9: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏ GUC –¥–ª—è edge‚Äë—Ñ—É–Ω–∫—Ü–∏–π
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: Supabase Studio (Edge Functions Settings), supabase-mcp (`execute_sql`).
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ë–î‚ÄëGUC: `app.supabase_url`, `app.service_role_key` (–±–µ–∑ –∫–æ–º–º–∏—Ç–æ–≤ –∫–ª—é—á–µ–π –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π).
  2) –î–ª—è edge‚Äë—Ñ—É–Ω–∫—Ü–∏–∏ `leo-memory` –∑–∞–¥–∞—Ç—å —Å–µ–∫—Ä–µ—Ç `CRON_SECRET` –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å redeploy.
  3) –î–ª—è `leo-chat` —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è) –±–µ—Ä—É—Ç—Å—è –∏–∑ ENV/—Å–µ–∫—Ä–µ—Ç–æ–≤, –∞ –Ω–µ –∏–∑ –∫–æ–¥–∞.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: `current_setting('app.supabase_url', true)` –∏ `current_setting('app.service_role_key', true)` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –Ω–µ–ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è; `leo-memory` —á–∏—Ç–∞–µ—Ç `CRON_SECRET`; —Ñ—É–Ω–∫—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –¥–µ–ø–ª–æ—è—Ç—Å—è.

### –ó–∞–¥–∞—á–∞ 29.10: Smoke‚Äë–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞ –ø–∞–º—è—Ç–∏
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: supabase-mcp (`execute_sql`).
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ä—É—á–Ω–æ–π –≤—ã–∑–æ–≤ `public.call_leo_memory(...)` –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç—Å–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ (–∫–∞–∫ –≤ `docs/1.md`).
  2) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø–æ—è–≤–∏–ª–∞—Å—å –∑–∞–ø–∏—Å—å –≤ `leo_messages_processed` –¥–ª—è —ç—Ç–æ–≥–æ `message_id`.
  3) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `leo_chats.summary` –∏ `leo_chats.last_topics` –ø–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É `chat_id`.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ, —Å–≤—ë—Ä—Ç–∫–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –±–µ–∑ –æ—à–∏–±–æ–∫.

### –ó–∞–¥–∞—á–∞ 29.11: Smoke‚Äë–ø—Ä–æ–≤–µ—Ä–∫–∞ RAG —Å metadata_filter
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: supabase-mcp (`execute_sql`), –ª–æ–≥–∏ edge‚Äë—Ñ—É–Ω–∫—Ü–∏–∏ `leo-chat`.
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL‚Äë–∑–∞–ø—Ä–æ—Å –∫ `match_documents` —Å `metadata_filter` –ø–æ —É—Ä–æ–≤–Ω—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, `{"level_id":1}`) –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –µ—Å—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è.
  2) –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ `leo-chat` —Å `levelContext` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ –ª–æ–≥–∞–º, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∏ –æ—à–∏–±–æ–∫ RAG –Ω–µ—Ç.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: SQL –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ `metadata_filter` –∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—à–∏–±–æ–∫.

### –ó–∞–¥–∞—á–∞ 29.12: –ë—ç–∫—Ñ–∏–ª–ª –∏ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è `documents`
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: —Å–∫—Ä–∏–ø—Ç `scripts/upload_from_drive.py`, supabase-mcp (`execute_sql`).
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å `documents.metadata` (`level_id`, `lesson_id`, `tags` –≤–∏–¥–∞ "Level N"/"Lesson N"). –ü—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ ‚Äî –≤—ã–ø–æ–ª–Ω–∏—Ç—å –±—ç–∫—Ñ–∏–ª–ª —á–µ—Ä–µ–∑ `documents_backfill_map` –∏ –∑–∞–≥—Ä—É–∑—á–∏–∫.
  2) –°–æ–∑–¥–∞—Ç—å (–µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç) –∏–Ω–¥–µ–∫—Å—ã: ANN –Ω–∞ `embedding` –∏ GIN –Ω–∞ `metadata`.
  3) –ü—Ä–æ–π—Ç–∏ advisors (performance) ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –ø–æ —ç—Ç–∏–º —Ç–∞–±–ª–∏—Ü–∞–º.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: –ø–æ–∫—Ä—ã—Ç–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö ‚â• 95%; –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –º–µ—Å—Ç–µ; latency `match_documents` –≤ –Ω–æ—Ä–º–µ; advisors –±–µ–∑ –Ω–æ–≤—ã—Ö WARN/ERROR.

### –ó–∞–¥–∞—á–∞ 29.13: –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ RAG‚Äë—Ñ–∏–ª—å—Ç—Ä–∞ –¥–ª—è `bot='alex'` –≤ `leo-chat`
- –§–∞–π–ª: `supabase/functions/leo-chat/index.ts`.
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ `levelContext` –≤–µ—Ç–∫–∞ `bot='alex'` –ø–µ—Ä–µ–¥–∞—ë—Ç `metadata_filter` –≤ `rpc('match_documents', ...)` –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –õ–µ–æ.
  2) –î–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–∫—Ç–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è `metadata_filter` (–±–µ–∑ —É—Ç–µ—á–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: –æ—Ç–≤–µ—Ç—ã –ê–ª–µ–∫—Å–∞ –≤–∫–ª—é—á–∞—é—Ç RAG –ø–æ —É—Ä–æ–≤–Ω—é/—É—Ä–æ–∫—É, –ª–æ–≥–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞; –ø–æ–≤–µ–¥–µ–Ω–∏–µ –õ–µ–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.

### –ó–∞–¥–∞—á–∞ 29.14: –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å service role –∏ —Å–µ–∫—Ä–µ—Ç–æ–≤
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: —Ä–µ–≤—å—é —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, CI.
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –ò—Å–∫–ª—é—á–∏—Ç—å `service_role_key` –∏ –ª—é–±—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –∏–∑ `.env` –∏ –∫–æ–º–º–∏—Ç–æ–≤ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å `.gitignore`, —Å–∫—Ä–∏–ø—Ç—ã, README).
  2) –•—Ä–∞–Ω–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã —Ç–æ–ª—å–∫–æ –≤ –ë–î‚ÄëGUC/Edge Secrets/CI Secrets. –í –∫–ª–∏–µ–Ω—Ç–µ ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `envOrDefine` –±–µ–∑ —Å–µ—Ä–≤–∏—Å–Ω—ã—Ö –∫–ª—é—á–µ–π.
  3) (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –í CI –¥–æ–±–∞–≤–∏—Ç—å grep‚Äë–ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ `service_role`/`app.service_role_key` –≤ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –ø—É–ª‚Äë—Ä–µ–∫–≤–µ—Å—Ç–æ–≤.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Å–µ–∫—Ä–µ—Ç—ã; CI/—Ä–µ–≤—å—é –ø—Ä–æ—Ö–æ–¥—è—Ç; Sentry/–ª–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤.

### –ó–∞–¥–∞—á–∞ 29.15: –ú–∏–Ω–∏‚Äë—Å–∏–¥ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è `bot='alex'`
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: supabase-mcp (`execute_sql`).
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –í—Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏: `core_goals(v1)`, –æ–¥–∏–Ω `weekly_progress`, `reminder_checks` (—Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å), –æ–¥–Ω—É –∞–∫—Ç–∏–≤–Ω—É—é –∑–∞–ø–∏—Å—å –≤ `motivational_quotes`.
  2) –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å –≤ `leo-chat` —Å `bot='alex'` –∏ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ü–∏–∏ ¬´–¶–µ–ª—å/–°–ø—Ä–∏–Ω—Ç/–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è/–¶–∏—Ç–∞—Ç–∞¬ª.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: –ê–ª–µ–∫—Å –æ—Ç–≤–µ—á–∞–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–Ω–æ, –±–µ–∑ RAG‚Äë—Ä–µ–≥—Ä–µ—Å—Å–∏–π.

### –ó–∞–¥–∞—á–∞ 29.16: –ù–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å (Sentry –∏ –ª–æ–≥–∏ edge)
- –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: sentry-mcp, –ª–æ–≥–∏ Supabase Edge.
- –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:
  1) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –Ω–µ—Ä–µ—à—ë–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∑–∞ 24 —á–∞—Å–∞ (—Å–∫—Ä–∏–ø—Ç `scripts/sentry_check.sh`).
  2) –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ edge‚Äë—Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç –∫–ª—é—á–µ–≤—ã–µ —ç—Ç–∞–ø—ã (–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞, –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ –ø–∞–º—è—Ç–∏) –±–µ–∑ PII.
- –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏: –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫ –Ω–µ—Ç; –ª–æ–≥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã.

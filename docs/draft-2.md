## Мини‑тур (онбординг‑тур)  — детальная концепция

### Цель и охват
- **Цель**: мягко познакомить пользователя с ключевыми точками BizLevel: Главная (Main Street), Цель (версии v1–v4, «что дальше»), Башня (переходы на уровни/чекпоинты/кейсы).
- **Охват экранов**: `/home` → `/goal` → `/tower` (без автопереходов; тур не навязывает навигацию, только подсвечивает элементы и даёт краткие пояснения).

### Точки запуска и условия
- **Первичный запуск**: после первого успешного входа, если `users.onboarding_completed = false` (Supabase) или локально нет метки тура.
- **Повторный запуск**: если локальный `tour_version < REQUIRED_TOUR_VERSION` (переобучение при изменении тура), либо из настроек по кнопке «Показать мини‑тур».
- **Откладывание**: тур показывается только когда экран стабильно построен (после первого кадра), без активных модальных окон.
- Прохождение тура дает 30 GP бонуса

### Хранение состояния (Supabase + локально)
- Supabase: `public.users.onboarding_completed boolean` (уже есть) — помечаем как пройдено после завершения тура.
- Локально: `SharedPreferences['tour_version'] = 1` — версия текущего тура (для переобучения при изменениях). Также можно хранить `['tour_dismissed'] = true` при «Пропустить». 
- Логика: если `onboarding_completed=false` или `tour_version < REQUIRED_TOUR_VERSION`, предложить тур; по завершении — выставить оба флага.

### Сервис и фичефлаг
- **TourService** (клиент): 
  - `Future<bool> shouldShow({required int requiredVersion})`
  - `Future<void> markDone({required int version})`
  - `Future<void> markDismissed()`
- **Фичефлаг**: `kEnableMiniTour = true` (быстрый роллбек показа без релиза).

### Технология показа
- Используем готовый `widgets/common/onboarding_tooltip.dart` (Overlay с вырезом/стрелкой и кнопками «Далее/Пропустить»).
- На каждом экране создаём `GlobalKey` для подсвечиваемых элементов.
- Контроллер: `OnboardingTourController(steps: [...])`, где `step.targetKey/title/description/preferredDirection`.
- Показ: `controller.start(context)` после `addPostFrameCallback`, когда ключи валидны.

### Содержание тура (v1)
- Main Street (`/home`):
  1) **Верхняя панель** (аватар и GP): «Здесь ваш профиль, уровень и баланс Очков Развития. Нажмите на GP, чтобы открыть магазин.»
  2) **Главная улица - разбить на 3 этапа** («Библиотека», «Башня», «База тренеров»): «Эти разделы — быстрые входы.
   - Башня Бизлевел - это набор уровней, которые помогут вам достичь ваших целей. 
   - База Тренеров - здесь вы можете пообщаться с бизнес-тренерами.
   - Библиотека - Здесь мы собрали для вас список беслпатных полезных онлайн-курсов в сети, программы акселераций, а также списки грантов и субсидий для бизнеса»
  3) **Кнопка „Продолжить“**: «Переход к следующему шагу пути (уровень/чекпоинт/кейс).»
- Goal Screen (`/goal`):
  4) **„Моя цель“** (GoalCompactCard): «После прохождения 1 этажа Башни Бизлевел у вас будет четкая цель на следующий месяц и понимание, как ее достичь.»
  5) **Кристаллизация цели** (CrystallizationSection): «Цель строится постепенно. С прохождением каждого уровня вы будете четче понимать, что именно вам нужно сделать, чтобы развить свой бизнес.»
  6) **Прогресс** (ProgressWidget): «Индикатор прогресса по версиям и метрикам.»
  7) **Путь к цели** (SprintSection): «Откроется после завершения 1 этажа Башни Бизлевел. Отмечайте „итоги недели“ — Макс предложит следующие шаги.»
- BizTower (`/tower`):
  8) **Башня**: «Проходите по уровням, решайте бизнес-кейсы, четче формилируйте свою цель, чтобы наверняка ее достичь.»

### UX‑детали
- Тур **не блокирует** взаимодействие, можно «Пропустить» в любой момент.
- Подсказки короткие (1–2 строки), без скролла и сложной вёрстки.
- Для тёмных/светлых тем Tooltip подстраивается по контрасту (используем текущие токены темы).
- Минимальный tap‑таргет ≥44 px; доступность через `Semantics`.

### Наблюдаемость (Sentry, без PII)
- Breadcrumbs: `tour_started`, `tour_step_shown:{id}`, `tour_skipped`, `tour_finished`, `tour_restarted(version)`.
- Ошибки показа (например, недоступен targetKey) — `tour_step_anchor_missing` (warning) с `screen/id`.

### Обновление профиля (Supabase)
- По завершении тура: `authService.updateProfile(onboardingCompleted: true)` → обновит `public.users.onboarding_completed`.
- Дополнительно: инвалидация `currentUserProvider`, чтобы GoRouter/экраны получили актуальное состояние.

### Порядок интеграции по экранам
- Main Street:
  - Добавить `GlobalKey` к top‑bar GP и контейнеру карточек / кнопке «Продолжить».
  - Инициализировать тур при первом открытии (guard на `shouldShow`).
- GoalScreen:
  - Ключи на заголовок блока «Моя цель», переключатель версий, индикатор прогресса.
  - Показать шаги 4–6 при первой загрузке, если пользователь не „прошёл тур“.
- BizTower:
  - Ключ на область грид‑карты.
  - Один шаг с пояснением узлов/гейтинга.

### Версионность тура
- `REQUIRED_TOUR_VERSION = 1` в клиенте. При изменении сценария увеличить до 2 — пользователи увидят краткий обновлённый тур.
- Локальный `tour_version` обновляется по завершении.

### Ошибки/краевые случаи
- Нет ключа target (виджет не в дереве) — пропускаем шаг, пишем breadcrumb.
- Быстрый переход по экранам во время тура — закрываем текущий Overlay и переносим тур на следующий экран (по таймеру/событию).
- Пользователь без доступа к `/goal` (уровень < 2) — не показываем шаги экрана «Цель».

### Роллаут и тесты
- Флаг `kEnableMiniTour = true` (в коде) + проверка `shouldShow`.
- Тесты:
  - Smoke: рендер Overlay, присутствие кнопок «Далее/Пропустить», шаги на `/home`.
  - Интеграция: завершение тура → обновление профиля и локальной метки; повторный вход не запускает тур.
  - Регрессия: отсутствие конфликтов с Snackbar/ModalBottomSheet.

### Итоги
- Мини‑тур ненавязчив, не меняет маршрутизацию и данные, кроме флага завершения/версии тура.
- Использует готовый Overlay‑компонент, минимальные изменения по экранам.


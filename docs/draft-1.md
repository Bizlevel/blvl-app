## BizLevel — Полный маршрут пользователя по цели (L1 → завершение → новая цель)

### Введение
Этот документ описывает детально весь пользовательский путь, связанный с постановкой, ведением и завершением цели в BizLevel: от прохождения ядра целей на уровне L1 и чекпоинта после него до фиксации прогресса, работы с журналом применений, взаимодействия с ассистентом «Макс», уведомлений и постановки новой цели. Также перечислены все файлы (экраны, провайдеры, репозитории, виджеты), серверные функции и таблицы Supabase, участвующие в этом процессе.

Документ нужен как единая «истина» для команды: дизайнеров, фронтенда, серверной части и аналитиков.


## 1. Карта пути пользователя (user journey) — шаг за шагом

### 1.1. Стартовая точка и L1 «Ядро целей»
- Пользователь заходит в приложение и попадает на главный экран (`/home`) или в «Башню».
- На уровне L1 («Ядро целей») пользователь формулирует первую цель и фиксирует её в чекпоинте L1.
  - Из чекпоинта L1 (экран `checkpoint_l1_screen.dart`) пользователь вводит текст цели, при необходимости дедлайн.
  - При сохранении:
    - Создаётся (или активируется) запись в `user_goal_history` со статусом `active`.
    - Обновляется `user_goal.current_history_id`, указывающий на активную историю цели.
  - Пользователь возвращается на экран «Цель» или «Главная», где видит блок «Моя цель».

Роль L1: пользователь проходит размышления о смысле, формулирует «зачем», получает первую «рабочую» формулировку цели, с которой будет идти практическая работа дальше.


### 1.2. Главный экран — карточка «Моя цель»
- Компонент: `lib/widgets/home/home_goal_card.dart`
- Что видит пользователь:
  - Текст цели и, если задан, дедлайн.
  - Кольцо прогресса. Если метрика ещё не настроена — кольцо скрыто, показан хинт о необходимости настроить метрику («Добавьте метрику»/ссылка на страницу «Цель»).
  - Кнопка «Обсудить с Максом» — открывает чат с ассистентом «Макс», передавая контекст активной цели (текст цели, metric_type/current/target, target_date).
  - Тап по карточке открывает страницу «Цель» (`/goal`).

UX-правило: избегаем ложной точности. Пока метрика не задана (или неполная), прогресс-донат не показываем, чтобы не вводить пользователя в заблуждение.


### 1.3. Страница «Цель» (`/goal`)
- Экран: `lib/screens/goal_screen.dart` + блоки:
  - «Мотивация» (случайная цитата/совет).
  - «Моя цель» — редактируемый блок (`goal_compact_card.dart`).
  - «Журнал применений» — запись и обзор практических действий.
  - «Напоминания» — шит настроек локальных уведомлений.

Ключевая логика страницы:

1) Блок «Моя цель» — `goal_compact_card.dart`
   - Режимы:
     - Просмотр: виден текст цели, дедлайн, кнопки действий.
     - Редактирование: поля ввода цели, дедлайна, метрики (тип, текущее, целевое).
   - Кнопки/элементы:
     - «Редактировать» → переводит в режим редактирования.
     - «Сохранить» → вызывает `GoalsRepository.upsertUserGoal(...)`.
       - Если впервые заполнено `metric_current` и не задан `metric_start`, то `metric_start` выставляется автоматически равным текущему.
       - Цель и связанные поля обновляются в `user_goal` и/или активной записи `user_goal_history` (см. бизнес-правила в репозитории).
     - «Отмена» → возвращает к просмотру без сохранения.
     - «Новая цель» → запускает подтверждающий шит и при согласии вызывает `GoalsRepository.startNewGoal(...)`:
       - Текущая активная запись `user_goal_history` помечается как `completed`, проставляется `closed_at`.
       - Создаётся новая запись `user_goal_history` со статусом `active`.
       - В `user_goal` обновляется `current_history_id` на новую запись.
       - Вся последующая практика и контекст «Макс» будут относиться уже к новой цели (исключая смешение).
     - «Обновить текущее» (если доступно) → быстрый шит для актуализации `metric_current` (bottom-sheet).
     - «Обсудить с Максом» → открывает чат «Макс»; в `userContext` передаются:
       - `goal_text`, `metric_type`, `metric_current`, `metric_target`, `target_date`.
   - Важно: выбор типа метрики — выпадающий список. Если сохранённое ранее произвольное значение не входит в список — контрол безопасно выставит `null`, и пользователь сможет выбрать корректный вариант (устранена ошибка с падением Dropdown при невалидном значении).
   - Исправления по layout: группы кнопок переведены в `Wrap`, чтобы не было переполнения по ширине (устранён Flutter RenderFlex overflow).

2) Блок «Журнал применений» — `practice_journal_section.dart`
   - Пользователь выбирает Top‑3 инструментов/навыков (есть подсказка‑легенда), пишет заметку и сохраняет запись.
   - При сохранении вызывается `GoalsRepository.addPracticeEntry(...)`:
     - Запись создаётся в `practice_log` c привязкой `goal_history_id` к активной цели (если указатель существует).
   - После вставки открывается чат «Макс» с контекстом заметки и инструментов (для обратной связи и усиления эффекта практики).

3) Блок «Напоминания» — `reminders_settings_sheet.dart`
   - Пользователь настраивает локальные уведомления.
   - При сохранении:
     - Сначала вызывается `NotificationsService.cancelDailyPracticeReminder()` — отменяет старые сценарии.
     - Затем ставятся новые расписания.
     - Отображается «Следующее напоминание» (подтверждение UX).


### 1.4. Прогресс по цели и визуализация
- Прогресс вычисляется из числовых метрик: `metric_start`, `metric_current`, `metric_target`.
- Формула: прогресс = clamp((current − start) / (target − start), 0..1).
- Если метрика не полна (одно из значений отсутствует) — прогресс неопределён; на главной карточке кольцо скрыто и показывается хинт с предложением настроить метрику.
- На странице «Цель» есть пояснение формулы и быстрый переход к настройке.


### 1.5. «Макс» — контекст и ответы
- Кнопка «Обсудить с Максом» доступна:
  - На главной карточке «Моя цель».
  - В блоке «Моя цель» на странице «Цель».
  - Автоматически после сохранения записи в «Журнале применений».
- Контекст «Макса» включает (если доступны):
  - `goal_text`, `metric_type`, `metric_current`, `metric_target`, `target_date`.
  - В блоке практики — ещё и `practice_note`, `applied_tools`.
- На стороне Edge‑функции `leo-chat` практики подгружаются только для текущего `goal_history_id`, чтобы комментарии «Макса» не смешивались между старыми и новыми целями.


### 1.6. Завершение цели и постановка новой
- Пользователь может:
  - Достичь целевого значения — по факту зафиксированного прогресса (и по внутреннему смыслу цели).
  - Явно завершить текущую цель (через «Новая цель») и поставить другую:
    - `user_goal_history.status` → `completed` и `closed_at` для старой записи.
    - Создаётся новая `user_goal_history` со статусом `active` и обновляется `user_goal.current_history_id`.
    - Журнал применений и «Макс» теперь работают с актуальной историей.


## 2. Состав участников — файлы, элементы, таблицы и функции

### 2.1. Экраны и маршруты
- `lib/routing/app_router.dart`
  - Роуты: `/home`, `/goal`, `/goal/history`, `/checkpoint/l1`, `/checkpoint/l4`, `/checkpoint/l7`, `/chat` и др.
  - Удалён устаревший роут `goal-checkpoint`.

- `lib/screens/main_street_screen.dart`
  - Главная логика отображения главной страницы.
  - Убрана устаревшая ветка `goalCheckpointVersion`.

- `lib/screens/goal_screen.dart`
  - Страница «Цель»: мотивация, «Моя цель», «Журнал применений», «Напоминания».
  - Вызовы bottom‑sheet для обновления `metric_current`.
  - Передача расширенного контекста в чат «Макс».

- `lib/screens/goal_history_screen.dart`
  - История практики: вывод записей журнала, отфильтрованных по активной истории цели (`current_history_id`).

- `lib/screens/checkpoints/checkpoint_l1_screen.dart`
  - Формулировка первой цели (ядро целей), сохранение и создание/активация истории.

- `lib/screens/checkpoints/checkpoint_l4_screen.dart`
  - Чекпоинт L4: фокус на регулярность; логически связан с дневником и напоминаниями.

- `lib/screens/checkpoints/checkpoint_l7_screen.dart`
  - Чекпоинт L7: система поддержки; логически связан с устойчивостью практики.


### 2.2. Виджеты (ключевые)
- Главная карточка цели: `lib/widgets/home/home_goal_card.dart`
  - Отображает цель, дедлайн, прогресс‑донат (или хинт), кнопку «Обсудить с Максом».
  - Прячет донат до настройки метрики; в контексте чата передаёт метаданные цели.

- Компактная карта цели (редактируемая): `lib/screens/goal/widgets/goal_compact_card.dart`
  - Поля: текст цели, дедлайн (с календарём), метрика (тип — dropdown; текущее; целевое).
  - Кнопки: «Редактировать» / «Сохранить» / «Отмена», «Новая цель», «Обновить текущее», «Обсудить с Максом».
  - Исправление overflow (переведено в `Wrap`), безопасная инициализация dropdown‑значения.

- Журнал применений: `lib/screens/goal/widgets/practice_journal_section.dart`
  - Выбор топ‑инструментов, поле заметки, кнопка «Сохранить».
  - После сохранения — авто‑переход в чат «Макс» с контекстом записи.

- Напоминания (шит): `lib/widgets/reminders_settings_sheet.dart`
  - При сохранении: отмена старых сценариев и установка новых; показ «Следующее напоминание».

- Донат‑прогресс: `lib/widgets/common/donut_progress.dart`
  - Инкапсулированный индикатор прогресса цели, скрывается, если прогресс не вычисляется.


### 2.3. Провайдеры и репозиторий
- Провайдеры (`lib/providers/...`):
  - `goals_providers.dart`: `userGoalProvider`, `practiceLogWithLimitProvider` (фильтрация по `goal_history_id`), прочие.

- Репозиторий: `lib/repositories/goals_repository.dart`
  - `upsertUserGoal({...})` — создать/обновить цель; управляет историей, если меняется `goal_text` или нет активной истории.
  - `startNewGoal({...})` — принудительно завершить текущую историю и создать новую, обновив `user_goal.current_history_id`.
  - `addPracticeEntry({...})` — добавить запись в журнал, автоматически привязав к активной истории цели.
  - `fetchPracticeLogForHistory({ historyId, limit })` — получить список практик по актуальной истории.
  - `computeGoalProgressPercent(goal)` — вычисление прогресса по метрикам.
  - Побочные операции: `gp`‑бонус за применение, кэширование (Hive), хлебные крошки в Sentry.


### 2.4. Уведомления
- Сервис: `lib/services/notifications_service.dart`
  - `cancelDailyPracticeReminder()` — отменить текущие напоминания.
  - Методы планирования ежедневных напоминаний.

- Шит настроек напоминаний: `lib/widgets/reminders_settings_sheet.dart`
  - Гасит старые сценарии перед установкой новых; отображает «Следующее напоминание».


### 2.5. Чат «Макс» и Edge‑функции
- Клиентские экраны/вызовы:
  - `LeoDialogScreen` (контейнер чата): получает `userContext` и открывает диалог «Макс».
  - Контекст включает цель и метрики, а также практику (при старте из журнала).

- Edge‑функция Supabase: `supabase/functions/leo-chat/index.ts`
  - Забирает `user_goal` и последние записи `practice_log`.
  - Фильтрует `practice_log` по активному `user_goal_history.id` — предотвращает смешение старых/новых целей.
  - Использует RAG/интеграции (описание вне данного документа).
  - Локально для статической проверки в репозитории применён `// @ts-nocheck`, чтобы не засыпать проект TS‑ошибками окружения Deno (боевой рантайм — Deno в Supabase).


### 2.6. Таблицы Supabase (минимальный набор)
- `user_goal`
  - Поля: `user_id (PK)`, `goal_text`, `metric_type`, `metric_start`, `metric_current`, `metric_target`, `start_date`, `target_date`, `current_history_id`, `updated_at` и т.п.
  - Назначение: текущая «активная» цель пользователя и указатель на активную историю.

- `user_goal_history`
  - Поля: `id (PK)`, `user_id`, `goal_text`, `metric_type`, `metric_start`, `metric_current`, `metric_target`, `start_date`, `target_date`, `status (active/completed)`, `closed_at`, индексы по `user_id/status`.
  - Назначение: полная история целей (версионирование); одна активная запись на пользователя.

- `practice_log`
  - Поля: `id (PK)`, `user_id`, `applied_at`, `applied_tools[]`, `note`, `goal_history_id (FK → user_goal_history.id)`, индексы по `user_id/goal_history_id/applied_at`.
  - Назначение: журнал применений, привязанный к конкретной версии цели.

- (Конфигурации и RLS‑политики — в миграциях в `supabase/migrations`; в рамках этой задачи добавлялись политики для связанных сущностей и индексы.)


## 3. Бизнес‑правила и UX‑детали

1) Невалидная метрика не ломает UI
   - Если ранее сохранённый `metric_type` не входит в список — dropdown не падает, значение `null`, пользователь выбирает корректный вариант.

2) Прогресс показываем только при полной метрике
   - Если `metric_start/current/target` заданы корректно — рисуем донат.
   - Иначе — хинт «Настройте метрику».

3) История целей не смешивается
   - Все новые записи журнала автоматически получают `goal_history_id` активной цели.
   - Чат «Макс» подтягивает практику только по активной истории.

4) Напоминания предсказуемы
   - Перед установкой новых всегда отменяем старые.
   - Отображаем «Следующее напоминание».

5) Новая цель — явная операция
   - «Новая цель» закрывает текущую историю (ставит `completed`) и создаёт новую активную запись.
   - Пользователь всегда понимает, что практика теперь относится к новой цели.

6) Sentry‑крошки на критичных действиях
   - Сохранение цели, запись практики — пишем хлебные крошки для поддержки и аналитики.


## 4. Типовые сценарии

Сценарий A — Пользователь только что прошёл L1:
- Формулирует цель → Сохранить → Переходит на «Цель».
- Настраивает метрику: тип, текущее, целевое → Сохранить.
- Возвращается на главную: появляется донат прогресса.

Сценарий B — Запись практики и обратная связь «Макса»:
- Открывает «Цель» → «Журнал применений» → отмечает инструменты, заполняет заметку → Сохранить.
- Авто‑переход в чат «Макс» с контекстом записи → получает советы/подсказки.

Сценарий C — Настройка напоминаний:
- В шите напоминаний выбирает время/дни → Сохранить.
- Старые сценарии отменены, новые поставлены → видит «Следующее напоминание».

Сценарий D — Завершение цели и новая цель:
- На «Цель» нажимает «Новая цель» → подтверждает.
- Текущая история закрыта, создана новая активная запись → повторяет настройку метрики при необходимости.


## 5. Проверки и устойчивость

- Валидация:
  - Числовые поля метрик принимают только числа; при невозможности преобразования — игнорируются и не ломают логику.
  - Dropdown метрики безопасен к несоответствующим значениям.

- Производительность:
  - Журнал и цель кэшируются (Hive) на клиенте для отзывчивости.
  - Практики ограничиваются по лимиту и сортируются по `applied_at`.

- Безопасность данных:
  - Все записи привязаны к `user_id` и защищены RLS.
  - История целей предотвращает семантическое смешение старых и новых контекстов.


## 6. Выводы и связь с концепцией BizLevel

- Линк цели с «Башней» и чекпоинтами L1/L4/L7 сохраняет ясную вертикаль развития.
- Журнал и «Макс» — практико‑ориентированные: пользователь пишет, получает обратную связь, закрепляет привычку.
- Метрики и прогресс — прозрачны: понятная формула, отсутствие ложной визуализации до настройки.
- История целей — ключ к долгосрочной эффективности: цель → практика → обратная связь → завершение → новая цель, без смешения данных.

В текущем виде маршрут цельный, понятный и эффективный: он помогает не просто «завести цель», а пройти её до результата, поддерживая регулярность и обучающий эффект.



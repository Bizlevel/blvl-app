1. Авторизация google на ios - не работает
2. генерация промокода для друга - не работает. Также постоянно всплывает уведомление об ошибке генерации промокода (даже если на другом экране находишься)
3. Напрягает многократная подгрузка главного экрана - из-за этого теряются окошки с уведомлениями(не успеваешь прочитать - исчезают за мгновение например - начисление ГП за пройденный уровень)
4. клавиатура в уровне 0 - проблемная
5. Если не пройден 0 уровень - нам предлагают открыть первый уровень за деньги. Если не заполнена первая цель - нам предлагают открыть второй уровень за деньги. И мы можем его купить!!!
6. клавиатура в обсудить с Лео из башни - починилась. Но если стартуем болтоdню - из башни вываливаемся на главный экран
7. клавиатура в "сохранить цель" - проблемная, сработало после таба на главном экране.
8. Повторить прохождение 1 уровня - не дает
9. Артефакты: неверный подсчет, например: на главной 5 инструментов при открытых 4 артефактах. По прохождении всей башни: артефактов 10, стартовый экран показывает 11 инструментов.
10. Чекпоинты - кнопка завершить не работает(ничего не делает)

---

## План и чек‑лист по багам (мобильные приоритет)

### Общие правила работы
- Работаем по одному багу: **воспроизведение → локализация → фикc → тест → регрессия**.
- Фиксируем артефакты: видео/скрин, Sentry/лог, точный сценарий и состояние пользователя.
- Где возможно — сначала проверяем серверные настройки (Supabase) и флаги в коде.

---

### 1) Авторизация Google на iOS не работает
**Цель:** восстановить sign‑in на iOS без регрессий Android.
**План:**
1) Воспроизвести на физическом iOS устройстве, записать ошибку/лог.
2) Проверить `Info.plist` (URL schemes, clientId) и `GoogleService-Info.plist`.
3) Проверить `AuthService.signInWithGoogle` и путь `GoogleSignIn.instance.initialize`.
4) Сверить версии `google_sign_in` и `google_sign_in_ios` (патч применён?).
5) Проверить Sentry/console лог на `ASWebAuthenticationSession` возврат.
**Чек‑лист готовности:**
- Логин на iOS проходит, возвращается Supabase session.
- Logout/login повторяются без крашей.
- Нет регрессий Android (smoke‑тест).

---

### 2) Генерация промокода/реферала не работает + постоянный алерт об ошибке
**Цель:** исправить генерацию кода и убрать «фантомные» ошибки в UI.
**План:**
1) Воспроизвести: открыть профиль → блок рефералок → нажать генерацию.
2) Проверить Edge/RPC: `get_referral_code`, `apply_referral_code`, `redeem_promo_code`.
3) Проверить хранение/кеш в `ReferralStorage`, повторные запросы.
4) Найти источник «постоянного уведомления» (banner/snackbar/NotificationCenter).
5) Проверить обработку ошибок: не показывать повторно, если пользователь уже ушёл с экрана.
**Чек‑лист готовности:**
- Кнопка генерирует код и показывает его.
- Ошибка не всплывает вне экрана.
- Повторные открытия экрана не триггерят алерт без действия.

---

### 3) Многократная подгрузка главного экрана → исчезают уведомления
**Цель:** стабилизировать обновление Home и не терять баннеры.
**План:**
1) Воспроизвести: открыть Main Street, наблюдать перезагрузки.
2) Проверить провайдеры Home (invalidate/refresh циклы).
3) Проверить `NotificationCenter` и его журнал (не перерисовывается ли).
4) Проверить условия авто‑рефреша (post‑frame, listeners, app lifecycle).
5) Добавить/уточнить защиту от повторных refresh подряд.
**Чек‑лист готовности:**
- Home не перезагружается каскадно.
- Баннеры держатся достаточно для прочтения.
- Нет блокировки UI.

---

### 4) Клавиатура на уровне 0 — проблемная
**Цель:** корректная работа ввода в Level 0.
**План:**
1) Воспроизвести на iOS/Android: поля профиля в Level 0.
2) Проверить, используется ли `showBizLevelInputBottomSheet` или стандартный `TextField`.
3) Проверить `resizeToAvoidBottomInset`, `SafeArea`, `viewInsets`.
4) Проверить focus/scroll: перенос фокуса, `onTapOutside`, submit.
5) Зафиксировать единое поведение с другими экранами ввода.
**Чек‑лист готовности:**
- Поля не перекрываются клавиатурой.
- Нет срывов фокуса при вводе.
- Dismiss/submit работает одинаково на iOS/Android.

---

### 5) Неправильный гейтинг этажей/уровней (можно купить при незавершённых условиях)
**Цель:** запретить покупку этажей до выполнения prerequisites.
**План:**
1) Воспроизвести: не пройти L0 → попытаться открыть этаж 1; не заполнить цель → попытаться открыть этаж 2.
2) Проверить логику `towerNodesProvider` и gating для `floor_access`.
3) Проверить условие «уровень завершён» vs «цель заполнена».
4) Проверить UI модал покупки: должен блокироваться при незавершённом prerequisite.
5) Проверить серверный guard (RPC `gp_floor_unlock`?).
**Чек‑лист готовности:**
- Нельзя купить этаж, если не выполнен prerequisite.
- UI показывает корректную причину блокировки.
- Серверная функция также отказывает при неверных условиях.

---

### 6) Чат из Башни: клавиатура ок, но при старте диалога выбрасывает на Главный экран
**Цель:** сохранить маршрут диалога из «Башни».
**План:**
1) Воспроизвести: Башня → «Обсудить с Лео» → отправка сообщения.
2) Проверить `GoRouter` и `Navigator` (rootNavigator / pop).
3) Проверить обработку `onPop`/`PopScope` и post‑frame.
4) Сравнить путь открытия с другими точками (например, из Home/Chat).
5) Исправить конфликт `Navigator`/`GoRouter` если есть.
**Чек‑лист готовности:**
- После отправки сообщения остаёмся в диалоге.
- Back ведёт назад в Башню, а не на Главный.

---

### 7) Клавиатура в «Сохранить цель» — проблемная
**Цель:** стабилизировать ввод в модалке цели.
**План:**
1) Воспроизвести: открыть «Сохранить цель» на Goal/Checkpoint.
2) Проверить, что используется `showBizLevelInputBottomSheet`.
3) Проверить отступ под клавиатуру и `SafeArea`.
4) Проверить focus/submit/close.
5) Сравнить с рабочей формой (например, «Информация обо мне»).
**Чек‑лист готовности:**
- Клавиатура не перекрывает CTA/поле.
- Ввод стабилен, без прыжков.

---

### 8) Повторить прохождение 1 уровня — не даёт
**Цель:** позволить повторный старт уровня 1 (если это допустимо по UX).
**План:**
1) Уточнить ожидаемое поведение (повторное прохождение доступно всегда?).
2) Проверить логику блокировки в `LevelsRepository/LevelsProvider`.
3) Проверить UI‑кнопку «Повторить» (доступность, условия).
4) Проверить сохранение прогресса и сброс локального прогресса уроков.
5) Добавить/исправить сценарий повторного прохождения.
**Чек‑лист готовности:**
- Кнопка активна при выполненных условиях.
- Уровень запускается заново без ошибок.
- Прогресс/квиз корректно сбрасывается.

---

### 9) Артефакты: неверный подсчёт
**Цель:** синхронизировать число артефактов на Главной и в списке.
**План:**
1) Воспроизвести: сравнить счётчик Home vs экран артефактов.
2) Проверить источник данных для Home‑счётчика.
3) Проверить фильтры: только завершённые уровни? только уникальные?
4) Проверить кеш/репозиторий артефактов.
5) Добавить/исправить дедуп и вычисление count.
**Чек‑лист готовности:**
- Счётчик соответствует фактическому числу артефактов.
- После прохождения всей башни цифры совпадают.

---

### 10) Чекпоинты — кнопка «Завершить» не работает
**Цель:** восстановить действие завершения чекпоинтов L1/L4/L7.
**План:**
1) Воспроизвести: L1/L4/L7 → нажать «Завершить».
2) Проверить onTap/handler в экранах чекпоинтов.
3) Проверить условия завершения (`user_goal` поля заполнены).
4) Проверить вызовы `SupabaseService.completeLevel` / updates цели.
5) Проверить навигацию после завершения.
**Чек‑лист готовности:**
- Кнопка активна и выполняет действие.
- Статус чекпоинта обновляется в Башне.
- Навигация корректна (возврат на Башню/Цель).